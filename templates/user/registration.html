{% extends "base.html" %}

{% block title %}Registration - GIIR Conference 2024{% endblock %}

{% block head %}
<!-- Add Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

<!-- Initialize Firebase -->
<script>
const firebaseConfig = {
    apiKey: "{{ firebase_config.apiKey }}",
    authDomain: "{{ firebase_config.authDomain }}",
    databaseURL: "{{ firebase_config.databaseURL }}",
    projectId: "{{ firebase_config.projectId }}",
    messagingSenderId: "{{ firebase_config.messagingSenderId }}",
    appId: "{{ firebase_config.appId }}"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
</script>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Conference Registration</h1>
    <p>Select a conference and complete your registration</p>
</div>

<div class="content-section">
    <!-- Registration Progress -->
    <div class="registration-progress">
        <div class="progress-bar">
            <div class="progress" style="width: 25%"></div>
        </div>
        <div class="progress-steps">
            <div class="step active" data-step="1">
                <div class="step-number">1</div>
                <div class="step-content">
                    <h3>Select Conference</h3>
                    <p>Choose which conference to attend</p>
                </div>
            </div>
            <div class="step" data-step="2">
                <div class="step-number">2</div>
                <div class="step-content">
                    <h3>Package Selection</h3>
                    <p>Choose your registration type</p>
                </div>
            </div>
            <div class="step" data-step="3">
                <div class="step-number">3</div>
                <div class="step-content">
                    <h3>Additional Items</h3>
                    <p>Select optional extras</p>
                </div>
            </div>
            <div class="step" data-step="4">
                <div class="step-number">4</div>
                <div class="step-content">
                    <h3>Review & Payment</h3>
                    <p>Confirm and proceed</p>
                </div>
            </div>
        </div>
    </div>

    <form id="registration-form" method="POST" action="{{ url_for('registration') }}" enctype="multipart/form-data">
        <!-- Step 1: Conference Selection -->
        <div class="registration-step active" id="step1">
            <div class="step-header">
                <h2>Step 1: Select Conference</h2>
                <p>Choose which conference you'd like to register for</p>
            </div>

            <div class="conference-selection">
                <!-- DEBUG: conferences variable = {{ conferences|length if conferences else 'None' }} -->
                {% if conferences %}
                    <div class="conferences-grid">
                        {% for conf_id, conf in conferences.items() %}
                        <div class="conference-card">
                            <input type="radio" name="conference_id" id="conf_{{ conf_id }}" value="{{ conf_id }}" required>
                            <label for="conf_{{ conf_id }}">
                                <div class="conf-header">
                                    <div class="conf-icon">
                                        <i class="fas fa-calendar-alt"></i>
                                    </div>
                                    <div class="conf-status status-{{ conf.get('basic_info', {}).get('status', 'active') }}">
                                        {{ conf.get('basic_info', {}).get('status', 'active')|title }}
                                    </div>
                                </div>
                                <h3 class="conf-name">{{ conf.get('basic_info', {}).get('name', 'Conference') }}</h3>
                                <div class="conf-details">
                                    {% if conf.get('basic_info', {}).get('year') %}
                                    <div class="conf-detail">
                                        <i class="fas fa-calendar"></i>
                                        <span>{{ conf.get('basic_info', {}).get('year') }}</span>
                                    </div>
                                    {% endif %}
                                    {% if conf.get('conference_code') %}
                                    <div class="conf-detail">
                                        <i class="fas fa-qrcode"></i>
                                        <span>{{ conf.get('conference_code') }}</span>
                                    </div>
                                    {% endif %}
                                    {% if conf.get('basic_info', {}).get('start_date') and conf.get('basic_info', {}).get('end_date') %}
                                    <div class="conf-detail">
                                        <i class="fas fa-clock"></i>
                                        <span>{{ conf.get('basic_info', {}).get('start_date')[:10] }} - {{ conf.get('basic_info', {}).get('end_date')[:10] }}</span>
                                    </div>
                                    {% endif %}
                                    {% if conf.get('basic_info', {}).get('location') %}
                                    <div class="conf-detail">
                                        <i class="fas fa-map-marker-alt"></i>
                                        <span>{{ conf.get('basic_info', {}).get('location') }}</span>
                                    </div>
                                    {% endif %}
                                    {% if conf.get('basic_info', {}).get('event_type') %}
                                    <div class="conf-detail">
                                        <i class="fas fa-{{ 'video' if conf.get('basic_info', {}).get('event_type') == 'virtual' else 'users' if conf.get('basic_info', {}).get('event_type') == 'hybrid' else 'building' }}"></i>
                                        <span>{{ conf.get('basic_info', {}).get('event_type')|replace('_', ' ')|title }}</span>
                                    </div>
                                    {% endif %}
                                </div>
                                {% if conf.get('basic_info', {}).get('description') %}
                                <p class="conf-description">{{ conf.get('basic_info', {}).get('description')[:150] }}...</p>
                                {% endif %}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="empty-state no-conferences">
                        <i class="fas fa-calendar-times fa-3x"></i>
                        <h3>No Conferences Available</h3>
                        <p>There are currently no conferences open for registration.</p>
                        <p class="empty-state-hint">
                            <i class="fas fa-info-circle"></i> 
                            Conferences are shown based on their status (Active/Upcoming) and registration availability.
                        </p>
                        <a href="{{ url_for('conference_discover') }}" class="btn btn-primary" style="margin-top: 1rem;">
                            <i class="fas fa-search"></i> Discover All Conferences
                        </a>
                    </div>
                {% endif %}
            </div>

            <div class="step-actions">
                {% if conferences %}
                <button type="button" class="btn btn-primary btn-next" onclick="nextStep()">
                    Continue to Package Selection <i class="fas fa-arrow-right"></i>
                </button>
                {% endif %}
            </div>
        </div>

        <!-- Step 2: Package Selection -->
        <div class="registration-step" id="step2">
            <div class="step-header">
                <h2>Step 2: Package Selection</h2>
                <p>Select your registration period and type</p>
            </div>

            <!-- Registration Period Selection -->
            <div class="period-selection">
                <h3>Select Registration Period</h3>
                <div class="period-options">
                    {% if fees.early_bird and fees.early_bird.enabled %}
                    <div class="period-card {% if fees.early_bird.seats.remaining <= 0 %}disabled{% endif %}">
                        <input type="radio" name="registration_period" id="early_bird" value="early_bird" 
                               {% if fees.early_bird.seats.remaining <= 0 %}disabled{% endif %}>
                        <label for="early_bird">
                            <div class="period-header">
                                <i class="fas fa-star"></i>
                                <h4>Early Bird Registration</h4>
                                {% if fees.early_bird.deadline %}
                                <span class="deadline">Until {{ fees.early_bird.deadline }}</span>
                                {% endif %}
                            </div>
                            {% if fees.early_bird.seats.show_remaining %}
                            <div class="seats-remaining">
                                <span class="count">{{ fees.early_bird.seats.remaining }}</span> seats remaining
                            </div>
                            {% endif %}
                            <div class="benefits-list">
                                {% if fees.early_bird.benefits %}
                                <h5>Benefits:</h5>
                                <ul>
                                    {% for benefit in fees.early_bird.benefits %}
                                    <li>{{ benefit }}</li>
                                    {% endfor %}
                                </ul>
                                {% endif %}
                            </div>
                        </label>
                    </div>
                    {% endif %}

                    {% if fees.early %}
                    <div class="period-card">
                        <input type="radio" name="registration_period" id="early" value="early">
                        <label for="early">
                            <div class="period-header">
                                <i class="fas fa-calendar-check"></i>
                                <h4>Early Registration</h4>
                                {% if fees.early.deadline %}
                                <span class="deadline">Until {{ fees.early.deadline }}</span>
                                {% endif %}
                            </div>
                            <div class="benefits-list">
                                {% if fees.early.benefits %}
                                <h5>Benefits:</h5>
                                <ul>
                                    {% for benefit in fees.early.benefits %}
                                    <li>{{ benefit }}</li>
                                    {% endfor %}
                                </ul>
                                {% endif %}
                            </div>
                        </label>
                    </div>
                    {% endif %}

                    {% if fees.regular %}
                    <div class="period-card">
                        <input type="radio" name="registration_period" id="regular" value="regular">
                        <label for="regular">
                            <div class="period-header">
                                <i class="fas fa-calendar-alt"></i>
                                <h4>Regular Registration</h4>
                                {% if fees.regular.deadline %}
                                <span class="deadline">Until {{ fees.regular.deadline }}</span>
                                {% endif %}
                            </div>
                            <div class="benefits-list">
                                {% if fees.regular.benefits %}
                                <h5>Benefits:</h5>
                                <ul>
                                    {% for benefit in fees.regular.benefits %}
                                    <li>{{ benefit }}</li>
                                    {% endfor %}
                                </ul>
                                {% endif %}
                            </div>
                        </label>
                    </div>
                    {% endif %}

                    {% if fees.late %}
                    <div class="period-card">
                        <input type="radio" name="registration_period" id="late" value="late">
                        <label for="late">
                            <div class="period-header">
                                <i class="fas fa-calendar-times"></i>
                                <h4>Late Registration</h4>
                                {% if fees.late.deadline %}
                                <span class="deadline">Until {{ fees.late.deadline }}</span>
                                {% endif %}
                            </div>
                            <div class="benefits-list">
                                {% if fees.late.benefits %}
                                <h5>Benefits:</h5>
                                <ul>
                                    {% for benefit in fees.late.benefits %}
                                    <li>{{ benefit }}</li>
                                    {% endfor %}
                                </ul>
                                {% endif %}
                            </div>
                        </label>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Registration Type Selection -->
            <div class="type-selection">
                <h3>Select Registration Type</h3>
                <div class="type-options">
                    <div class="type-card" id="student_author_card">
                        <input type="radio" name="registration_type" id="student_author" value="student_author">
                        <label for="student_author">
                            <div class="type-header">
                                <i class="fas fa-user-graduate"></i>
                                <h4>Student Author</h4>
                            </div>
                            <div class="type-price">
                                <span class="amount"></span>
                            </div>
                        </label>
                    </div>

                    <div class="type-card" id="regular_author_card">
                        <input type="radio" name="registration_type" id="regular_author" value="regular_author">
                        <label for="regular_author">
                            <div class="type-header">
                                <i class="fas fa-user"></i>
                                <h4>Regular Author</h4>
                            </div>
                            <div class="type-price">
                                <span class="amount"></span>
                            </div>
                        </label>
                    </div>

                    <div class="type-card" id="physical_delegate_card">
                        <input type="radio" name="registration_type" id="physical_delegate" value="physical_delegate">
                        <label for="physical_delegate">
                            <div class="type-header">
                                <i class="fas fa-user-friends"></i>
                                <h4>Physical Delegate</h4>
                            </div>
                            <div class="type-price">
                                <span class="amount"></span>
                            </div>
                        </label>
                    </div>

                    <div class="type-card" id="virtual_delegate_card">
                        <input type="radio" name="registration_type" id="virtual_delegate" value="virtual_delegate">
                        <label for="virtual_delegate">
                            <div class="type-header">
                                <i class="fas fa-laptop"></i>
                                <h4>Virtual Delegate</h4>
                            </div>
                            <div class="type-price">
                                <span class="amount"></span>
                            </div>
                        </label>
                    </div>

                    <div class="type-card" id="listener_card">
                        <input type="radio" name="registration_type" id="listener" value="listener">
                        <label for="listener">
                            <div class="type-header">
                                <i class="fas fa-headphones"></i>
                                <h4>Listener</h4>
                            </div>
                            <div class="type-price">
                                <span class="amount"></span>
                            </div>
                        </label>
                    </div>
                </div>
            </div>

            <div class="step-actions">
                <button type="button" class="btn btn-primary next-step" disabled>Continue to Additional Items</button>
            </div>
        </div>

        <!-- Step 3: Additional Items -->
        <div class="registration-step" id="step3" style="display: none;">
            <div class="step-header">
                <h2>Step 3: Additional Items</h2>
                <p>Select any additional items you would like to add</p>
            </div>

            <div class="additional-items">
                {% if fees.additional_items %}
                    {% if fees.additional_items.extra_paper and fees.additional_items.extra_paper.enabled %}
                    <div class="item-card" id="extra_paper_card">
                        <div class="item-header">
                            <i class="fas fa-file-alt"></i>
                            <h4>Extra Paper</h4>
                        </div>
                        <div class="item-description">
                            {{ fees.additional_items.extra_paper.description }}
                        </div>
                        <div class="item-price">
                            <span class="amount"></span>
                        </div>
                        <div class="item-select">
                            <label class="switch">
                                <input type="checkbox" id="extra_paper" name="extra_paper">
                                <span class="slider round"></span>
                            </label>
                        </div>
                    </div>
                    {% endif %}

                    {% if fees.additional_items.workshop and fees.additional_items.workshop.enabled %}
                    <div class="item-card" id="workshop_card">
                        <div class="item-header">
                            <i class="fas fa-chalkboard-teacher"></i>
                            <h4>Workshop</h4>
                        </div>
                        <div class="item-description">
                            {{ fees.additional_items.workshop.description }}
                        </div>
                        <div class="item-price">
                            <span class="amount"></span>
                        </div>
                        <div class="item-select">
                            <label class="switch">
                                <input type="checkbox" id="workshop" name="workshop">
                                <span class="slider round"></span>
                            </label>
                        </div>
                    </div>
                    {% endif %}

                    {% if fees.additional_items.banquet and fees.additional_items.banquet.enabled %}
                    <div class="item-card" id="banquet_card">
                        <div class="item-header">
                            <i class="fas fa-glass-cheers"></i>
                            <h4>Banquet</h4>
                        </div>
                        <div class="item-description">
                            {{ fees.additional_items.banquet.description }}
                        </div>
                        <div class="item-price">
                            <span class="amount"></span>
                        </div>
                        <div class="item-select">
                            <label class="switch">
                                <input type="checkbox" id="banquet" name="banquet">
                                <span class="slider round"></span>
                            </label>
                        </div>
                    </div>
                    {% endif %}
                {% endif %}
            </div>

            <div class="step-actions">
                <button type="button" class="btn btn-secondary prev-step">Back to Package Selection</button>
                <button type="button" class="btn btn-primary next-step">Continue to Payment</button>
            </div>
        </div>

        <!-- Step 4: Review & Payment -->
        <div class="registration-step" id="step4" style="display: none;">
            <div class="step-header">
                <h2>Step 4: Review & Payment</h2>
                <p>Review your selections and complete payment</p>
            </div>

            <div class="review-section">
                <h3>Registration Summary</h3>
                <div class="summary-details">
                    <div class="summary-item">
                        <span class="label">Registration Period:</span>
                        <span class="value period-name"></span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Registration Type:</span>
                        <span class="value type-name"></span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Additional Items:</span>
                        <div class="value additional-items-list"></div>
                    </div>
                    <div class="summary-item total-amount">
                        <span class="label">Total Amount:</span>
                        <span class="value amount"></span>
                    </div>
                </div>
            </div>

            <div class="payment-section">
                <h3>Payment Information</h3>
                <div class="payment-instructions">
                    <div class="payment-notice">
                        <div class="notice-icon">
                            <i class="fas fa-credit-card"></i>
                        </div>
                        <div class="notice-content">
                            <h4>Secure Online Payment</h4>
                            <p>Your payment will be processed securely through iKhokha's payment gateway. 
                            You can pay using your credit card, debit card, or EFT.</p>
                            <ul class="payment-features">
                                <li><i class="fas fa-shield-alt"></i> SSL Encrypted & Secure</li>
                                <li><i class="fas fa-credit-card"></i> All Major Cards Accepted</li>
                                <li><i class="fas fa-university"></i> Instant EFT Available</li>
                                <li><i class="fas fa-receipt"></i> Instant Payment Confirmation</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="payment-summary">
                        <div class="summary-row">
                            <span class="summary-label">Registration Fee:</span>
                            <span class="summary-value" id="base-fee-amount">R0.00</span>
                        </div>
                        <div class="summary-row" id="additional-fees" style="display: none;">
                            <span class="summary-label">Additional Items:</span>
                            <span class="summary-value" id="additional-fee-amount">R0.00</span>
                        </div>
                        <div class="summary-row total-row">
                            <span class="summary-label">Total Amount:</span>
                            <span class="summary-value total-amount" id="final-total">R0.00</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hidden Fields -->
            <input type="hidden" name="selected_period" id="selected_period">
            <input type="hidden" name="selected_type" id="selected_type">
            <input type="hidden" name="total_amount" id="total_amount">
            <input type="hidden" name="extra_paper" id="has_extra_paper">
            <input type="hidden" name="workshop" id="has_workshop">
            <input type="hidden" name="banquet" id="has_banquet">

            <div class="step-actions">
                <button type="button" class="btn btn-secondary prev-step">Back to Additional Items</button>
                <button type="button" class="btn btn-primary btn-payment" id="proceed-to-payment" onclick="proceedToPayment()">
                    <i class="fas fa-credit-card"></i>
                    Proceed to Payment
                </button>
            </div>
        </div>
    </form>
</div>

<style>
/* Conference Selection Styles */
.conference-selection {
    margin: 2rem 0;
}

.conferences-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1.5rem;
}

.conference-card {
    position: relative;
}

.conference-card input[type="radio"] {
    position: absolute;
    opacity: 0;
}

.conference-card label {
    display: block;
    background: white;
    border: 3px solid #e5e7eb;
    border-radius: 16px;
    padding: 1.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
    height: 100%;
}

.conference-card input[type="radio"]:checked + label {
    border-color: var(--primary-color, #667eea);
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
    box-shadow: 0 8px 16px rgba(102, 126, 234, 0.2);
    transform: translateY(-4px);
}

.conference-card label:hover {
    border-color: var(--primary-color, #667eea);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.conf-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.conf-icon {
    width: 50px;
    height: 50px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
}

.conf-status {
    padding: 0.4rem 0.9rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    display: flex;
    align-items: center;
    gap: 0.3rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.conf-status::before {
    content: '●';
    font-size: 0.6rem;
}

.status-active {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
}

.status-active::before {
    animation: pulse 2s ease-in-out infinite;
}

.status-upcoming {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
}

.status-past {
    background: #6b7280;
    color: white;
    opacity: 0.7;
}

.status-draft {
    background: #fbbf24;
    color: #78350f;
}

.status-archived {
    background: #e5e7eb;
    color: #374151;
}

@keyframes pulse {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: 0.5;
    }
}

.conf-name {
    font-size: 1.4rem;
    font-weight: 700;
    color: #1f2937;
    margin: 0.75rem 0;
}

.conf-details {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin: 1rem 0;
}

.conf-detail {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.9rem;
    color: #4b5563;
}

.conf-detail i {
    width: 30px;
    height: 30px;
    background: #f3f4f6;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #667eea;
    flex-shrink: 0;
}

.conf-description {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #e5e7eb;
    font-size: 0.9rem;
    color: #6b7280;
    line-height: 1.6;
}

.empty-state,
.no-conferences {
    text-align: center;
    padding: 4rem 2rem;
    background: linear-gradient(135deg, #f9fafb 0%, #e5e7eb 100%);
    border-radius: 16px;
    border: 2px dashed #d1d5db;
}

.empty-state i,
.no-conferences i {
    color: #cbd5e0;
    margin-bottom: 1.5rem;
    animation: fadeInScale 0.5s ease-out;
}

.empty-state h3,
.no-conferences h3 {
    font-size: 1.5rem;
    color: #374151;
    margin-bottom: 0.75rem;
}

.empty-state p,
.no-conferences p {
    color: #6b7280;
    margin-bottom: 0.5rem;
}

.empty-state-hint {
    background: white;
    padding: 0.75rem 1rem;
    border-radius: 8px;
    display: inline-block;
    margin-top: 1rem;
    border-left: 4px solid #3b82f6;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.empty-state-hint i {
    color: #3b82f6;
    margin: 0;
}

.empty-state a,
.no-conferences a {
    color: var(--primary-color, #667eea);
    text-decoration: none;
}

@keyframes fadeInScale {
    from {
        opacity: 0;
        transform: scale(0.8);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

/* Progress Bar Styles */
.registration-progress {
    margin-bottom: 2rem;
}

.progress-bar {
    height: 4px;
    background: var(--background-color);
    border-radius: 2px;
    margin-bottom: 1rem;
    position: relative;
}

.progress-bar .progress {
    position: absolute;
    height: 100%;
    background: var(--primary-color);
    border-radius: 2px;
    transition: width 0.3s ease;
}

.progress-steps {
    display: flex;
    justify-content: space-between;
    gap: 1rem;
}

.step {
    flex: 1;
    text-align: center;
    position: relative;
    opacity: 0.5;
    transition: opacity 0.3s ease;
}

.step.active {
    opacity: 1;
}

.step-number {
    width: 32px;
    height: 32px;
    background: var(--background-color);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 0.5rem;
    font-weight: bold;
    color: var(--text-color);
}

.step.active .step-number {
    background: var(--primary-color);
    color: white;
}

.step-content h3 {
    font-size: 1rem;
    margin: 0;
}

.step-content p {
    font-size: 0.9rem;
    margin: 0;
    color: var(--text-secondary);
}

/* Step Content Styles */
.registration-step {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.step-header {
    margin-bottom: 2rem;
    text-align: center;
}

.step-header h2 {
    margin: 0;
    color: var(--primary-color);
}

.step-header p {
    margin: 0.5rem 0 0;
    color: var(--text-secondary);
}

/* Registration Cards Styling */
.period-options, .type-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    margin: 1.5rem 0;
}

.period-card, .type-card {
    position: relative;
    border: 2px solid #e1e8ed;
    border-radius: 16px;
    padding: 1.5rem;
    transition: all 0.3s ease;
    background: #ffffff;
    overflow: hidden;
}

.period-card:hover, .type-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
}

.period-card input[type="radio"], .type-card input[type="radio"] {
    position: absolute;
    opacity: 0;
}

.period-card input[type="radio"]:checked + label, 
.type-card input[type="radio"]:checked + label {
    border-color: var(--primary-color);
}

.period-card input[type="radio"]:checked + label::before, 
.type-card input[type="radio"]:checked + label::before {
    content: '✓';
    position: absolute;
    top: -1px;
    right: -1px;
    background: var(--primary-color);
    color: white;
    width: 32px;
    height: 32px;
    border-radius: 0 16px 0 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
}

.period-header, .type-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #e1e8ed;
}

.period-header i, .type-header i {
    font-size: 1.5rem;
    color: var(--primary-color);
}

.period-header h4, .type-header h4 {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: #2c3e50;
}

.deadline {
    display: inline-block;
    margin-top: 0.5rem;
    padding: 0.25rem 0.75rem;
    background: #f8f9fa;
    border-radius: 12px;
    font-size: 0.875rem;
    color: #666;
}

.seats-remaining {
    margin: 1rem 0;
    padding: 0.5rem;
    background: #f8f9fa;
    border-radius: 8px;
    text-align: center;
    font-size: 0.9rem;
    color: #666;
}

.seats-remaining .count {
    font-weight: 600;
    color: var(--primary-color);
}

.benefits-list {
    margin-top: 1rem;
}

.benefits-list h5 {
    font-size: 1rem;
    margin-bottom: 0.75rem;
    color: #2c3e50;
}

.benefits-list ul {
    list-style: none;
    padding: 0;
    margin: 0;
}

.benefits-list li {
    position: relative;
    padding-left: 1.5rem;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
    color: #666;
}

.benefits-list li::before {
    content: '•';
    position: absolute;
    left: 0.5rem;
    color: var(--primary-color);
}

.type-price {
    margin-top: 1rem;
    text-align: center;
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--primary-color);
}

.period-card.disabled {
    opacity: 0.7;
    cursor: not-allowed;
    background: #f8f9fa;
}

.period-card.disabled:hover {
    transform: none;
    box-shadow: none;
}

/* Additional Items Styles */
.additional-items {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-top: 1rem;
}

.item-card {
    background: white;
    border: 1px solid var(--background-color);
    border-radius: 12px;
    padding: 1.5rem;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.item-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

/* Add selected state styles */
.item-card.selected {
    background: var(--primary-color);
    border-color: var(--primary-color);
}

.item-card.selected .item-header h4,
.item-card.selected .item-content p,
.item-card.selected .checkbox-label span {
    color: white;
}

.item-card.selected .item-header i {
    color: white;
    background: rgba(255, 255, 255, 0.2);
}

.item-card.selected .item-price {
    color: white;
}

.item-card.selected .item-price::before {
    color: rgba(255, 255, 255, 0.8);
}

.item-card.selected .checkbox-label input[type="checkbox"] {
    border-color: white;
    background-color: transparent;
}

.item-card.selected .checkbox-label input[type="checkbox"]:checked {
    background-color: white;
}

.item-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1.25rem;
}

.item-header i {
    font-size: 1.5rem;
    color: var(--primary-color);
    background: var(--background-color);
    padding: 0.75rem;
    border-radius: 8px;
}

.item-header h4 {
    margin: 0;
    font-size: 1.2rem;
    color: var(--text-color);
}

.item-content {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.item-content p {
    margin: 0;
    color: var(--text-secondary);
    font-size: 0.95rem;
    line-height: 1.5;
}

.item-price {
    font-size: 1.3rem;
    font-weight: 600;
    color: var(--primary-color);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.item-price::before {
    content: 'R';
    font-size: 1rem;
    color: var(--text-secondary);
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    cursor: pointer;
    padding: 0.5rem 0;
    border-top: 1px solid var(--background-color);
    margin-top: 0.5rem;
}

.checkbox-label input[type="checkbox"] {
    width: 22px;
    height: 22px;
    border: 2px solid var(--background-color);
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.checkbox-label input[type="checkbox"]:checked {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
}

.checkbox-label span {
    font-weight: 500;
    color: var(--text-color);
}

/* Review Summary Styles */
.review-section {
    background: var(--background-color);
    border-radius: 8px;
    padding: 1.5rem;
}

.summary-details {
    margin-bottom: 2rem;
}

.summary-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
}

.summary-item:last-child {
    margin-bottom: 0;
}

.summary-label {
    color: var(--text-secondary);
}

.summary-value {
    font-weight: 500;
}

.total-amount {
    margin-top: 2rem;
    padding-top: 1rem;
    border-top: 2px solid rgba(0,0,0,0.1);
}

.total {
    font-size: 1.2rem;
    font-weight: bold;
}

.total .summary-value {
    color: var(--primary-color);
}

/* Step Actions */
.step-actions {
    margin-top: 2rem;
    display: flex;
    justify-content: space-between;
    gap: 1rem;
}

.step-actions button {
    min-width: 200px;
}

/* Payment Section Styles */
.payment-section {
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 2px solid var(--background-color);
}

.payment-instructions {
    display: grid;
    gap: 2rem;
}

.payment-notice {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    border: 2px solid #e2e8f0;
    border-radius: 16px;
    padding: 2rem;
    display: flex;
    align-items: flex-start;
    gap: 1.5rem;
}

.notice-icon {
    background: var(--primary-color);
    color: white;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.notice-icon i {
    font-size: 1.5rem;
}

.notice-content h4 {
    margin: 0 0 0.75rem 0;
    color: var(--text-color);
    font-size: 1.25rem;
    font-weight: 600;
}

.notice-content p {
    margin: 0 0 1rem 0;
    color: var(--text-secondary);
    line-height: 1.6;
}

.payment-features {
    list-style: none;
    padding: 0;
    margin: 0;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 0.75rem;
}

.payment-features li {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.payment-features li i {
    color: #10b981;
    font-size: 1rem;
    width: 16px;
}

.payment-summary {
    background: white;
    border: 2px solid #f1f5f9;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.summary-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid #f8fafc;
}

.summary-row:last-child {
    border-bottom: none;
}

.summary-row.total-row {
    border-top: 2px solid #e2e8f0;
    margin-top: 0.5rem;
    padding-top: 1rem;
    font-weight: 600;
    font-size: 1.1rem;
}

.summary-label {
    color: var(--text-secondary);
    font-weight: 500;
}

.summary-value {
    color: var(--text-color);
    font-weight: 600;
}

.total-row .summary-value {
    color: var(--primary-color);
    font-size: 1.25rem;
}

.btn-payment {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    border: none;
    color: white;
    padding: 1rem 2rem;
    font-size: 1.1rem;
    font-weight: 600;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    transition: all 0.3s ease;
    min-width: 200px;
}

.btn-payment:hover {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

.btn-payment:disabled {
    background: #9ca3af;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

.btn-payment i {
    font-size: 1.2rem;
}

.form-group {
    display: grid;
    gap: 0.5rem;
}

.form-group label {
    font-weight: 500;
}

.form-control {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid var(--background-color);
    border-radius: 4px;
    font-size: 1rem;
    transition: border-color 0.3s ease;
}

.form-control:focus {
    outline: none;
    border-color: var(--primary-color);
}

.form-text {
    font-size: 0.9rem;
    color: var(--text-secondary);
}

.invalid-feedback {
    display: none;
    color: var(--danger-color);
    font-size: 0.875rem;
    margin-top: 0.25rem;
}

.invalid-feedback.show {
    display: block;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .registration-step {
        padding: 1.5rem;
    }
    
    .period-options, .type-options {
        grid-template-columns: 1fr;
    }
    
    .period-card, .type-card {
        padding: 1.25rem;
    }
    
    .period-header h4, .type-header h4 {
        font-size: 1.1rem;
    }
}
</style>

<script>
var selectedPeriod = null;
var selectedType = null;
var totalAmount = 0;
var fees = JSON.parse('{{ fees|tojson|safe }}');

function updatePrices() {
    if (!selectedPeriod || !selectedType) return;
    
    var periodFees = fees[selectedPeriod].fees;
    if (!periodFees) return;

    // Update registration type prices
    document.querySelectorAll('.type-card').forEach(card => {
        const input = card.querySelector('input[name="registration_type"]');
        const priceElement = card.querySelector('.type-price .amount');
        const type = input.value;
        
        if (periodFees[type] !== undefined) {
            const price = periodFees[type];
            const symbol = fees.currency.symbol || 'R';
            priceElement.textContent = `${symbol} ${price.toFixed(2)}`;
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });

    // Update additional items prices and availability
    if (fees.additional_items) {
        Object.entries(fees.additional_items).forEach(([item, data]) => {
            const itemCard = document.querySelector(`#${item}_card`);
            if (!itemCard) return;

            const priceElement = itemCard.querySelector('.item-price .amount');
            const checkbox = document.getElementById(item);
            
            if (data.enabled) {
                const symbol = fees.currency.symbol || 'R';
                priceElement.textContent = `${symbol} ${data.fee.toFixed(2)}`;
                itemCard.style.display = 'block';
                
                // Handle virtual delegate restrictions
                if (selectedType === 'virtual_delegate' && !data.virtual_eligible) {
                    checkbox.checked = false;
                    checkbox.disabled = true;
                    itemCard.classList.add('disabled');
                } else {
                    checkbox.disabled = false;
                    itemCard.classList.remove('disabled');
                }
            } else {
                itemCard.style.display = 'none';
            }
        });
    }

    calculateTotal();
    updateSummary();
}

function calculateTotal() {
    if (!selectedPeriod || !selectedType) {
        totalAmount = 0;
        return;
    }

    const periodFees = fees[selectedPeriod].fees;
    if (!periodFees) {
        totalAmount = 0;
        return;
    }

    // Base registration fee
    totalAmount = periodFees[selectedType] || 0;

    // Add additional items
    if (fees.additional_items) {
        Object.entries(fees.additional_items).forEach(([item, data]) => {
            const checkbox = document.getElementById(item);
            if (checkbox && checkbox.checked && !checkbox.disabled && data.enabled) {
                totalAmount += data.fee;
            }
        });
    }

    // Update total display in all relevant places
    const symbol = fees.currency.symbol || 'R';
    
    // Update total in review section
    const reviewTotal = document.querySelector('.total-amount .amount');
    if (reviewTotal) {
        reviewTotal.textContent = `${symbol} ${totalAmount.toFixed(2)}`;
    }
    
    // Update payment summary
    updatePaymentSummary();
    
    // Add a running total display in step 1 and 2
    const runningTotal = document.querySelector('.running-total');
    if (runningTotal) {
        runningTotal.textContent = `Total: ${symbol} ${totalAmount.toFixed(2)}`;
    }
    
    // Update hidden field
    document.getElementById('total_amount').value = totalAmount;
}

function updateSummary() {
    // Update period name
    const periodElement = document.querySelector('.period-name');
    const periodLabel = document.querySelector(`label[for="${selectedPeriod}"] h4`);
    if (periodLabel) {
        periodElement.textContent = periodLabel.textContent;
    }

    // Update type name
    const typeElement = document.querySelector('.type-name');
    const typeLabel = document.querySelector(`label[for="${selectedType}"] h4`);
    if (typeLabel) {
        typeElement.textContent = typeLabel.textContent;
    }

    // Update additional items
    const itemsList = document.querySelector('.additional-items-list');
    itemsList.innerHTML = '';
    
    if (fees.additional_items) {
        Object.entries(fees.additional_items).forEach(([item, data]) => {
            const checkbox = document.getElementById(item);
            if (checkbox && checkbox.checked && !checkbox.disabled && data.enabled) {
                const symbol = fees.currency.symbol || 'R';
                const itemElement = document.createElement('div');
                itemElement.className = 'additional-item';
                itemElement.innerHTML = `
                    <span class="item-name">${data.description || item}</span>
                    <span class="item-price">${symbol} ${data.fee.toFixed(2)}</span>
                `;
                itemsList.appendChild(itemElement);
            }
        });
    }

    if (itemsList.children.length === 0) {
        itemsList.innerHTML = '<span class="none-selected">No additional items selected</span>';
    }

    // Update total amount display
    calculateTotal();
}

// Event Listeners
document.addEventListener('DOMContentLoaded', function() {
    // Add running total display to steps 1 and 2
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    
    const runningTotalDiv = document.createElement('div');
    runningTotalDiv.className = 'running-total';
    runningTotalDiv.style.cssText = `
        position: sticky;
        bottom: 0;
        background: var(--primary-color);
        color: white;
        padding: 1rem;
        margin: 1rem -2rem -2rem -2rem;
        text-align: right;
        font-size: 1.2rem;
        font-weight: bold;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    `;
    
    step1.appendChild(runningTotalDiv.cloneNode(true));
    step2.appendChild(runningTotalDiv.cloneNode(true));
    
    // Initialize prices
    updatePrices();
    
    // Handle form submission
    document.getElementById('registration-form').addEventListener('submit', function(e) {
        if (!validateForm()) {
            e.preventDefault();
        }
    });
    
    // Handle period selection
    document.querySelectorAll('input[name="registration_period"]').forEach(input => {
        input.addEventListener('change', function() {
            selectedPeriod = this.value;
            document.getElementById('selected_period').value = selectedPeriod;
            updatePrices();
            
            // Enable/disable next button
            document.querySelector('.next-step').disabled = !selectedPeriod || !selectedType;
        });
    });
    
    // Handle type selection
    document.querySelectorAll('input[name="registration_type"]').forEach(input => {
        input.addEventListener('change', function() {
            selectedType = this.value;
            document.getElementById('selected_type').value = selectedType;
            updatePrices();
            
            // Enable/disable next button
            document.querySelector('.next-step').disabled = !selectedPeriod || !selectedType;
        });
    });
    
    // Add event listeners for additional items
    if (fees.additional_items) {
        Object.keys(fees.additional_items).forEach(item => {
            const checkbox = document.getElementById(item);
            if (checkbox) {
                checkbox.addEventListener('change', () => {
                    calculateTotal();
                    updateSummary();
                    
                    // Update hidden fields
                    document.getElementById('has_' + checkbox.id).value = checkbox.checked;
                });
            }
        });
    }
});

// Navigation Functions
function showStep(step) {
    document.querySelectorAll('.registration-step').forEach(s => s.style.display = 'none');
    document.getElementById(`step${step}`).style.display = 'block';
    
    document.querySelectorAll('.progress-steps .step').forEach(s => s.classList.remove('active'));
    document.querySelector(`.progress-steps .step[data-step="${step}"]`).classList.add('active');
    
    const progress = document.querySelector('.progress-bar .progress');
    progress.style.width = `${(step - 1) * 50}%`;
}

document.querySelectorAll('.next-step').forEach(button => {
    button.addEventListener('click', function() {
        const currentStep = parseInt(this.closest('.registration-step').id.replace('step', ''));
        showStep(currentStep + 1);
    });
});

document.querySelectorAll('.prev-step').forEach(button => {
    button.addEventListener('click', function() {
        const currentStep = parseInt(this.closest('.registration-step').id.replace('step', ''));
        showStep(currentStep - 1);
    });
});

// Payment Processing Functions
function proceedToPayment() {
    try {
        if (!selectedPeriod || !selectedType) {
            throw new Error('Please select both registration period and type');
        }

        if (totalAmount <= 0) {
            throw new Error('Invalid registration amount');
        }

        // Disable payment button to prevent double-clicks
        const paymentBtn = document.getElementById('proceed-to-payment');
        paymentBtn.disabled = true;
        paymentBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

        // Prepare registration data
        const registrationData = {
            selected_period: selectedPeriod,
            selected_type: selectedType,
            total_amount: totalAmount,
            extra_paper: document.getElementById('has_extra_paper').value === 'true',
            workshop: document.getElementById('has_workshop').value === 'true',
            banquet: document.getElementById('has_banquet').value === 'true'
        };

        // Submit to payment processing route
        fetch('/payment/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify(registrationData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Redirect to iKhokha payment page
                window.location.href = data.payment_url;
            } else {
                throw new Error(data.error || 'Payment initialization failed');
            }
        })
        .catch(error => {
            console.error('Payment error:', error);
            alert('Payment processing failed: ' + error.message);
            
            // Re-enable payment button
            paymentBtn.disabled = false;
            paymentBtn.innerHTML = '<i class="fas fa-credit-card"></i> Proceed to Payment';
        });

    } catch (error) {
        alert(error.message);
        
        // Re-enable payment button
        const paymentBtn = document.getElementById('proceed-to-payment');
        paymentBtn.disabled = false;
        paymentBtn.innerHTML = '<i class="fas fa-credit-card"></i> Proceed to Payment';
    }
}

function getCsrfToken() {
    // Get CSRF token from meta tag or cookie
    const meta = document.querySelector('meta[name="csrf-token"]');
    if (meta) {
        return meta.getAttribute('content');
    }
    
    // Fallback: extract from cookies
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'csrf_token') {
            return decodeURIComponent(value);
        }
    }
    
    return '';
}

// Form Validation (simplified for payment flow)
function validateForm() {
    return selectedPeriod && selectedType && totalAmount > 0;
}

// Update payment summary display
function updatePaymentSummary() {
    if (selectedPeriod && selectedType) {
        const baseFee = fees[selectedPeriod]?.fees?.[selectedType] || 0;
        let additionalFees = 0;
        
        // Calculate additional fees
        ['extra_paper', 'workshop', 'banquet'].forEach(item => {
            const checkbox = document.getElementById(item);
            if (checkbox && checkbox.checked && fees.additional_items?.[item]?.enabled) {
                additionalFees += fees.additional_items[item].fee || 0;
            }
        });
        
        // Update display
        document.getElementById('base-fee-amount').textContent = `R${baseFee.toFixed(2)}`;
        document.getElementById('additional-fee-amount').textContent = `R${additionalFees.toFixed(2)}`;
        document.getElementById('final-total').textContent = `R${totalAmount.toFixed(2)}`;
        
        // Show/hide additional fees row
        const additionalRow = document.getElementById('additional-fees');
        if (additionalFees > 0) {
            additionalRow.style.display = 'flex';
        } else {
            additionalRow.style.display = 'none';
        }
    }
}

function clearFileUpload() {
    const input = document.getElementById('payment_proof');
    input.value = '';
    document.getElementById('upload-preview').style.display = 'none';
}
</script>
{% endblock %}