{% extends "base.html" %}

{% block title %}Registration - GIIR Conference 2024{% endblock %}

{% block head %}
<!-- Add Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

<!-- Initialize Firebase -->
<script>
const firebaseConfig = {
    apiKey: "{{ firebase_config.apiKey }}",
    authDomain: "{{ firebase_config.authDomain }}",
    databaseURL: "{{ firebase_config.databaseURL }}",
    projectId: "{{ firebase_config.projectId }}",
    messagingSenderId: "{{ firebase_config.messagingSenderId }}",
    appId: "{{ firebase_config.appId }}"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
</script>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Conference Registration</h1>
    <p>Complete your registration for GIIR Conference 2024</p>
</div>

<div class="content-section">
    <!-- Registration Progress -->
    <div class="registration-progress">
        <div class="progress-bar">
            <div class="progress" style="width: 33%"></div>
        </div>
        <div class="progress-steps">
            <div class="step active" data-step="1">
                <div class="step-number">1</div>
                <div class="step-content">
                    <h3>Package Selection</h3>
                    <p>Choose your registration period and type</p>
                </div>
            </div>
            <div class="step" data-step="2">
                <div class="step-number">2</div>
                <div class="step-content">
                    <h3>Additional Items</h3>
                    <p>Select optional extras</p>
                </div>
            </div>
            <div class="step" data-step="3">
                <div class="step-number">3</div>
                <div class="step-content">
                    <h3>Review & Payment</h3>
                    <p>Confirm and proceed to payment</p>
                </div>
            </div>
        </div>
    </div>

    <form id="registration-form" method="POST" action="{{ url_for('registration') }}" enctype="multipart/form-data">
        <!-- Step 1: Package Selection -->
        <div class="registration-step active" id="step1">
            <div class="step-header">
                <h2>Step 1: Package Selection</h2>
                <p>First, select your registration period and type</p>
            </div>

            <!-- Registration Period Selection -->
            <div class="period-selection">
                <h3>Select Registration Period</h3>
                <div class="period-options">
                    {% if fees.early_bird and fees.early_bird.enabled %}
                    <div class="period-card {% if fees.early_bird.seats.remaining <= 0 %}disabled{% endif %}">
                        <input type="radio" name="registration_period" id="early_bird" value="early_bird" 
                               {% if fees.early_bird.seats.remaining <= 0 %}disabled{% endif %}>
                        <label for="early_bird">
                            <div class="period-header">
                                <i class="fas fa-star"></i>
                                <h4>Early Bird Registration</h4>
                                {% if fees.early_bird.deadline %}
                                <span class="deadline">Until {{ fees.early_bird.deadline }}</span>
                                {% endif %}
                            </div>
                            {% if fees.early_bird.seats.show_remaining %}
                            <div class="seats-remaining">
                                <span class="count">{{ fees.early_bird.seats.remaining }}</span> seats remaining
                            </div>
                            {% endif %}
                            <div class="benefits-list">
                                {% if fees.early_bird.benefits %}
                                <h5>Benefits:</h5>
                                <ul>
                                    {% for benefit in fees.early_bird.benefits %}
                                    <li>{{ benefit }}</li>
                                    {% endfor %}
                                </ul>
                                {% endif %}
                            </div>
                        </label>
                    </div>
                    {% endif %}

                    {% if fees.early %}
                    <div class="period-card">
                        <input type="radio" name="registration_period" id="early" value="early">
                        <label for="early">
                            <div class="period-header">
                                <i class="fas fa-calendar-check"></i>
                                <h4>Early Registration</h4>
                                {% if fees.early.deadline %}
                                <span class="deadline">Until {{ fees.early.deadline }}</span>
                                {% endif %}
                            </div>
                            <div class="benefits-list">
                                {% if fees.early.benefits %}
                                <h5>Benefits:</h5>
                                <ul>
                                    {% for benefit in fees.early.benefits %}
                                    <li>{{ benefit }}</li>
                                    {% endfor %}
                                </ul>
                                {% endif %}
                            </div>
                        </label>
                    </div>
                    {% endif %}

                    {% if fees.regular %}
                    <div class="period-card">
                        <input type="radio" name="registration_period" id="regular" value="regular">
                        <label for="regular">
                            <div class="period-header">
                                <i class="fas fa-calendar-alt"></i>
                                <h4>Regular Registration</h4>
                                {% if fees.regular.deadline %}
                                <span class="deadline">Until {{ fees.regular.deadline }}</span>
                                {% endif %}
                            </div>
                            <div class="benefits-list">
                                {% if fees.regular.benefits %}
                                <h5>Benefits:</h5>
                                <ul>
                                    {% for benefit in fees.regular.benefits %}
                                    <li>{{ benefit }}</li>
                                    {% endfor %}
                                </ul>
                                {% endif %}
                            </div>
                        </label>
                    </div>
                    {% endif %}

                    {% if fees.late %}
                    <div class="period-card">
                        <input type="radio" name="registration_period" id="late" value="late">
                        <label for="late">
                            <div class="period-header">
                                <i class="fas fa-calendar-times"></i>
                                <h4>Late Registration</h4>
                                {% if fees.late.deadline %}
                                <span class="deadline">Until {{ fees.late.deadline }}</span>
                                {% endif %}
                            </div>
                            <div class="benefits-list">
                                {% if fees.late.benefits %}
                                <h5>Benefits:</h5>
                                <ul>
                                    {% for benefit in fees.late.benefits %}
                                    <li>{{ benefit }}</li>
                                    {% endfor %}
                                </ul>
                                {% endif %}
                            </div>
                        </label>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Registration Type Selection -->
            <div class="type-selection">
                <h3>Select Registration Type</h3>
                <div class="type-options">
                    <div class="type-card" id="student_author_card">
                        <input type="radio" name="registration_type" id="student_author" value="student_author">
                        <label for="student_author">
                            <div class="type-header">
                                <i class="fas fa-user-graduate"></i>
                                <h4>Student Author</h4>
                            </div>
                            <div class="type-price">
                                <span class="amount"></span>
                            </div>
                        </label>
                    </div>

                    <div class="type-card" id="regular_author_card">
                        <input type="radio" name="registration_type" id="regular_author" value="regular_author">
                        <label for="regular_author">
                            <div class="type-header">
                                <i class="fas fa-user"></i>
                                <h4>Regular Author</h4>
                            </div>
                            <div class="type-price">
                                <span class="amount"></span>
                            </div>
                        </label>
                    </div>

                    <div class="type-card" id="physical_delegate_card">
                        <input type="radio" name="registration_type" id="physical_delegate" value="physical_delegate">
                        <label for="physical_delegate">
                            <div class="type-header">
                                <i class="fas fa-user-friends"></i>
                                <h4>Physical Delegate</h4>
                            </div>
                            <div class="type-price">
                                <span class="amount"></span>
                            </div>
                        </label>
                    </div>

                    <div class="type-card" id="virtual_delegate_card">
                        <input type="radio" name="registration_type" id="virtual_delegate" value="virtual_delegate">
                        <label for="virtual_delegate">
                            <div class="type-header">
                                <i class="fas fa-laptop"></i>
                                <h4>Virtual Delegate</h4>
                            </div>
                            <div class="type-price">
                                <span class="amount"></span>
                            </div>
                        </label>
                    </div>

                    <div class="type-card" id="listener_card">
                        <input type="radio" name="registration_type" id="listener" value="listener">
                        <label for="listener">
                            <div class="type-header">
                                <i class="fas fa-headphones"></i>
                                <h4>Listener</h4>
                            </div>
                            <div class="type-price">
                                <span class="amount"></span>
                            </div>
                        </label>
                    </div>
                </div>
            </div>

            <div class="step-actions">
                <button type="button" class="btn btn-primary next-step" disabled>Continue to Additional Items</button>
            </div>
        </div>

        <!-- Step 2: Additional Items -->
        <div class="registration-step" id="step2" style="display: none;">
            <div class="step-header">
                <h2>Step 2: Additional Items</h2>
                <p>Select any additional items you would like to add</p>
            </div>

            <div class="additional-items">
                {% if fees.additional_items %}
                    {% if fees.additional_items.extra_paper and fees.additional_items.extra_paper.enabled %}
                    <div class="item-card" id="extra_paper_card">
                        <div class="item-header">
                            <i class="fas fa-file-alt"></i>
                            <h4>Extra Paper</h4>
                        </div>
                        <div class="item-description">
                            {{ fees.additional_items.extra_paper.description }}
                        </div>
                        <div class="item-price">
                            <span class="amount"></span>
                        </div>
                        <div class="item-select">
                            <label class="switch">
                                <input type="checkbox" id="extra_paper" name="extra_paper">
                                <span class="slider round"></span>
                            </label>
                        </div>
                    </div>
                    {% endif %}

                    {% if fees.additional_items.workshop and fees.additional_items.workshop.enabled %}
                    <div class="item-card" id="workshop_card">
                        <div class="item-header">
                            <i class="fas fa-chalkboard-teacher"></i>
                            <h4>Workshop</h4>
                        </div>
                        <div class="item-description">
                            {{ fees.additional_items.workshop.description }}
                        </div>
                        <div class="item-price">
                            <span class="amount"></span>
                        </div>
                        <div class="item-select">
                            <label class="switch">
                                <input type="checkbox" id="workshop" name="workshop">
                                <span class="slider round"></span>
                            </label>
                        </div>
                    </div>
                    {% endif %}

                    {% if fees.additional_items.banquet and fees.additional_items.banquet.enabled %}
                    <div class="item-card" id="banquet_card">
                        <div class="item-header">
                            <i class="fas fa-glass-cheers"></i>
                            <h4>Banquet</h4>
                        </div>
                        <div class="item-description">
                            {{ fees.additional_items.banquet.description }}
                        </div>
                        <div class="item-price">
                            <span class="amount"></span>
                        </div>
                        <div class="item-select">
                            <label class="switch">
                                <input type="checkbox" id="banquet" name="banquet">
                                <span class="slider round"></span>
                            </label>
                        </div>
                    </div>
                    {% endif %}
                {% endif %}
            </div>

            <div class="step-actions">
                <button type="button" class="btn btn-secondary prev-step">Back to Package Selection</button>
                <button type="button" class="btn btn-primary next-step">Continue to Payment</button>
            </div>
        </div>

        <!-- Step 3: Review & Payment -->
        <div class="registration-step" id="step3" style="display: none;">
            <div class="step-header">
                <h2>Step 3: Review & Payment</h2>
                <p>Review your selections and complete payment</p>
            </div>

            <div class="review-section">
                <h3>Registration Summary</h3>
                <div class="summary-details">
                    <div class="summary-item">
                        <span class="label">Registration Period:</span>
                        <span class="value period-name"></span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Registration Type:</span>
                        <span class="value type-name"></span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Additional Items:</span>
                        <div class="value additional-items-list"></div>
                    </div>
                    <div class="summary-item total-amount">
                        <span class="label">Total Amount:</span>
                        <span class="value amount"></span>
                    </div>
                </div>
            </div>

            <div class="payment-section">
                <h3>Payment Details</h3>
                <div class="payment-instructions">
                    <div class="form-group">
                        <label for="payment_reference">Payment Reference:</label>
                        <input type="text" id="payment_reference" name="payment_reference" class="form-control" 
                               required placeholder="Enter your payment reference">
                        <small class="form-text text-muted">Use this as your payment reference when making the bank transfer</small>
                    </div>

                    <div class="form-group">
                        <label for="payment_proof">Upload Proof of Payment:</label>
                        <div class="upload-container">
                            <input type="file" id="payment_proof" name="payment_proof" class="form-control" 
                                   accept=".pdf,.jpg,.jpeg,.png" required onchange="validateFileUpload(this)">
                            <div class="upload-preview" id="upload-preview" style="display: none;">
                                <div class="preview-content">
                                    <i class="fas fa-file-alt"></i>
                                    <span class="filename"></span>
                                    <span class="filesize"></span>
                                </div>
                                <button type="button" class="btn btn-sm btn-danger" onclick="clearFileUpload()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <small class="form-text text-muted">Accepted formats: PDF, JPG, PNG (Max size: 5MB)</small>
                    </div>
                </div>
            </div>

            <!-- Hidden Fields -->
            <input type="hidden" name="selected_period" id="selected_period">
            <input type="hidden" name="selected_type" id="selected_type">
            <input type="hidden" name="total_amount" id="total_amount">
            <input type="hidden" name="extra_paper" id="has_extra_paper">
            <input type="hidden" name="workshop" id="has_workshop">
            <input type="hidden" name="banquet" id="has_banquet">

            <div class="step-actions">
                <button type="button" class="btn btn-secondary prev-step">Back to Additional Items</button>
                <button type="submit" class="btn btn-primary">Complete Registration</button>
            </div>
        </div>
    </form>
</div>

<style>
/* Progress Bar Styles */
.registration-progress {
    margin-bottom: 2rem;
}

.progress-bar {
    height: 4px;
    background: var(--background-color);
    border-radius: 2px;
    margin-bottom: 1rem;
    position: relative;
}

.progress-bar .progress {
    position: absolute;
    height: 100%;
    background: var(--primary-color);
    border-radius: 2px;
    transition: width 0.3s ease;
}

.progress-steps {
    display: flex;
    justify-content: space-between;
    gap: 1rem;
}

.step {
    flex: 1;
    text-align: center;
    position: relative;
    opacity: 0.5;
    transition: opacity 0.3s ease;
}

.step.active {
    opacity: 1;
}

.step-number {
    width: 32px;
    height: 32px;
    background: var(--background-color);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 0.5rem;
    font-weight: bold;
    color: var(--text-color);
}

.step.active .step-number {
    background: var(--primary-color);
    color: white;
}

.step-content h3 {
    font-size: 1rem;
    margin: 0;
}

.step-content p {
    font-size: 0.9rem;
    margin: 0;
    color: var(--text-secondary);
}

/* Step Content Styles */
.registration-step {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.step-header {
    margin-bottom: 2rem;
    text-align: center;
}

.step-header h2 {
    margin: 0;
    color: var(--primary-color);
}

.step-header p {
    margin: 0.5rem 0 0;
    color: var(--text-secondary);
}

/* Registration Cards Styling */
.period-options, .type-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    margin: 1.5rem 0;
}

.period-card, .type-card {
    position: relative;
    border: 2px solid #e1e8ed;
    border-radius: 16px;
    padding: 1.5rem;
    transition: all 0.3s ease;
    background: #ffffff;
    overflow: hidden;
}

.period-card:hover, .type-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
}

.period-card input[type="radio"], .type-card input[type="radio"] {
    position: absolute;
    opacity: 0;
}

.period-card input[type="radio"]:checked + label, 
.type-card input[type="radio"]:checked + label {
    border-color: var(--primary-color);
}

.period-card input[type="radio"]:checked + label::before, 
.type-card input[type="radio"]:checked + label::before {
    content: '✓';
    position: absolute;
    top: -1px;
    right: -1px;
    background: var(--primary-color);
    color: white;
    width: 32px;
    height: 32px;
    border-radius: 0 16px 0 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
}

.period-header, .type-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #e1e8ed;
}

.period-header i, .type-header i {
    font-size: 1.5rem;
    color: var(--primary-color);
}

.period-header h4, .type-header h4 {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: #2c3e50;
}

.deadline {
    display: inline-block;
    margin-top: 0.5rem;
    padding: 0.25rem 0.75rem;
    background: #f8f9fa;
    border-radius: 12px;
    font-size: 0.875rem;
    color: #666;
}

.seats-remaining {
    margin: 1rem 0;
    padding: 0.5rem;
    background: #f8f9fa;
    border-radius: 8px;
    text-align: center;
    font-size: 0.9rem;
    color: #666;
}

.seats-remaining .count {
    font-weight: 600;
    color: var(--primary-color);
}

.benefits-list {
    margin-top: 1rem;
}

.benefits-list h5 {
    font-size: 1rem;
    margin-bottom: 0.75rem;
    color: #2c3e50;
}

.benefits-list ul {
    list-style: none;
    padding: 0;
    margin: 0;
}

.benefits-list li {
    position: relative;
    padding-left: 1.5rem;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
    color: #666;
}

.benefits-list li::before {
    content: '•';
    position: absolute;
    left: 0.5rem;
    color: var(--primary-color);
}

.type-price {
    margin-top: 1rem;
    text-align: center;
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--primary-color);
}

.period-card.disabled {
    opacity: 0.7;
    cursor: not-allowed;
    background: #f8f9fa;
}

.period-card.disabled:hover {
    transform: none;
    box-shadow: none;
}

/* Additional Items Styles */
.additional-items {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-top: 1rem;
}

.item-card {
    background: white;
    border: 1px solid var(--background-color);
    border-radius: 12px;
    padding: 1.5rem;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.item-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

/* Add selected state styles */
.item-card.selected {
    background: var(--primary-color);
    border-color: var(--primary-color);
}

.item-card.selected .item-header h4,
.item-card.selected .item-content p,
.item-card.selected .checkbox-label span {
    color: white;
}

.item-card.selected .item-header i {
    color: white;
    background: rgba(255, 255, 255, 0.2);
}

.item-card.selected .item-price {
    color: white;
}

.item-card.selected .item-price::before {
    color: rgba(255, 255, 255, 0.8);
}

.item-card.selected .checkbox-label input[type="checkbox"] {
    border-color: white;
    background-color: transparent;
}

.item-card.selected .checkbox-label input[type="checkbox"]:checked {
    background-color: white;
}

.item-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1.25rem;
}

.item-header i {
    font-size: 1.5rem;
    color: var(--primary-color);
    background: var(--background-color);
    padding: 0.75rem;
    border-radius: 8px;
}

.item-header h4 {
    margin: 0;
    font-size: 1.2rem;
    color: var(--text-color);
}

.item-content {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.item-content p {
    margin: 0;
    color: var(--text-secondary);
    font-size: 0.95rem;
    line-height: 1.5;
}

.item-price {
    font-size: 1.3rem;
    font-weight: 600;
    color: var(--primary-color);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.item-price::before {
    content: 'R';
    font-size: 1rem;
    color: var(--text-secondary);
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    cursor: pointer;
    padding: 0.5rem 0;
    border-top: 1px solid var(--background-color);
    margin-top: 0.5rem;
}

.checkbox-label input[type="checkbox"] {
    width: 22px;
    height: 22px;
    border: 2px solid var(--background-color);
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.checkbox-label input[type="checkbox"]:checked {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
}

.checkbox-label span {
    font-weight: 500;
    color: var(--text-color);
}

/* Review Summary Styles */
.review-section {
    background: var(--background-color);
    border-radius: 8px;
    padding: 1.5rem;
}

.summary-details {
    margin-bottom: 2rem;
}

.summary-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
}

.summary-item:last-child {
    margin-bottom: 0;
}

.summary-label {
    color: var(--text-secondary);
}

.summary-value {
    font-weight: 500;
}

.total-amount {
    margin-top: 2rem;
    padding-top: 1rem;
    border-top: 2px solid rgba(0,0,0,0.1);
}

.total {
    font-size: 1.2rem;
    font-weight: bold;
}

.total .summary-value {
    color: var(--primary-color);
}

/* Step Actions */
.step-actions {
    margin-top: 2rem;
    display: flex;
    justify-content: space-between;
    gap: 1rem;
}

.step-actions button {
    min-width: 200px;
}

/* Payment Section Styles */
.payment-section {
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 2px solid var(--background-color);
}

.payment-instructions {
    display: grid;
    gap: 1.5rem;
}

.form-group {
    display: grid;
    gap: 0.5rem;
}

.form-group label {
    font-weight: 500;
}

.form-control {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid var(--background-color);
    border-radius: 4px;
    font-size: 1rem;
    transition: border-color 0.3s ease;
}

.form-control:focus {
    outline: none;
    border-color: var(--primary-color);
}

.form-text {
    font-size: 0.9rem;
    color: var(--text-secondary);
}

.upload-container {
    position: relative;
}

.upload-preview {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: var(--background-color);
    padding: 0.75rem;
    border-radius: 4px;
    margin-top: 0.5rem;
}

.preview-content {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.preview-content i {
    color: var(--primary-color);
    font-size: 1.2rem;
}

.filename {
    font-weight: 500;
    color: var(--text-color);
}

.filesize {
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.invalid-feedback {
    display: none;
    color: var(--danger-color);
    font-size: 0.875rem;
    margin-top: 0.25rem;
}

.invalid-feedback.show {
    display: block;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .registration-step {
        padding: 1.5rem;
    }
    
    .period-options, .type-options {
        grid-template-columns: 1fr;
    }
    
    .period-card, .type-card {
        padding: 1.25rem;
    }
    
    .period-header h4, .type-header h4 {
        font-size: 1.1rem;
    }
}
</style>

<script>
var selectedPeriod = null;
var selectedType = null;
var totalAmount = 0;
var fees = JSON.parse('{{ fees|tojson|safe }}');

function updatePrices() {
    if (!selectedPeriod || !selectedType) return;
    
    var periodFees = fees[selectedPeriod].fees;
    if (!periodFees) return;

    // Update registration type prices
    document.querySelectorAll('.type-card').forEach(card => {
        const input = card.querySelector('input[name="registration_type"]');
        const priceElement = card.querySelector('.type-price .amount');
        const type = input.value;
        
        if (periodFees[type] !== undefined) {
            const price = periodFees[type];
            const symbol = fees.currency.symbol || 'R';
            priceElement.textContent = `${symbol} ${price.toFixed(2)}`;
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });

    // Update additional items prices and availability
    if (fees.additional_items) {
        Object.entries(fees.additional_items).forEach(([item, data]) => {
            const itemCard = document.querySelector(`#${item}_card`);
            if (!itemCard) return;

            const priceElement = itemCard.querySelector('.item-price .amount');
            const checkbox = document.getElementById(item);
            
            if (data.enabled) {
                const symbol = fees.currency.symbol || 'R';
                priceElement.textContent = `${symbol} ${data.fee.toFixed(2)}`;
                itemCard.style.display = 'block';
                
                // Handle virtual delegate restrictions
                if (selectedType === 'virtual_delegate' && !data.virtual_eligible) {
                    checkbox.checked = false;
                    checkbox.disabled = true;
                    itemCard.classList.add('disabled');
                } else {
                    checkbox.disabled = false;
                    itemCard.classList.remove('disabled');
                }
            } else {
                itemCard.style.display = 'none';
            }
        });
    }

    calculateTotal();
    updateSummary();
}

function calculateTotal() {
    if (!selectedPeriod || !selectedType) {
        totalAmount = 0;
        return;
    }

    const periodFees = fees[selectedPeriod].fees;
    if (!periodFees) {
        totalAmount = 0;
        return;
    }

    // Base registration fee
    totalAmount = periodFees[selectedType] || 0;

    // Add additional items
    if (fees.additional_items) {
        Object.entries(fees.additional_items).forEach(([item, data]) => {
            const checkbox = document.getElementById(item);
            if (checkbox && checkbox.checked && !checkbox.disabled && data.enabled) {
                totalAmount += data.fee;
            }
        });
    }

    // Update total display in all relevant places
    const symbol = fees.currency.symbol || 'R';
    
    // Update total in review section
    const reviewTotal = document.querySelector('.total-amount .amount');
    if (reviewTotal) {
        reviewTotal.textContent = `${symbol} ${totalAmount.toFixed(2)}`;
    }
    
    // Add a running total display in step 1 and 2
    const runningTotal = document.querySelector('.running-total');
    if (runningTotal) {
        runningTotal.textContent = `Total: ${symbol} ${totalAmount.toFixed(2)}`;
    }
    
    // Update hidden field
    document.getElementById('total_amount').value = totalAmount;
}

function updateSummary() {
    // Update period name
    const periodElement = document.querySelector('.period-name');
    const periodLabel = document.querySelector(`label[for="${selectedPeriod}"] h4`);
    if (periodLabel) {
        periodElement.textContent = periodLabel.textContent;
    }

    // Update type name
    const typeElement = document.querySelector('.type-name');
    const typeLabel = document.querySelector(`label[for="${selectedType}"] h4`);
    if (typeLabel) {
        typeElement.textContent = typeLabel.textContent;
    }

    // Update additional items
    const itemsList = document.querySelector('.additional-items-list');
    itemsList.innerHTML = '';
    
    if (fees.additional_items) {
        Object.entries(fees.additional_items).forEach(([item, data]) => {
            const checkbox = document.getElementById(item);
            if (checkbox && checkbox.checked && !checkbox.disabled && data.enabled) {
                const symbol = fees.currency.symbol || 'R';
                const itemElement = document.createElement('div');
                itemElement.className = 'additional-item';
                itemElement.innerHTML = `
                    <span class="item-name">${data.description || item}</span>
                    <span class="item-price">${symbol} ${data.fee.toFixed(2)}</span>
                `;
                itemsList.appendChild(itemElement);
            }
        });
    }

    if (itemsList.children.length === 0) {
        itemsList.innerHTML = '<span class="none-selected">No additional items selected</span>';
    }

    // Update total amount display
    calculateTotal();
}

// Event Listeners
document.addEventListener('DOMContentLoaded', function() {
    // Add running total display to steps 1 and 2
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    
    const runningTotalDiv = document.createElement('div');
    runningTotalDiv.className = 'running-total';
    runningTotalDiv.style.cssText = `
        position: sticky;
        bottom: 0;
        background: var(--primary-color);
        color: white;
        padding: 1rem;
        margin: 1rem -2rem -2rem -2rem;
        text-align: right;
        font-size: 1.2rem;
        font-weight: bold;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    `;
    
    step1.appendChild(runningTotalDiv.cloneNode(true));
    step2.appendChild(runningTotalDiv.cloneNode(true));
    
    // Initialize prices
    updatePrices();
    
    // Handle form submission
    document.getElementById('registration-form').addEventListener('submit', function(e) {
        if (!validateForm()) {
            e.preventDefault();
        }
    });
    
    // Handle period selection
    document.querySelectorAll('input[name="registration_period"]').forEach(input => {
        input.addEventListener('change', function() {
            selectedPeriod = this.value;
            document.getElementById('selected_period').value = selectedPeriod;
            updatePrices();
            
            // Enable/disable next button
            document.querySelector('.next-step').disabled = !selectedPeriod || !selectedType;
        });
    });
    
    // Handle type selection
    document.querySelectorAll('input[name="registration_type"]').forEach(input => {
        input.addEventListener('change', function() {
            selectedType = this.value;
            document.getElementById('selected_type').value = selectedType;
            updatePrices();
            
            // Enable/disable next button
            document.querySelector('.next-step').disabled = !selectedPeriod || !selectedType;
        });
    });
    
    // Add event listeners for additional items
    if (fees.additional_items) {
        Object.keys(fees.additional_items).forEach(item => {
            const checkbox = document.getElementById(item);
            if (checkbox) {
                checkbox.addEventListener('change', () => {
                    calculateTotal();
                    updateSummary();
                    
                    // Update hidden fields
                    document.getElementById('has_' + checkbox.id).value = checkbox.checked;
                });
            }
        });
    }
});

// Navigation Functions
function showStep(step) {
    document.querySelectorAll('.registration-step').forEach(s => s.style.display = 'none');
    document.getElementById(`step${step}`).style.display = 'block';
    
    document.querySelectorAll('.progress-steps .step').forEach(s => s.classList.remove('active'));
    document.querySelector(`.progress-steps .step[data-step="${step}"]`).classList.add('active');
    
    const progress = document.querySelector('.progress-bar .progress');
    progress.style.width = `${(step - 1) * 50}%`;
}

document.querySelectorAll('.next-step').forEach(button => {
    button.addEventListener('click', function() {
        const currentStep = parseInt(this.closest('.registration-step').id.replace('step', ''));
        showStep(currentStep + 1);
    });
});

document.querySelectorAll('.prev-step').forEach(button => {
    button.addEventListener('click', function() {
        const currentStep = parseInt(this.closest('.registration-step').id.replace('step', ''));
        showStep(currentStep - 1);
    });
});

// Form Validation
function validateForm() {
    try {
        if (!selectedPeriod || !selectedType) {
            throw new Error('Please select both registration period and type');
        }

        const paymentRef = document.getElementById('payment_reference');
        const paymentProof = document.getElementById('payment_proof');

        if (!paymentRef.value.trim()) {
            paymentRef.focus();
            throw new Error('Please enter a payment reference');
        }

        if (!paymentProof.files || paymentProof.files.length === 0) {
            throw new Error('Please upload proof of payment');
        }

        return true;
    } catch (error) {
        alert(error.message);
        return false;
    }
}

// File Upload Functions
function validateFileUpload(input) {
    const file = input.files[0];
    const maxSize = 5 * 1024 * 1024; // 5MB
    const allowedTypes = ['application/pdf', 'image/jpeg', 'image/png'];
    
    if (file) {
        if (file.size > maxSize) {
            input.value = '';
            document.getElementById('file-error').textContent = 'File size exceeds 5MB limit';
            document.getElementById('file-error').style.display = 'block';
            return false;
        }
        
        if (!allowedTypes.includes(file.type)) {
            input.value = '';
            document.getElementById('file-error').textContent = 'Invalid file type. Please upload PDF, JPG, or PNG';
            document.getElementById('file-error').style.display = 'block';
            return false;
        }
        
        // Show preview
        const preview = document.getElementById('upload-preview');
        preview.style.display = 'flex';
        preview.querySelector('.filename').textContent = file.name;
        preview.querySelector('.filesize').textContent = `${(file.size / 1024 / 1024).toFixed(2)} MB`;
        document.getElementById('file-error').style.display = 'none';
        return true;
    }
    return false;
}

function clearFileUpload() {
    const input = document.getElementById('payment_proof');
    input.value = '';
    document.getElementById('upload-preview').style.display = 'none';
}
</script>
{% endblock %}