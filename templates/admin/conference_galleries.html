{% extends "admin/base_admin.html" %}

{% block title %}Conference Galleries - Admin Panel{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0 text-gray-800">
                        <i class="fas fa-images me-2"></i>
                        Conference Galleries
                    </h1>
                    <p class="text-muted">Manage photo galleries for each conference</p>
                </div>
                <div>
                    <form method="POST" action="{{ url_for('clean_all_galleries') }}" style="display: inline;" onsubmit="return confirm('‚ö†Ô∏è WARNING: This will delete ALL gallery images, attendees, and summaries from ALL conferences. This action cannot be undone. Are you sure you want to proceed?');">
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-trash-alt me-1"></i>
                            Clean All Galleries
                        </button>
                    </form>
                </div>
            </div>

            <!-- Conference Selection -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-calendar me-1"></i>
                    Select Conference
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for conference_id, conference in conferences.items() %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card conference-card" data-conference-id="{{ conference_id }}">
                                <div class="card-body text-center">
                                    <h6 class="card-title">{{ conference.basic_info.name }}</h6>
                                    <p class="card-text small text-muted">
                                        {% if conference.basic_info.year %}
                                        {{ conference.basic_info.year }}
                                        {% else %}
                                        2024
                                        {% endif %}
                                    </p>

                                    <!-- Gallery Visibility Toggle -->
                                    <div class="d-flex justify-content-center align-items-center mb-2">
                                        <small class="text-muted me-2">Gallery:</small>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input gallery-toggle"
                                                   type="checkbox"
                                                   data-conference-id="{{ conference_id }}"
                                                   {% if conference.settings.gallery_enabled|default(true) %}checked{% endif %}
                                                   id="gallery-toggle-{{ conference_id }}">
                                            <label class="form-check-label" for="gallery-toggle-{{ conference_id }}">
                                                <small class="gallery-status-text">
                                                    {% if conference.settings.gallery_enabled|default(true) %}
                                                    <span class="badge bg-success">Public</span>
                                                    {% else %}
                                                    <span class="badge bg-secondary">Private</span>
                                                    {% endif %}
                                                </small>
                                            </label>
                                        </div>
                                    </div>

                                    <div class="d-flex gap-2">
                                        <button class="btn btn-primary btn-sm manage-gallery"
                                                data-conference-id="{{ conference_id }}"
                                                {% if not conference.settings.gallery_enabled|default(true) %}disabled{% endif %}>
                                            <i class="fas fa-images me-1"></i>
                                            Manage Gallery
                                        </button>
                                        <a href="{{ url_for('manage_attendee_gallery', conference_id=conference_id) }}" class="btn btn-info btn-sm">
                                            <i class="fas fa-users me-1"></i>
                                            Manage Attendees
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Gallery Management Area -->
            <div id="gallery-management" class="card" style="display: none;">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-images me-2"></i>
                        <span id="gallery-title">Gallery Management</span>
                    </h5>
                    <button class="btn btn-secondary btn-sm" id="back-to-conferences" style="display: none;">
                        <i class="fas fa-arrow-left me-1"></i>
                        Back to Conferences
                    </button>
                </div>
                <div class="card-body">
                    <!-- Upload Area -->
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <div class="upload-area" id="upload-area">
                                <div class="upload-content">
                                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                    <h5>Upload Conference Images</h5>
                                    <p class="text-muted">Drag and drop images here or click to browse</p>
                                    <input type="file" id="gallery-upload" multiple accept="image/*" style="display: none;">
                                    <button class="btn btn-primary" id="browse-btn">
                                        <i class="fas fa-folder-open me-1"></i>
                                        Browse Files
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6><i class="fas fa-info-circle me-1"></i>Upload Guidelines</h6>
                                    <ul class="small mb-0">
                                        <li>Supported formats: JPG, PNG, GIF, WebP</li>
                                        <li>Images will be optimized automatically</li>
                                        <li>Multiple images can be uploaded at once</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Upload Progress -->
                    <div id="upload-progress" class="alert alert-info" style="display: none;">
                        <i class="fas fa-spinner fa-spin me-2"></i>
                        <span id="upload-status">Uploading images...</span>
                    </div>

                    <!-- Gallery Summary Management -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <i class="fas fa-align-left me-2"></i>
                                    Gallery Summary & Description
                                </h6>
                                <button class="btn btn-sm btn-outline-primary" type="button" 
                                        data-bs-toggle="collapse" data-bs-target="#summary-collapse">
                                    <i class="fas fa-chevron-down me-1"></i>
                                    <span class="summary-toggle-text">Expand</span>
                                </button>
                            </div>
                        </div>
                        <div class="collapse" id="summary-collapse">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-lg-8">
                                        <form id="gallery-summary-form">
                                            <!-- Summary Field -->
                                            <div class="mb-3">
                                                <label for="gallery-summary" class="form-label">
                                                    <i class="fas fa-edit me-1"></i>
                                                    Gallery Summary
                                                    <small class="text-muted">(Brief overview for the public gallery)</small>
                                                </label>
                                                <div class="position-relative">
                                                    <textarea class="form-control" 
                                                              id="gallery-summary" 
                                                              name="summary"
                                                              rows="3" 
                                                              maxlength="500"
                                                              placeholder="Enter a brief summary of this conference gallery..."></textarea>
                                                    <div class="character-counter">
                                                        <small class="text-muted">
                                                            <span id="summary-char-count">0</span>/500 characters
                                                        </small>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Description Field -->
                                            <div class="mb-3">
                                                <label for="gallery-description" class="form-label">
                                                    <i class="fas fa-align-left me-1"></i>
                                                    Detailed Description
                                                    <small class="text-muted">(Optional rich text description)</small>
                                                </label>
                                                <textarea class="form-control" 
                                                          id="gallery-description" 
                                                          name="description"
                                                          rows="5"
                                                          placeholder="Add a detailed description of the conference, highlights, key moments, etc..."></textarea>
                                            </div>

                                            <!-- Visibility Toggles -->
                                            <div class="mb-3">
                                                <label class="form-label">
                                                    <i class="fas fa-eye me-1"></i>
                                                    Public Visibility
                                                </label>
                                                
                                                <!-- Summary Toggle -->
                                                <div class="form-check form-switch mb-2">
                                                    <input class="form-check-input" 
                                                           type="checkbox" 
                                                           id="show-summary-public" 
                                                           name="show_summary_public"
                                                           checked>
                                                    <label class="form-check-label" for="show-summary-public">
                                                        Show Gallery Summary to Public
                                                        <small class="text-muted d-block">
                                                            Display the summary on the public galleries page
                                                        </small>
                                                    </label>
                                                </div>
                                                
                                                <!-- Description Toggle -->
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" 
                                                           type="checkbox" 
                                                           id="show-description-public" 
                                                           name="show_description_public"
                                                           checked>
                                                    <label class="form-check-label" for="show-description-public">
                                                        Show Description to Public
                                                        <small class="text-muted d-block">
                                                            Display the detailed description on the public galleries page
                                                        </small>
                                                    </label>
                                                </div>
                                            </div>

                                            <!-- Action Buttons -->
                                            <div class="d-flex gap-2">
                                                <button type="submit" class="btn btn-success" id="save-summary-btn">
                                                    <i class="fas fa-save me-1"></i>
                                                    Save Summary
                                                </button>
                                                <button type="button" class="btn btn-secondary" id="clear-summary-btn">
                                                    <i class="fas fa-times me-1"></i>
                                                    Clear
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                    <div class="col-lg-4">
                                        <div class="card bg-light h-100">
                                            <div class="card-body">
                                                <h6>
                                                    <i class="fas fa-lightbulb me-1"></i>
                                                    Summary Guidelines
                                                </h6>
                                                <ul class="small mb-3">
                                                    <li><strong>Summary:</strong> Short, engaging overview (max 200 chars)</li>
                                                    <li><strong>Description:</strong> Rich details about the conference</li>
                                                    <li>Highlight key moments, speakers, or themes</li>
                                                    <li>Use descriptive language to engage visitors</li>
                                                </ul>
                                                
                                                <div class="alert alert-info small p-2 mb-0">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    <strong>Tip:</strong> A good summary helps visitors understand what to expect from your gallery before viewing images.
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Save Status -->
                                <div id="summary-save-status" class="mt-3" style="display: none;">
                                    <!-- Status messages will appear here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Gallery Summary & Description Display -->
                    <div id="gallery-summary-display" class="mb-4" style="display: none;">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Gallery Summary & Description
                                </h6>
                            </div>
                            <div class="card-body">
                                <div id="gallery-summary-content">
                                    <p class="text-muted mb-2">
                                        <strong>Summary:</strong>
                                        <span id="display-gallery-summary">No summary available</span>
                                    </p>
                                    <div id="gallery-description-content" style="display: none;">
                                        <hr>
                                        <p class="text-muted mb-0">
                                            <strong>Description:</strong>
                                        </p>
                                        <div id="display-gallery-description" class="mt-2"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Gallery Grid -->
                    <div id="gallery-grid" class="row">
                        <!-- Images will be loaded here -->
                    </div>

                    <!-- Empty State -->
                    <div id="empty-gallery" class="text-center py-5" style="display: none;">
                        <i class="fas fa-images fa-4x text-muted mb-3"></i>
                        <h5>No Images Yet</h5>
                        <p class="text-muted">Upload some images to get started with this conference gallery.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Image Preview Modal -->
<div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalTitle">Image Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modal-image" src="" alt="Gallery Image" class="img-fluid">
                <p class="mt-3 text-muted" id="image-caption"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<style>
.conference-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    cursor: pointer;
}

.conference-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.upload-area {
    border: 2px dashed #dee2e6;
    border-radius: 10px;
    padding: 3rem 2rem;
    text-align: center;
    background-color: #f8f9fa;
    transition: all 0.3s ease;
}

.upload-area:hover,
.upload-area.dragover {
    border-color: var(--primary-color);
    background-color: rgba(var(--primary-color-rgb), 0.05);
}

.upload-area.dragover {
    background-color: rgba(var(--primary-color-rgb), 0.1);
}

.gallery-item {
    position: relative;
    margin-bottom: 1.5rem;
}

.gallery-image {
    width: 100%;
    height: 200px;
    object-fit: cover;
    border-radius: 8px;
    cursor: pointer;
    transition: transform 0.2s ease;
}

.gallery-image:hover {
    transform: scale(1.05);
}

.image-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.2s ease;
    border-radius: 8px;
}

.gallery-item:hover .image-overlay {
    opacity: 1;
}

.image-actions {
    display: flex;
    gap: 0.5rem;
}

.btn-icon {
    width: 32px;
    height: 32px;
    padding: 0;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.image-info {
    background: white;
    padding: 0.5rem;
    border-radius: 0 0 8px 8px;
    font-size: 0.875rem;
}

.image-info .badge {
    font-size: 0.75rem;
}

.progress {
    height: 8px;
    margin-top: 0.5rem;
}

@media (max-width: 768px) {
    .gallery-image {
        height: 150px;
    }

    .upload-area {
        padding: 2rem 1rem;
    }
}

/* Gallery Visibility Toggle Styling */
.gallery-status-text {
    font-weight: 600;
    min-width: 60px;
    display: inline-block;
}

.gallery-toggle {
    cursor: pointer;
}

.conference-card.disabled {
    opacity: 0.6;
    pointer-events: none;
}

/* Gallery visibility toggle animation */
.form-check-input:checked {
    background-color: #28a745;
    border-color: #28a745;
}

.form-check-input:focus {
    border-color: #86b7fe;
    outline: 0;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

/* Gallery Summary Display Styling */
#gallery-summary-display {
    animation: fadeIn 0.3s ease-in;
}

#gallery-summary-display .card-body {
    padding: 1.25rem;
}

#display-gallery-summary {
    font-style: italic;
    color: #495057;
    line-height: 1.6;
}

#display-gallery-description {
    color: #495057;
    line-height: 1.6;
    padding: 0.5rem 0;
}

#display-gallery-description p {
    margin-bottom: 0.5rem;
}

#display-gallery-description p:last-child {
    margin-bottom: 0;
}

#display-gallery-description ul,
#display-gallery-description ol {
    margin-left: 1.5rem;
    margin-bottom: 0.5rem;
}

#display-gallery-description a {
    color: #0d6efd;
    text-decoration: none;
}

#display-gallery-description a:hover {
    text-decoration: underline;
}

/* Conference card hover effects */
.conference-card {
    transition: all 0.3s ease;
}

.conference-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

/* Gallery status badges */
.badge.bg-success {
    background-color: #28a745 !important;
}

.badge.bg-secondary {
    background-color: #6c757d !important;
}

/* Gallery Summary Management Styles */
.character-counter {
    position: absolute;
    bottom: 8px;
    right: 12px;
    background: rgba(255, 255, 255, 0.9);
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 11px;
}

#gallery-summary {
    padding-bottom: 25px; /* Make room for character counter */
}

.summary-toggle-text {
    transition: all 0.2s ease;
}

#summary-collapse.show ~ .card-header .summary-toggle-text::after {
    content: " - Collapse";
}

#summary-collapse:not(.show) ~ .card-header .summary-toggle-text::after {
    content: " - Expand";
}

.gallery-summary-form {
    transition: all 0.3s ease;
}

#summary-save-status .alert {
    margin-bottom: 0;
    animation: slideDown 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* TinyMCE styling for description */
.tox-tinymce {
    border-radius: 6px !important;
    border: 1px solid #ced4da !important;
}

.tox-tinymce:focus-within {
    border-color: #86b7fe !important;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25) !important;
}

/* Summary card animation */
.card:has(#summary-collapse) {
    transition: all 0.2s ease;
}

.card:has(#summary-collapse.show) {
    border-color: #0d6efd;
    box-shadow: 0 2px 8px rgba(13, 110, 253, 0.15);
}
</style>

<!-- jQuery CDN (Full version for AJAX support) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
let currentConferenceId = null;
let currentConferenceName = '';

// Test if jQuery is loaded
if (typeof $ === 'undefined') {
    console.error('jQuery is not loaded! Check CDN links.');
} else {
    console.log('‚úÖ jQuery loaded successfully');
}

$(document).ready(function() {
    // Gallery visibility toggle
    $('.gallery-toggle').change(function() {
        const conferenceId = $(this).data('conference-id');
        const isEnabled = $(this).is(':checked');
        const statusText = $(this).closest('.conference-card').find('.gallery-status-text');
        const manageButton = $(this).closest('.conference-card').find('.manage-gallery');

        console.log('Gallery visibility toggle for conference:', conferenceId, 'Enabled:', isEnabled);

        // Update UI immediately
        if (isEnabled) {
            statusText.html('<span class="badge bg-success">Public</span>');
            manageButton.prop('disabled', false);
        } else {
            statusText.html('<span class="badge bg-secondary">Private</span>');
            manageButton.prop('disabled', true);
        }

        // Send update to backend
        $.ajax({
            url: `/admin/conference-galleries/${conferenceId}/toggle-visibility`,
            type: 'POST',
            data: { enabled: isEnabled },
            success: function(response) {
                if (response.success) {
                    console.log('Gallery visibility updated successfully');
                } else {
                    console.error('Failed to update gallery visibility:', response.error);
                    // Revert UI change on error
                    $(`#gallery-toggle-${conferenceId}`).prop('checked', !isEnabled);
                    if (isEnabled) {
                        statusText.html('<span class="badge bg-secondary">Private</span>');
                        manageButton.prop('disabled', true);
                    } else {
                        statusText.html('<span class="badge bg-success">Public</span>');
                        manageButton.prop('disabled', false);
                    }
                }
            },
            error: function(xhr, status, error) {
                console.error('Error updating gallery visibility:', error);
                // Revert UI change on error
                $(`#gallery-toggle-${conferenceId}`).prop('checked', !isEnabled);
                if (isEnabled) {
                    statusText.html('<span class="badge bg-secondary">Private</span>');
                    manageButton.prop('disabled', true);
                } else {
                    statusText.html('<span class="badge bg-success">Public</span>');
                    manageButton.prop('disabled', false);
                }
            }
        });
    });

    // Conference selection - Manage Gallery buttons
    $('.manage-gallery').click(function(e) {
        e.preventDefault();
        e.stopPropagation();

        currentConferenceId = $(this).data('conference-id');
        const conferenceCard = $(this).closest('.conference-card');
        currentConferenceName = conferenceCard.find('.card-title').text().trim();

        console.log('Manage Gallery button clicked');
        console.log('Conference ID:', currentConferenceId);
        console.log('Conference Name:', currentConferenceName);
        console.log('Gallery management element exists:', $('#gallery-management').length > 0);
        console.log('Back button exists:', $('#back-to-conferences').length > 0);

        console.log('Gallery management should now be visible');
        console.log('Gallery management display status:', $('#gallery-management').css('display'));
        console.log('Back button display status:', $('#back-to-conferences').css('display'));

        $('#gallery-title').text(`${currentConferenceName} Gallery`);
        $('#gallery-management').show();
        $('#back-to-conferences').show();
        
        // Hide summary display initially (will show after loading)
        $('#gallery-summary-display').hide();

        console.log('Loading gallery for conference:', currentConferenceId, currentConferenceName);

        // Load existing images and summary
        loadGalleryImages();
        loadGallerySummary(currentConferenceId);

        // Scroll to gallery management
        $('html, body').animate({
            scrollTop: $('#gallery-management').offset().top - 20
        }, 500);
    });

    // Back to conferences
    $('#back-to-conferences').click(function() {
        $('#gallery-management').hide();
        $('#back-to-conferences').hide();
        $('#gallery-summary-display').hide();
        $('html, body').animate({
            scrollTop: $('.card:first').offset().top - 20
        }, 500);
    });

    // File upload handling
    const uploadArea = $('#upload-area');
    const fileInput = $('#gallery-upload');
    const browseBtn = $('#browse-btn');

    browseBtn.click(function() {
        fileInput.click();
    });

    // Drag and drop
    uploadArea.on('dragover', function(e) {
        e.preventDefault();
        e.stopPropagation();
        $(this).addClass('dragover');
    });

    uploadArea.on('dragleave', function(e) {
        e.preventDefault();
        e.stopPropagation();
        $(this).removeClass('dragover');
    });

    uploadArea.on('drop', function(e) {
        e.preventDefault();
        e.stopPropagation();
        $(this).removeClass('dragover');

        const files = e.originalEvent.dataTransfer.files;
        if (files.length > 0) {
            uploadImages(files);
        }
    });

    fileInput.change(function() {
        const files = this.files;
        if (files.length > 0) {
            uploadImages(files);
        }
    });

    // Upload images function
    function uploadImages(files) {
        console.log('üöÄ Starting upload for', files.length, 'file(s):');
        for (let i = 0; i < files.length; i++) {
            console.log(`üìÅ File ${i+1}: ${files[i].name} (${files[i].size} bytes)`);
        }

        const formData = new FormData();

        for (let i = 0; i < files.length; i++) {
            formData.append('image', files[i]);
        }

        $('#upload-progress').show();
        $('#upload-status').text(`Uploading ${files.length} image(s)...`);

        $.ajax({
            url: `/admin/conference-galleries/${currentConferenceId}/upload`,
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                console.log('üìä Upload response:', response);
                if (response.success) {
                    $('#upload-progress').removeClass('alert-info').addClass('alert-success');
                    $('#upload-status').html('<i class="fas fa-check me-1"></i>Upload completed successfully!');
                    loadGalleryImages();
                } else {
                    console.error('‚ùå Upload failed:', response.error);
                    $('#upload-progress').removeClass('alert-info').addClass('alert-danger');
                    $('#upload-status').html('<i class="fas fa-times me-1"></i>Error: ' + response.error);
                }

                setTimeout(function() {
                    $('#upload-progress').hide().removeClass('alert-success alert-danger').addClass('alert-info');
                }, 3000);
            },
            error: function(xhr, status, error) {
                console.error('‚ùå AJAX error:', {xhr, status, error});
                $('#upload-progress').removeClass('alert-info').addClass('alert-danger');
                $('#upload-status').html('<i class="fas fa-times me-1"></i>Upload failed: ' + error);
                setTimeout(function() {
                    $('#upload-progress').hide().addClass('alert-info').removeClass('alert-danger');
                }, 5000);
            }
        });
    }

    // Gallery Summary Management
    
    // Character counter for summary
    $('#gallery-summary').on('input', function() {
        const currentLength = $(this).val().length;
        const maxLength = 500;
        $('#summary-char-count').text(currentLength);
        
        // Change color when approaching limit
        const counter = $(this).siblings('.character-counter').find('#summary-char-count');
        if (currentLength > maxLength * 0.9) {
            counter.addClass('text-warning');
        } else {
            counter.removeClass('text-warning');
        }
        
        if (currentLength >= maxLength) {
            counter.addClass('text-danger').removeClass('text-warning');
        } else {
            counter.removeClass('text-danger');
        }
    });

    // Summary form submission
    $('#gallery-summary-form').on('submit', function(e) {
        e.preventDefault();
        
        if (!currentConferenceId) {
            showSummaryStatus('danger', 'Please select a conference first.');
            return;
        }

        const formData = {
            summary: $('#gallery-summary').val().trim(),
            description: $('#gallery-description').val().trim(),
            show_summary_public: $('#show-summary-public').is(':checked'),
            show_description_public: $('#show-description-public').is(':checked')
        };

        // Show saving status
        const saveBtn = $('#save-summary-btn');
        const originalText = saveBtn.html();
        saveBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>Saving...');

        $.ajax({
            url: `/admin/conference-galleries/${currentConferenceId}/summary`,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function(response) {
                if (response.success) {
                    showSummaryStatus('success', 'Gallery summary saved successfully!');
                    // Update the display section
                    const summary = formData.summary;
                    const description = formData.description;
                    
                    if (summary) {
                        $('#display-gallery-summary').text(summary);
                    } else {
                        $('#display-gallery-summary').text('No summary available');
                    }
                    
                    if (description) {
                        $('#display-gallery-description').html(description);
                        $('#gallery-description-content').show();
                    } else {
                        $('#display-gallery-description').html('');
                        $('#gallery-description-content').hide();
                    }
                    
                    // Show display section if there's any content
                    if (summary || description) {
                        $('#gallery-summary-display').show();
                    }
                } else {
                    showSummaryStatus('danger', response.error || 'Failed to save summary.');
                }
            },
            error: function(xhr, status, error) {
                console.error('Error saving summary:', error);
                showSummaryStatus('danger', 'Failed to save summary. Please try again.');
            },
            complete: function() {
                saveBtn.prop('disabled', false).html(originalText);
            }
        });
    });

    // Clear summary button
    $('#clear-summary-btn').on('click', function() {
        if (confirm('Are you sure you want to clear all summary content?')) {
            $('#gallery-summary').val('');
            $('#gallery-description').val('');
            $('#summary-char-count').text('0');
            $('#summary-char-count').removeClass('text-warning text-danger');
            
            if (typeof tinymce !== 'undefined') {
                tinymce.get('gallery-description')?.setContent('');
            }
        }
    });

    // Summary status display function
    function showSummaryStatus(type, message) {
        const statusDiv = $('#summary-save-status');
        statusDiv.html(`
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-1"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `).show();

        // Auto-hide success messages after 3 seconds
        if (type === 'success') {
            setTimeout(function() {
                statusDiv.find('.alert').fadeOut();
            }, 3000);
        }
    }

    // Load existing summary when gallery is selected
    function loadGallerySummary(conferenceId) {
        $.get(`/admin/conference-galleries/${conferenceId}/summary`)
            .done(function(data) {
                if (data.summary) {
                    $('#gallery-summary').val(data.summary);
                    $('#summary-char-count').text(data.summary.length);
                    // Display summary
                    $('#display-gallery-summary').text(data.summary);
                } else {
                    $('#display-gallery-summary').text('No summary available');
                }
                
                if (data.description) {
                    $('#gallery-description').val(data.description);
                    
                    // Update TinyMCE if it's initialized
                    if (typeof tinymce !== 'undefined') {
                        const editor = tinymce.get('gallery-description');
                        if (editor) {
                            editor.setContent(data.description);
                        }
                    }
                    
                    // Display description
                    $('#display-gallery-description').html(data.description);
                    $('#gallery-description-content').show();
                } else {
                    $('#display-gallery-description').html('');
                    $('#gallery-description-content').hide();
                }
                
                // Show the display section if there's any content
                if (data.summary || data.description) {
                    $('#gallery-summary-display').show();
                }
                
                // Set visibility toggle states (default to true if not set for backward compatibility)
                const showSummaryPublic = data.show_summary_public !== undefined ? data.show_summary_public : (data.show_public !== undefined ? data.show_public : true);
                const showDescriptionPublic = data.show_description_public !== undefined ? data.show_description_public : (data.show_public !== undefined ? data.show_public : true);
                $('#show-summary-public').prop('checked', showSummaryPublic);
                $('#show-description-public').prop('checked', showDescriptionPublic);
            })
            .fail(function(xhr) {
                if (xhr.status !== 404) { // 404 is expected for new galleries
                    console.warn('Could not load gallery summary:', xhr.responseText);
                }
                // Hide display section if loading fails
                $('#gallery-summary-display').hide();
            });
    }

    // Toggle text for summary collapse
    $('#summary-collapse').on('show.bs.collapse', function() {
        $('.summary-toggle-text').text('Collapse');
    }).on('hide.bs.collapse', function() {
        $('.summary-toggle-text').text('Expand');
    });

    // Load gallery images
    function loadGalleryImages() {
        $.get(`/admin/conference-galleries/${currentConferenceId}/images`)
            .done(function(images) {
                const galleryGrid = $('#gallery-grid');
                const emptyState = $('#empty-gallery');

                if (images.length === 0) {
                    galleryGrid.hide();
                    emptyState.show();
                    return;
                }

                galleryGrid.show();
                emptyState.hide();

                let html = '';
                images.forEach(function(image) {
                    const uploadDate = new Date(image.uploaded_at).toLocaleDateString();
                    html += `
                        <div class="col-md-4 col-lg-3">
                            <div class="gallery-item">
                                <div class="position-relative">
                                    <img src="${image.url}" alt="${image.original_name}" class="gallery-image" data-image-id="${image.image_id}">
                                    <div class="image-overlay">
                                        <div class="image-actions">
                                            <button class="btn btn-light btn-icon view-image" data-url="${image.url}" data-caption="${image.original_name}" title="View Full Size">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-danger btn-icon delete-image" data-image-id="${image.image_id}" title="Delete Image">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="image-info">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-truncate" title="${image.original_name}">${image.original_name}</small>
                                        <span class="badge bg-secondary">${uploadDate}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                galleryGrid.html(html);
            })
            .fail(function(xhr, status, error) {
                console.error('Error loading gallery images:', error);
                $('#gallery-grid').html('<div class="col-12"><div class="alert alert-danger">Error loading gallery images</div></div>');
            });
    }

    // View image modal
    $(document).on('click', '.view-image', function() {
        const url = $(this).data('url');
        const caption = $(this).data('caption');

        $('#modal-image').attr('src', url);
        $('#image-caption').text(caption);
        const modal = new bootstrap.Modal(document.getElementById('imageModal'));
        modal.show();
    });

    // Delete image
    $(document).on('click', '.delete-image', function() {
        const imageId = $(this).data('image-id');
        const galleryItem = $(this).closest('.gallery-item');

        if (confirm('Are you sure you want to delete this image?')) {
            $.ajax({
                url: `/admin/conference-galleries/${currentConferenceId}/images/${imageId}`,
                type: 'DELETE',
                success: function(response) {
                    if (response.success) {
                        galleryItem.fadeOut(function() {
                            $(this).remove();
                            // Check if gallery is now empty
                            if ($('#gallery-grid .gallery-item').length === 0) {
                                $('#gallery-grid').hide();
                                $('#empty-gallery').show();
                            }
                        });
                    } else {
                        alert('Error deleting image: ' + response.error);
                    }
                },
                error: function(xhr, status, error) {
                    alert('Error deleting image: ' + error);
                }
            });
        }
    });

    // Initialize TinyMCE for gallery description
    if (typeof tinymce !== 'undefined') {
        tinymce.init({
            selector: '#gallery-description',
            height: 200,
            menubar: false,
            api_key: '{{ tinymce_api_key or "no-api-key" }}',
            plugins: [
                'advlist', 'autolink', 'lists', 'link', 'image', 'charmap', 'preview',
                'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
                'insertdatetime', 'media', 'table', 'help', 'wordcount'
            ],
            toolbar: 'undo redo | blocks | bold italic | alignleft aligncenter alignright | bullist numlist outdent indent | link | code preview',
            content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; font-size: 14px; }',
            placeholder: 'Add a detailed description of the conference, highlights, key moments, etc...',
            setup: function(editor) {
                editor.on('change', function() {
                    editor.save(); // Save content back to textarea
                });
            }
        });
    } else {
        // Fallback: Load TinyMCE if not already loaded
        const script = document.createElement('script');
        script.src = 'https://cdn.tiny.cloud/1/{{ tinymce_api_key or "no-api-key" }}/tinymce/6/tinymce.min.js';
        script.referrerPolicy = 'origin';
        script.onload = function() {
            // Initialize after loading
            tinymce.init({
                selector: '#gallery-description',
                height: 200,
                menubar: false,
                api_key: '{{ tinymce_api_key or "no-api-key" }}',
                plugins: [
                    'advlist', 'autolink', 'lists', 'link', 'charmap', 'preview',
                    'searchreplace', 'visualblocks', 'code', 'fullscreen',
                    'insertdatetime', 'wordcount'
                ],
                toolbar: 'undo redo | blocks | bold italic | alignleft aligncenter alignright | bullist numlist outdent indent | link | code preview',
                content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; font-size: 14px; }',
                placeholder: 'Add a detailed description of the conference, highlights, key moments, etc...'
            });
        };
        document.head.appendChild(script);
    }
});
</script>
{% endblock %}
