{% extends "base.html" %}

{% block title %}Manage Registrations - Admin{% endblock %}

{% block content %}
<div class="admin-dashboard">
    <div class="dashboard-header">
        <div class="header-content">
            <h1><i class="fas fa-clipboard-list"></i> Manage Registrations</h1>
            <p>View and manage conference registrations</p>
        </div>
        <div class="quick-actions">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Search registrations...">
            </div>
            <select id="filterStatus" class="filter-select">
                <option value="all">All Status</option>
                <option value="pending">Pending</option>
                <option value="approved">Approved</option>
                <option value="rejected">Rejected</option>
            </select>
        </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} fade-in">
                    {{ message }}
                    <button type="button" class="close-alert" onclick="this.parentElement.remove();">Ã—</button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="stats-overview">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-details">
                <h3>Total Registrations</h3>
                <p class="stat-number">{{ registrations|length }}</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="color: #28a745;">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-details">
                <h3>Approved</h3>
                <p class="stat-number">{{ registrations|selectattr('payment_status', 'equalto', 'approved')|list|length }}</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="color: #ffc107;">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stat-details">
                <h3>Pending</h3>
                <p class="stat-number">{{ registrations|selectattr('payment_status', 'equalto', 'pending')|list|length }}</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="color: #dc3545;">
                <i class="fas fa-times-circle"></i>
            </div>
            <div class="stat-details">
                <h3>Rejected</h3>
                <p class="stat-number">{{ registrations|selectattr('payment_status', 'equalto', 'rejected')|list|length }}</p>
            </div>
        </div>
    </div>

    <div class="content-section">
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Type</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if registrations %}
                        {% for id, registration in registrations.items() %}
                        <tr class="registration-row" data-status="{{ registration.payment_status }}">
                            <td>{{ registration.full_name }}</td>
                            <td>{{ registration.email }}</td>
                            <td>{{ registration.registration_type|title }}</td>
                            <td>${{ registration.total_amount }}</td>
                            <td>
                                <span class="status-badge status-{{ registration.payment_status }}">
                                    {{ registration.payment_status|title }}
                                </span>
                            </td>
                            <td>{{ registration.created_at|datetime }}</td>
                            <td class="actions">
                                <button class="btn-icon" onclick="viewDetails('{{ id }}')" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                {% if registration.payment_status == 'pending' %}
                                <button class="btn-icon approve" onclick="updateStatus('{{ id }}', 'approved')" title="Approve">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="btn-icon reject" onclick="updateStatus('{{ id }}', 'rejected')" title="Reject">
                                    <i class="fas fa-times"></i>
                                </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="7" class="no-data">No registrations found</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Registration Details Modal -->
<div id="detailsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Registration Details</h2>
            <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
            <div class="details-grid">
                <div class="detail-group">
                    <label>Full Name</label>
                    <p id="modalName"></p>
                </div>
                <div class="detail-group">
                    <label>Email</label>
                    <p id="modalEmail"></p>
                </div>
                <div class="detail-group">
                    <label>Registration Type</label>
                    <p id="modalType"></p>
                </div>
                <div class="detail-group">
                    <label>Amount</label>
                    <p id="modalAmount"></p>
                </div>
                <div class="detail-group">
                    <label>Status</label>
                    <p id="modalStatus"></p>
                </div>
                <div class="detail-group">
                    <label>Date</label>
                    <p id="modalDate"></p>
                </div>
                <div class="detail-group full-width">
                    <label>Additional Notes</label>
                    <p id="modalNotes"></p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Existing admin dashboard styles */

.search-box {
    position: relative;
    margin-right: 1rem;
}

.search-box input {
    padding: 0.5rem 1rem 0.5rem 2.5rem;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 0.9rem;
    width: 250px;
}

.search-box i {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: #666;
}

.filter-select {
    padding: 0.5rem 1rem;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 0.9rem;
    color: #333;
    background-color: white;
}

.table-container {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    overflow: hidden;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th,
.data-table td {
    padding: 1rem;
    text-align: left;
    border-bottom: 1px solid #eee;
}

.data-table th {
    background: #f8f9fa;
    font-weight: 600;
    color: #333;
}

.data-table tr:hover {
    background: #f8f9fa;
}

.status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 50px;
    font-size: 0.875rem;
    font-weight: 500;
}

.status-pending {
    background: #fff3cd;
    color: #856404;
}

.status-approved {
    background: #d4edda;
    color: #155724;
}

.status-rejected {
    background: #f8d7da;
    color: #721c24;
}

.actions {
    display: flex;
    gap: 0.5rem;
}

.btn-icon {
    width: 32px;
    height: 32px;
    border: none;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    background: #f8f9fa;
}

.btn-icon:hover {
    transform: translateY(-2px);
}

.btn-icon.approve {
    color: #28a745;
}

.btn-icon.approve:hover {
    background: #28a745;
    color: white;
}

.btn-icon.reject {
    color: #dc3545;
}

.btn-icon.reject:hover {
    background: #dc3545;
    color: white;
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
}

.modal-content {
    position: relative;
    background: white;
    width: 90%;
    max-width: 600px;
    margin: 2rem auto;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h2 {
    margin: 0;
    color: #333;
}

.close-modal {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #666;
}

.modal-body {
    padding: 1.5rem;
}

.details-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
}

.detail-group {
    display: flex;
    flex-direction: column;
}

.detail-group.full-width {
    grid-column: 1 / -1;
}

.detail-group label {
    color: #666;
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
}

.detail-group p {
    color: #333;
    font-size: 1rem;
    margin: 0;
}

.no-data {
    text-align: center;
    color: #666;
    padding: 2rem;
}

@media (max-width: 768px) {
    .quick-actions {
        flex-direction: column;
        gap: 1rem;
    }

    .search-box {
        margin-right: 0;
        width: 100%;
    }

    .search-box input {
        width: 100%;
    }

    .filter-select {
        width: 100%;
    }

    .details-grid {
        grid-template-columns: 1fr;
    }

    .data-table {
        display: block;
        overflow-x: auto;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Search functionality
    const searchInput = document.getElementById('searchInput');
    searchInput.addEventListener('input', filterRegistrations);

    // Status filter
    const filterStatus = document.getElementById('filterStatus');
    filterStatus.addEventListener('change', filterRegistrations);

    // Initialize animations
    const elements = document.querySelectorAll('.stat-card, .registration-row');
    elements.forEach((element, index) => {
        element.style.animation = `fadeIn 0.3s ease forwards ${index * 0.1}s`;
        element.style.opacity = '0';
    });
});

function filterRegistrations() {
    const searchTerm = searchInput.value.toLowerCase();
    const statusFilter = filterStatus.value;
    const rows = document.querySelectorAll('.registration-row');

    rows.forEach(row => {
        const name = row.children[0].textContent.toLowerCase();
        const email = row.children[1].textContent.toLowerCase();
        const status = row.dataset.status;
        
        const matchesSearch = name.includes(searchTerm) || email.includes(searchTerm);
        const matchesStatus = statusFilter === 'all' || status === statusFilter;

        row.style.display = matchesSearch && matchesStatus ? '' : 'none';
    });
}

function viewDetails(id) {
    const registration = registrations[id];
    if (registration) {
        document.getElementById('modalName').textContent = registration.full_name;
        document.getElementById('modalEmail').textContent = registration.email;
        document.getElementById('modalType').textContent = registration.registration_type;
        document.getElementById('modalAmount').textContent = `$${registration.total_amount}`;
        document.getElementById('modalStatus').textContent = registration.payment_status;
        document.getElementById('modalDate').textContent = new Date(registration.created_at).toLocaleDateString();
        document.getElementById('modalNotes').textContent = registration.notes || 'No additional notes';
        
        const modal = document.getElementById('detailsModal');
        modal.style.display = 'block';
    }
}

function updateStatus(id, status) {
    if (confirm(`Are you sure you want to ${status} this registration?`)) {
        fetch(`/admin/registrations/${id}/status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ status: status })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error updating status');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating status');
        });
    }
}

// Modal close functionality
document.querySelector('.close-modal').addEventListener('click', () => {
    document.getElementById('detailsModal').style.display = 'none';
});

window.onclick = function(event) {
    const modal = document.getElementById('detailsModal');
    if (event.target == modal) {
        modal.style.display = 'none';
    }
}
</script>
{% endblock %} 