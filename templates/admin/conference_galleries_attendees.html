{% extends "admin/base_admin.html" %}

{% block title %}Attendee Gallery Management - {{ conference.basic_info.name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0 text-gray-800">
                        <i class="fas fa-users me-2"></i>
                        Attendee Gallery - {{ conference.basic_info.name }}
                    </h1>
                    <p class="text-muted">Manage featured attendees and their information in the conference gallery</p>
                </div>
                <div>
                    <a href="{{ url_for('admin_conference_galleries') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-1"></i>
                        Back to Galleries
                    </a>
                </div>
            </div>

            <!-- Gallery Statistics -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <h3 class="mb-1">{{ featured_attendees|length }}</h3>
                            <p class="mb-0">Featured Attendees</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body text-center">
                            <h3 class="mb-1">{{ available_attendees|length }}</h3>
                            <p class="mb-0">Available Attendees</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <h3 class="mb-1">{{ (featured_attendees.values()|selectattr('photo_url')|list|length) }}</h3>
                            <p class="mb-0">With Photos</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body text-center">
                            <h3 class="mb-1">{{ (featured_attendees.values()|selectattr('institution')|list|length) }}</h3>
                            <p class="mb-0">With Affiliations</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Featured Attendees Section -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-star me-2"></i>
                        Featured Attendees
                    </h5>
                    <span class="badge bg-primary">{{ featured_attendees|length }} attendees</span>
                </div>
                <div class="card-body">
                    {% if featured_attendees %}
                    <div class="row">
                        {% for attendee_id, attendee in featured_attendees.items() %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card attendee-card">
                                <div class="card-body">
                                    <div class="d-flex align-items-start">
                                        <!-- Attendee Photo -->
                                        <div class="attendee-photo me-3">
                                            {% if attendee.photo_url %}
                                            <img src="{{ attendee.photo_url }}" alt="{{ attendee.full_name }}" class="img-thumbnail" style="width: 60px; height: 60px; object-fit: cover;">
                                            {% else %}
                                            <div class="bg-light d-flex align-items-center justify-content-center" style="width: 60px; height: 60px; border-radius: 8px;">
                                                <i class="fas fa-user fa-lg text-muted"></i>
                                            </div>
                                            {% endif %}
                                        </div>

                                        <!-- Attendee Info -->
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1">{{ attendee.full_name }}</h6>
                                            {% if attendee.institution %}
                                            <p class="mb-1 small text-muted">{{ attendee.institution }}</p>
                                            {% endif %}
                                            {% if attendee.title %}
                                            <p class="mb-1 small">{{ attendee.title }}</p>
                                            {% endif %}
                                            {% if attendee.country %}
                                            <p class="mb-0 small text-muted">
                                                <i class="fas fa-map-marker-alt me-1"></i>
                                                {{ attendee.city }}{% if attendee.city and attendee.country %}, {% endif %}{{ attendee.country }}
                                            </p>
                                            {% endif %}
                                        </div>

                                        <!-- Actions -->
                                        <div class="ms-2 d-flex gap-1">
                                            <button class="btn btn-sm btn-outline-primary" onclick="editAttendee('{{ attendee_id }}', '{{ attendee.user_id }}')" title="Edit Attendee Info">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-info" onclick="uploadAttendeePhoto('{{ attendee_id }}', '{{ attendee.user_id }}')" title="Upload Photo">
                                                <i class="fas fa-camera"></i>
                                            </button>
                                            {% if attendee.photo_url %}
                                            <button class="btn btn-sm btn-outline-warning" onclick="deleteAttendeePhoto('{{ attendee_id }}', '{{ attendee.user_id }}')" title="Delete Photo">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            {% endif %}
                                            <button class="btn btn-sm btn-outline-danger" onclick="removeAttendee('{{ attendee_id }}', '{{ attendee.full_name }}')" title="Remove from Gallery">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>

                                    {% if attendee.bio %}
                                    <div class="mt-2">
                                        <small class="text-muted">{{ attendee.bio[:100] }}{% if attendee.bio|length > 100 %}...{% endif %}</small>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-users fa-3x text-muted mb-3"></i>
                        <h5>No Featured Attendees</h5>
                        <p class="text-muted">Add attendees from the available list below to feature them in the gallery.</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Available Attendees Section -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-plus-circle me-2"></i>
                        Available Attendees
                    </h5>
                    <span class="badge bg-secondary">{{ available_attendees|length }} attendees</span>
                </div>
                <div class="card-body">
                    {% if available_attendees %}
                    <div class="row">
                        {% for reg_id, attendee in available_attendees.items() %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card attendee-card">
                                <div class="card-body">
                                    <div class="d-flex align-items-start">
                                        <!-- Attendee Photo -->
                                        <div class="attendee-photo me-3">
                                            {% if attendee.photo_url %}
                                            <img src="{{ attendee.photo_url }}" alt="{{ attendee.full_name }}" class="img-thumbnail" style="width: 60px; height: 60px; object-fit: cover;">
                                            {% else %}
                                            <div class="bg-light d-flex align-items-center justify-content-center" style="width: 60px; height: 60px; border-radius: 8px;">
                                                <i class="fas fa-user fa-lg text-muted"></i>
                                            </div>
                                            {% endif %}
                                        </div>

                                        <!-- Attendee Info -->
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1">{{ attendee.full_name }}</h6>
                                            {% if attendee.institution %}
                                            <p class="mb-1 small text-muted">{{ attendee.institution }}</p>
                                            {% endif %}
                                            {% if attendee.title %}
                                            <p class="mb-1 small">{{ attendee.title }}</p>
                                            {% endif %}
                                            {% if attendee.country %}
                                            <p class="mb-0 small text-muted">
                                                <i class="fas fa-map-marker-alt me-1"></i>
                                                {{ attendee.city }}{% if attendee.city and attendee.country %}, {% endif %}{{ attendee.country }}
                                            </p>
                                            {% endif %}
                                        </div>

                                        <!-- Actions -->
                                        <div class="ms-2 d-flex gap-1">
                                            <button class="btn btn-sm btn-outline-primary" onclick="editAttendee('{{ attendee.user_id }}', '{{ attendee.user_id }}')" title="Edit Attendee Info">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-info" onclick="uploadAttendeePhoto('{{ attendee.user_id }}', '{{ attendee.user_id }}')" title="Upload Photo">
                                                <i class="fas fa-camera"></i>
                                            </button>
                                            {% if attendee.photo_url %}
                                            <button class="btn btn-sm btn-outline-warning" onclick="deleteAttendeePhoto('{{ attendee.user_id }}', '{{ attendee.user_id }}')" title="Delete Photo">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            {% endif %}
                                            <button class="btn btn-sm btn-primary" onclick="addAttendee('{{ attendee.user_id }}', '{{ reg_id }}', '{{ attendee.full_name }}')" title="Add to Gallery">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                    </div>

                                    {% if attendee.bio %}
                                    <div class="mt-2">
                                        <small class="text-muted">{{ attendee.bio[:100] }}{% if attendee.bio|length > 100 %}...{% endif %}</small>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-user-slash fa-3x text-muted mb-3"></i>
                        <h5>No Available Attendees</h5>
                        <p class="text-muted">No registered attendees found for this conference.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.attendee-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border: 1px solid #e3e6f0;
}

.attendee-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.attendee-photo {
    flex-shrink: 0;
}

.card-header {
    background-color: #f8f9fc;
    border-bottom: 1px solid #e3e6f0;
}

.badge {
    font-size: 0.75rem;
}
</style>

<script>
function addAttendee(userId, registrationId, attendeeName) {
    if (confirm(`Add ${attendeeName} to the featured attendees gallery?`)) {
        // Use XMLHttpRequest to properly handle session cookies
        const xhr = new XMLHttpRequest();
        xhr.open('POST', `{{ url_for('add_attendee_to_gallery', conference_id=conference_id) }}`, true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        xhr.withCredentials = true; // Include cookies

        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    try {
                        const data = JSON.parse(xhr.responseText);
                        if (data.success) {
                            alert('Attendee added successfully!');
                            location.reload();
                        } else {
                            alert('Error: ' + data.error);
                        }
                    } catch (e) {
                        alert('Error parsing response');
                    }
                } else {
                    alert('Error: ' + xhr.statusText);
                }
            }
        };

        const params = `user_id=${encodeURIComponent(userId)}&registration_id=${encodeURIComponent(registrationId)}`;
        xhr.send(params);
    }
}

function removeAttendee(attendeeId, attendeeName) {
    if (confirm(`Remove ${attendeeName} from the featured attendees gallery?`)) {
        // Use XMLHttpRequest to properly handle session cookies
        const xhr = new XMLHttpRequest();
        xhr.open('POST', `{{ url_for('remove_attendee_from_gallery', conference_id=conference_id, attendee_id=attendeeId) }}`, true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        xhr.withCredentials = true; // Include cookies

        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    try {
                        const data = JSON.parse(xhr.responseText);
                        if (data.success) {
                            alert('Attendee removed successfully!');
                            location.reload();
                        } else {
                            alert('Error: ' + data.error);
                        }
                    } catch (e) {
                        alert('Error parsing response');
                    }
                } else {
                    alert('Error: ' + xhr.statusText);
                }
            }
        };

        xhr.send('');
    }
}

// Edit attendee information
function editAttendee(attendeeId, userId) {
    // For featured attendees, attendeeId is the gallery attendee ID
    // For available attendees, attendeeId is the user ID
    const editAttendeeId = attendeeId;

    // First, try to get gallery attendee data (for featured attendees)
    fetch(`{{ url_for('edit_attendee_info', conference_id=conference_id, attendee_id='PLACEHOLDER') }}`.replace('PLACEHOLDER', editAttendeeId), {
        method: 'GET',
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data && data.user_id) {
            // This is a featured attendee with gallery data
            showEditModal(data, editAttendeeId);
        } else {
            // This is an available attendee, get user data instead
            fetch(`/admin/users/${userId}/edit`, {
                method: 'GET',
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(userData => {
                if (userData) {
                    // Convert user data to gallery attendee format for editing
                    const attendeeData = {
                        user_id: userId,
                        full_name: userData.full_name || '',
                        institution: userData.institution || '',
                        department: userData.department || '',
                        title: userData.title || '',
                        country: userData.country || '',
                        city: userData.city || '',
                        bio: userData.bio || '',
                        website: userData.website || ''
                    };
                    showEditModal(attendeeData, editAttendeeId, true); // isUserEdit = true
                } else {
                    alert('Error loading attendee data');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error loading attendee data');
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error loading attendee data');
    });
}

// Show edit modal
function showEditModal(attendeeData, attendeeId, isUserEdit = false) {
    const modalHtml = `
        <div class="modal fade" id="editAttendeeModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Attendee Information</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <form id="editAttendeeForm">
                        <div class="modal-body">
                            <input type="hidden" name="attendee_id" value="${attendeeId}">

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="editFullName" class="form-label">Full Name *</label>
                                        <input type="text" class="form-control" id="editFullName" name="full_name" value="${attendeeData.full_name || ''}" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="editInstitution" class="form-label">Institution/Organization</label>
                                        <input type="text" class="form-control" id="editInstitution" name="institution" value="${attendeeData.institution || ''}">
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="editDepartment" class="form-label">Department</label>
                                        <input type="text" class="form-control" id="editDepartment" name="department" value="${attendeeData.department || ''}">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="editTitle" class="form-label">Title/Position</label>
                                        <input type="text" class="form-control" id="editTitle" name="title" value="${attendeeData.title || ''}">
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="editCountry" class="form-label">Country</label>
                                        <input type="text" class="form-control" id="editCountry" name="country" value="${attendeeData.country || ''}">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="editCity" class="form-label">City</label>
                                        <input type="text" class="form-control" id="editCity" name="city" value="${attendeeData.city || ''}">
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="editBio" class="form-label">Biography</label>
                                <textarea class="form-control" id="editBio" name="bio" rows="3">${attendeeData.bio || ''}</textarea>
                            </div>

                            <div class="mb-3">
                                <label for="editWebsite" class="form-label">Website</label>
                                <input type="url" class="form-control" id="editWebsite" name="website" value="${attendeeData.website || ''}">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    `;

    // Remove existing modal if any
    const existingModal = document.getElementById('editAttendeeModal');
    if (existingModal) {
        existingModal.remove();
    }

    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // Initialize and show modal
    const modal = new bootstrap.Modal(document.getElementById('editAttendeeModal'));
    modal.show();

    // Handle form submission
    document.getElementById('editAttendeeForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(this);

        // Determine the correct endpoint based on whether this is a gallery attendee or user edit
        const endpoint = isUserEdit
            ? `/admin/users/${attendeeData.user_id}/edit`
            : `{{ url_for('edit_attendee_info', conference_id=conference_id, attendee_id='PLACEHOLDER') }}`.replace('PLACEHOLDER', attendeeId);

        fetch(endpoint, {
            method: 'POST',
            body: formData,
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Attendee information updated successfully!');
                modal.hide();
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating attendee information');
        });
    });
}

// Upload attendee photo
function uploadAttendeePhoto(attendeeId, userId) {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
            const formData = new FormData();
            formData.append('photo', file);

            // Try gallery attendee endpoint first, fall back to user endpoint
            fetch(`{{ url_for('upload_attendee_photo', conference_id=conference_id, attendee_id='PLACEHOLDER') }}`.replace('PLACEHOLDER', attendeeId), {
                method: 'POST',
                body: formData,
                credentials: 'same-origin'
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    // Try user photo upload instead
                    return fetch(`/admin/users/${userId}/upload-photo`, {
                        method: 'POST',
                        body: formData,
                        credentials: 'same-origin'
                    }).then(response => response.json());
                }
            })
            .then(data => {
                if (data.success) {
                    alert('Photo uploaded successfully!');
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error uploading photo');
            });
        }
    };
    input.click();
}

// Delete attendee photo
function deleteAttendeePhoto(attendeeId, userId) {
    if (confirm('Are you sure you want to delete this attendee\'s photo?')) {
        // Try gallery attendee endpoint first, fall back to user endpoint
        fetch(`{{ url_for('delete_attendee_photo', conference_id=conference_id, attendee_id='PLACEHOLDER') }}`.replace('PLACEHOLDER', attendeeId), {
            method: 'POST',
            credentials: 'same-origin'
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            } else {
                // Try user photo delete instead
                return fetch(`/admin/users/${userId}/delete-photo`, {
                    method: 'POST',
                    credentials: 'same-origin'
                }).then(response => response.json());
            }
        })
        .then(data => {
            if (data.success) {
                alert('Photo deleted successfully!');
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting photo');
        });
    }
}
</script>
{% endblock %}
