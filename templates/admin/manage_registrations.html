{% extends "admin/base_admin.html" %}

{% block title %}Manage Registrations - Admin{% endblock %}

{% block content %}
<div class="admin-dashboard">
    <div class="dashboard-header">
        <div class="header-content">
            <h1><i class="fas fa-clipboard-list"></i> Manage Registrations</h1>
            <p>View and manage conference registrations</p>
        </div>
        <div class="quick-actions">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Search by name or email...">
            </div>
            <select id="filterType" class="filter-select">
                <option value="all">All Types</option>
                <option value="student_author">Student Author</option>
                <option value="regular_author">Regular Author</option>
                <option value="physical_delegate">Physical Delegate</option>
                <option value="virtual_delegate">Virtual Delegate</option>
            </select>
            <select id="filterPeriod" class="filter-select">
                <option value="all">All Periods</option>
                <option value="early_bird">Early Bird</option>
                <option value="regular">Regular</option>
                <option value="late">Late</option>
            </select>
            <select id="filterStatus" class="filter-select">
                <option value="all">All Status</option>
                <option value="pending">Pending</option>
                <option value="approved">Approved</option>
                <option value="rejected">Rejected</option>
            </select>
        </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} fade-in">
                    {{ message }}
                    <button type="button" class="close-alert" onclick="this.parentElement.remove();">Ã—</button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="stats-overview">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-details">
                <h3>Total Registrations</h3>
                <p class="stat-number">{{ registrations|length if registrations else 0 }}</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon approved">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-details">
                <h3>Approved</h3>
                <p class="stat-number">{{ registrations|selectattr('payment_status', 'equalto', 'approved')|list|length if registrations else 0 }}</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon pending">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stat-details">
                <h3>Pending</h3>
                <p class="stat-number">{{ registrations|selectattr('payment_status', 'equalto', 'pending')|list|length if registrations else 0 }}</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon rejected">
                <i class="fas fa-times-circle"></i>
            </div>
            <div class="stat-details">
                <h3>Rejected</h3>
                <p class="stat-number">{{ registrations|selectattr('payment_status', 'equalto', 'rejected')|list|length if registrations else 0 }}</p>
            </div>
        </div>
    </div>

    <div class="content-section">
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Type</th>
                        <th>Period</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if registrations %}
                        {% for id, registration in registrations.items() if registrations is mapping %}
                        <tr class="registration-row" 
                            data-status="{{ registration.get('payment_status', 'pending') }}"
                            data-type="{{ registration.get('registration_type', '') }}"
                            data-period="{{ registration.get('registration_period', '') }}">
                            <td>{{ registration.get('full_name', '') }}</td>
                            <td>{{ registration.get('email', '') }}</td>
                            <td>{{ registration.get('registration_type', '')|replace('_', ' ')|title }}</td>
                            <td>{{ registration.get('registration_period', '')|replace('_', ' ')|title }}</td>
                            <td>R {{ registration.get('total_amount', 0) }}</td>
                            <td>
                                <span class="status-badge status-{{ registration.get('payment_status', 'pending') }}">
                                    {{ registration.get('payment_status', 'pending')|title }}
                                </span>
                            </td>
                            <td>{{ registration.get('submission_date', '') }}</td>
                            <td class="actions">
                                <button class="btn-icon" onclick="viewDetails('{{ id }}')" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                {% if registration.get('payment_status') == 'pending' %}
                                <button class="btn-icon approve" onclick="updateStatus('{{ id }}', 'approved')" title="Approve">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="btn-icon reject" onclick="updateStatus('{{ id }}', 'rejected')" title="Reject">
                                    <i class="fas fa-times"></i>
                                </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="8" class="no-data">No registrations found</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Registration Details Modal -->
<div id="detailsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Registration Details</h2>
            <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
            <div class="details-grid">
                <div class="detail-section">
                    <h3>Personal Information</h3>
                    <div class="detail-group">
                        <label>Full Name</label>
                        <p id="modalName"></p>
                    </div>
                    <div class="detail-group">
                        <label>Email</label>
                        <p id="modalEmail"></p>
                    </div>
                    <div class="detail-group">
                        <label>Institution</label>
                        <p id="modalInstitution"></p>
                    </div>
                </div>

                <div class="detail-section">
                    <h3>Registration Details</h3>
                    <div class="detail-group">
                        <label>Registration Type</label>
                        <p id="modalType"></p>
                    </div>
                    <div class="detail-group">
                        <label>Registration Period</label>
                        <p id="modalPeriod"></p>
                    </div>
                    <div class="detail-group">
                        <label>Registration Date</label>
                        <p id="modalDate"></p>
                    </div>
                </div>

                <div class="detail-section">
                    <h3>Additional Items</h3>
                    <div id="modalAdditionalItems" class="additional-items-grid">
                        <div class="item-status workshop-status">
                            <div class="item-icon">
                                <i class="fas fa-chalkboard-teacher"></i>
                            </div>
                            <div class="item-details">
                                <h4>Workshop</h4>
                                <p class="status"></p>
                            </div>
                        </div>
                        <div class="item-status banquet-status">
                            <div class="item-icon">
                                <i class="fas fa-utensils"></i>
                            </div>
                            <div class="item-details">
                                <h4>Banquet</h4>
                                <p class="status"></p>
                            </div>
                        </div>
                        <div class="item-status extra-paper-status author-only">
                            <div class="item-icon">
                                <i class="fas fa-file-alt"></i>
                            </div>
                            <div class="item-details">
                                <h4>Extra Paper</h4>
                                <p class="status"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3>Payment Information</h3>
                    <div class="detail-group">
                        <label>Base Fee</label>
                        <p id="modalBaseFee"></p>
                    </div>
                    <div class="detail-group">
                        <label>Total Amount</label>
                        <p id="modalAmount" class="highlight"></p>
                    </div>
                    <div class="detail-group">
                        <label>Payment Reference</label>
                        <p id="modalPaymentRef"></p>
                    </div>
                    <div class="detail-group">
                        <label>Status Management</label>
                        <div class="status-actions">
                            <button class="btn btn-success" onclick="updateStatus(currentRegistrationId, 'approved')">
                                <i class="fas fa-check"></i> Approve
                            </button>
                            <button class="btn btn-danger" onclick="updateStatus(currentRegistrationId, 'rejected')">
                                <i class="fas fa-times"></i> Reject
                            </button>
                            <button class="btn btn-warning" onclick="updateStatus(currentRegistrationId, 'pending')">
                                <i class="fas fa-clock"></i> Mark as Pending
                            </button>
                        </div>
                    </div>
                    <div class="detail-group">
                        <label>Current Status</label>
                        <p id="modalStatus"></p>
                    </div>
                    <div class="detail-group">
                        <label>Payment Proof</label>
                        <div id="modalPaymentProof">
                            <button class="btn btn-primary" onclick="downloadPaymentProof()" title="Download Payment Proof">
                                <i class="fas fa-download"></i> Download Payment Proof
                            </button>
                        </div>
                    </div>
                </div>

                <div id="paperDetailsSection" class="detail-section" style="display: none;">
                    <h3>Paper Details</h3>
                    <div class="detail-group">
                        <label>Paper Title</label>
                        <p id="modalPaperTitle"></p>
                    </div>
                    <div class="detail-group">
                        <label>Presentation Type</label>
                        <p id="modalPresentationType"></p>
                    </div>
                    <div class="detail-group">
                        <label>Paper File</label>
                        <div id="modalPaperFile">
                            <button class="btn btn-primary" onclick="viewPaperFile()">
                                <i class="fas fa-file-pdf"></i> View Paper
                            </button>
                        </div>
                    </div>
                </div>

                <div class="detail-section full-width">
                    <h3>Admin Notes</h3>
                    <div class="detail-group">
                        <textarea id="modalNotes" class="admin-notes" placeholder="Add notes about this registration..."></textarea>
                        <button class="btn btn-primary" onclick="saveNotes()">Save Notes</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.admin-dashboard {
    padding: 2rem;
}

.dashboard-header {
    margin-bottom: 2rem;
}

.header-content h1 {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 0.5rem;
}

.quick-actions {
    display: flex;
    gap: 1rem;
    margin-top: 1rem;
}

.stats-overview {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.stat-icon {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: var(--primary-color);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
}

.stat-icon.approved { background: #28a745; }
.stat-icon.pending { background: #ffc107; }
.stat-icon.rejected { background: #dc3545; }

.stat-details h3 {
    font-size: 0.9rem;
    color: #666;
    margin: 0;
}

.stat-number {
    font-size: 1.5rem;
    font-weight: bold;
    color: #333;
    margin: 0;
}

.search-box {
    position: relative;
    flex: 1;
}

.search-box input {
    width: 100%;
    padding: 0.75rem 1rem 0.75rem 2.5rem;
    border: 1px solid #ddd;
    border-radius: 8px;
}

.search-box i {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: #666;
}

.filter-select {
    padding: 0.75rem 1rem;
    border: 1px solid #ddd;
    border-radius: 8px;
    min-width: 150px;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th,
.data-table td {
    padding: 1rem;
    text-align: left;
    border-bottom: 1px solid #eee;
}

.data-table th {
    background: #f8f9fa;
    font-weight: 600;
}

.status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 50px;
    font-size: 0.875rem;
}

.status-pending {
    background: #fff3cd;
    color: #856404;
}

.status-approved {
    background: #d4edda;
    color: #155724;
}

.status-rejected {
    background: #f8d7da;
    color: #721c24;
}

.btn-icon {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-icon:hover {
    transform: translateY(-2px);
}

.btn-icon.approve:hover {
    background: #28a745;
    color: white;
}

.btn-icon.reject:hover {
    background: #dc3545;
    color: white;
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
}

.modal-content {
    background: white;
    border-radius: 12px;
    width: 90%;
    max-width: 800px;
    margin: 2rem auto;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-body {
    padding: 1.5rem;
}

.details-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
}

.detail-section {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1.5rem;
}

.detail-section.full-width {
    grid-column: 1 / -1;
}

.detail-group {
    margin-bottom: 1rem;
}

.detail-group label {
    display: block;
    color: #666;
    margin-bottom: 0.5rem;
}

.admin-notes {
    width: 100%;
    min-height: 100px;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-bottom: 1rem;
}

#paymentProofContent {
    max-height: 70vh;
    overflow: auto;
    text-align: center;
}

.status-actions {
    display: flex;
    gap: 0.5rem;
    margin: 1rem 0;
}

.status-actions .btn {
    padding: 0.5rem 1rem;
    border-radius: 4px;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.3s ease;
}

.btn-success {
    background: #28a745;
    color: white;
}

.btn-danger {
    background: #dc3545;
    color: white;
}

.btn-warning {
    background: #ffc107;
    color: #000;
}

.status-actions .btn:hover {
    opacity: 0.9;
    transform: translateY(-1px);
}

.status-actions .btn i {
    font-size: 0.9rem;
}

@media (max-width: 768px) {
    .quick-actions {
        flex-direction: column;
    }
    
    .details-grid {
        grid-template-columns: 1fr;
    }
    
    .stat-card {
        padding: 1rem;
    }
}

/* Additional Items Styles in Modal */
.additional-items-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.item-status {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    border-radius: 8px;
    background: var(--background-color);
    transition: all 0.3s ease;
}

.item-status.selected {
    background: var(--primary-color);
}

.item-status.selected .item-icon i,
.item-status.selected .item-details h4,
.item-status.selected .item-details p {
    color: white;
}

.item-icon {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
}

.item-icon i {
    font-size: 1.2rem;
    color: var(--primary-color);
}

.item-details {
    flex: 1;
}

.item-details h4 {
    margin: 0;
    font-size: 1rem;
    color: var(--text-color);
}

.item-details p {
    margin: 0.25rem 0 0;
    font-size: 0.9rem;
    color: var(--text-secondary);
}

.item-status .status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.item-status .status i {
    font-size: 1rem;
}

.item-status .status.included i {
    color: #28a745;
}

.item-status .status.not-included i {
    color: #dc3545;
}

@media (max-width: 768px) {
    .additional-items-grid {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
let currentRegistrationId = null;

document.addEventListener('DOMContentLoaded', function() {
    // Initialize search and filters
    const searchInput = document.getElementById('searchInput');
    const filterType = document.getElementById('filterType');
    const filterPeriod = document.getElementById('filterPeriod');
    const filterStatus = document.getElementById('filterStatus');

    [searchInput, filterType, filterPeriod, filterStatus].forEach(element => {
        element.addEventListener('input', filterRegistrations);
    });
});

function filterRegistrations() {
    const searchTerm = searchInput.value.toLowerCase();
    const typeFilter = filterType.value;
    const periodFilter = filterPeriod.value;
    const statusFilter = filterStatus.value;
    
    const rows = document.querySelectorAll('.registration-row');
    
    rows.forEach(row => {
        const name = row.children[0].textContent.toLowerCase();
        const email = row.children[1].textContent.toLowerCase();
        const type = row.dataset.type;
        const period = row.dataset.period;
        const status = row.dataset.status;
        
        const matchesSearch = name.includes(searchTerm) || email.includes(searchTerm);
        const matchesType = typeFilter === 'all' || type === typeFilter;
        const matchesPeriod = periodFilter === 'all' || period === periodFilter;
        const matchesStatus = statusFilter === 'all' || status === statusFilter;
        
        row.style.display = matchesSearch && matchesType && matchesPeriod && matchesStatus ? '' : 'none';
    });
}

function viewDetails(id) {
    currentRegistrationId = id;
    fetch(`/admin/registrations/${id}`)
        .then(response => response.json())
        .then(registration => {
            // Personal Information
            document.getElementById('modalName').textContent = registration.full_name || 'Not provided';
            document.getElementById('modalEmail').textContent = registration.email || 'Not provided';
            document.getElementById('modalInstitution').textContent = registration.institution || 'Not provided';
            
            // Registration Details
            document.getElementById('modalType').textContent = (registration.registration_type || '').replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
            document.getElementById('modalPeriod').textContent = (registration.registration_period || '').replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
            document.getElementById('modalDate').textContent = registration.submission_date || 'Not provided';
            
            // Update Additional Items Section
            const workshopStatus = document.querySelector('.workshop-status');
            const banquetStatus = document.querySelector('.banquet-status');
            const extraPaperStatus = document.querySelector('.extra-paper-status');
            
            // Workshop Status
            if (registration.workshop) {
                workshopStatus.classList.add('selected');
                workshopStatus.querySelector('.status').innerHTML = '<i class="fas fa-check-circle"></i> Included';
                workshopStatus.querySelector('.status').classList.add('included');
            } else {
                workshopStatus.classList.remove('selected');
                workshopStatus.querySelector('.status').innerHTML = '<i class="fas fa-times-circle"></i> Not Included';
                workshopStatus.querySelector('.status').classList.add('not-included');
            }
            
            // Banquet Status
            if (registration.banquet) {
                banquetStatus.classList.add('selected');
                banquetStatus.querySelector('.status').innerHTML = '<i class="fas fa-check-circle"></i> Included';
                banquetStatus.querySelector('.status').classList.add('included');
            } else {
                banquetStatus.classList.remove('selected');
                banquetStatus.querySelector('.status').innerHTML = '<i class="fas fa-times-circle"></i> Not Included';
                banquetStatus.querySelector('.status').classList.add('not-included');
            }
            
            // Extra Paper Status (only for authors)
            if (registration.registration_type && registration.registration_type.includes('author')) {
                extraPaperStatus.style.display = 'flex';
                if (registration.extra_paper) {
                    extraPaperStatus.classList.add('selected');
                    extraPaperStatus.querySelector('.status').innerHTML = '<i class="fas fa-check-circle"></i> Included';
                    extraPaperStatus.querySelector('.status').classList.add('included');
                } else {
                    extraPaperStatus.classList.remove('selected');
                    extraPaperStatus.querySelector('.status').innerHTML = '<i class="fas fa-times-circle"></i> Not Included';
                    extraPaperStatus.querySelector('.status').classList.add('not-included');
                }
            } else {
                extraPaperStatus.style.display = 'none';
            }
            
            // Payment Information
            document.getElementById('modalBaseFee').textContent = `R ${registration.registration_fee || 0}`;
            document.getElementById('modalAmount').textContent = `R ${registration.total_amount || 0}`;
            document.getElementById('modalPaymentRef').textContent = registration.payment_reference || 'Not provided';
            document.getElementById('modalStatus').innerHTML = `
                <span class="status-badge status-${registration.payment_status || 'pending'}">
                    ${(registration.payment_status || 'pending').charAt(0).toUpperCase() + (registration.payment_status || 'pending').slice(1)}
                </span>`;
            
            // Paper Details Section
            const paperDetailsSection = document.getElementById('paperDetailsSection');
            if (registration.registration_type && registration.registration_type.includes('author')) {
                paperDetailsSection.style.display = 'block';
                if (registration.paper) {
                    document.getElementById('modalPaperTitle').textContent = registration.paper.title || 'Not provided';
                    document.getElementById('modalPresentationType').textContent = registration.paper.presentation_type || 'Not specified';
                    
                    const paperFileBtn = document.getElementById('modalPaperFile').querySelector('button');
                    if (registration.paper.file_path) {
                        paperFileBtn.style.display = 'block';
                        paperFileBtn.onclick = () => window.open(`/uploads/${registration.paper.file_path}`, '_blank');
                    } else {
                        paperFileBtn.style.display = 'none';
                    }
                }
            } else {
                paperDetailsSection.style.display = 'none';
            }
            
            // Admin Notes
            document.getElementById('modalNotes').value = registration.admin_notes || '';
            
            // Show modal
            document.getElementById('detailsModal').style.display = 'block';
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading registration details');
        });
}

function downloadPaymentProof() {
    if (!currentRegistrationId) return;
    
    fetch(`/admin/registrations/${currentRegistrationId}/payment-proof`)
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || 'Error downloading payment proof');
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.url) {
                // Create a temporary link and trigger download
                const link = document.createElement('a');
                // Ensure the URL starts with /static/uploads/
                const url = data.url.startsWith('/') ? data.url : `/static/uploads/${data.url}`;
                link.href = url;
                link.target = '_blank';  // Open in new tab
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                throw new Error('Payment proof URL not found');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert(error.message || 'Error downloading payment proof');
        });
}

// Add function to handle paper file downloads
function viewPaperFile() {
    if (!currentRegistrationId) return;
    
    fetch(`/admin/registrations/${currentRegistrationId}`)
        .then(response => response.json())
        .then(registration => {
            if (registration.paper && registration.paper.file_path) {
                const link = document.createElement('a');
                link.href = `/uploads/${registration.paper.file_path}`;
                link.target = '_blank';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                throw new Error('Paper file not found');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert(error.message || 'Error viewing paper file');
        });
}

function updateStatus(id, status) {
    if (!id) return;
    
    const confirmMessage = {
        approved: 'approve',
        rejected: 'reject',
        pending: 'mark as pending'
    };
    
    if (!confirm(`Are you sure you want to ${confirmMessage[status]} this registration?`)) return;
    
    // If rejecting, prompt for reason
    let rejectionReason = '';
    if (status === 'rejected') {
        rejectionReason = prompt('Please provide a reason for rejection:');
        if (!rejectionReason) return; // Cancel if no reason provided
    }
    
    fetch(`/admin/registrations/${id}/status`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
            status: status,
            rejection_reason: rejectionReason,
            send_email: true // Enable email notifications
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the status badge in the modal
            const statusBadge = `
                <span class="status-badge status-${status}">
                    ${status.charAt(0).toUpperCase() + status.slice(1)}
                </span>`;
            document.getElementById('modalStatus').innerHTML = statusBadge;
            
            // Update the status in the table row
            const row = document.querySelector(`tr[data-id="${id}"]`);
            if (row) {
                row.querySelector('.status-badge').outerHTML = statusBadge;
                row.dataset.status = status;
                
                // Update action buttons visibility
                const actionButtons = row.querySelector('.actions');
                if (status === 'pending') {
                    actionButtons.innerHTML = `
                        <button class="btn-icon" onclick="viewDetails('${id}')" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn-icon approve" onclick="updateStatus('${id}', 'approved')" title="Approve">
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="btn-icon reject" onclick="updateStatus('${id}', 'rejected')" title="Reject">
                            <i class="fas fa-times"></i>
                        </button>`;
                } else {
                    actionButtons.innerHTML = `
                        <button class="btn-icon" onclick="viewDetails('${id}')" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>`;
                }
            }
            
            // Show success message with email notification status
            const emailStatus = data.email_sent ? 'and notification email sent' : 'but email notification failed';
            alert(`Registration successfully ${status} ${emailStatus}`);
        } else {
            alert(data.error || 'Error updating status');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating registration status');
    });
}

function saveNotes() {
    if (!currentRegistrationId) return;
    
    const notes = document.getElementById('modalNotes').value;
    fetch(`/admin/registrations/${currentRegistrationId}/notes`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ notes: notes })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Notes saved successfully');
        } else {
            alert(data.error || 'Error saving notes');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving notes');
    });
}

// Close modals
document.querySelectorAll('.close-modal').forEach(button => {
    button.addEventListener('click', function() {
        this.closest('.modal').style.display = 'none';
    });
});

window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
    }
}
</script>
{% endblock %} 