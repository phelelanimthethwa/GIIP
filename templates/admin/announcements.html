{% extends "admin/base_admin.html" %}

{% block title %}Manage Announcements - Admin{% endblock %}

{% block content %}
<div class="admin-dashboard">
    <div class="dashboard-header">
        <div class="header-content">
            <h1><i class="fas fa-bullhorn"></i> Manage Announcements</h1>
            <p>Create and manage conference announcements</p>
        </div>
        <div class="quick-actions">
            <div class="search-box">
                <input type="text" id="searchAnnouncements" placeholder="Search announcements..." class="form-control">
                <i class="fas fa-search"></i>
            </div>
            <div class="filter-box">
                <select id="filterType" class="form-control">
                    <option value="all">All Types</option>
                    <option value="important">Important</option>
                    <option value="info">Information</option>
                    <option value="event">Event</option>
                    <option value="update">Update</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="openNewAnnouncementModal()">
                <i class="fas fa-plus"></i> New Announcement
            </button>
        </div>
    </div>

    <div id="alertContainer">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} fade-in">
                        {{ message }}
                        <button type="button" class="close-alert" onclick="this.parentElement.remove();">√ó</button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <div class="content-section">
        <div class="announcements-grid" id="announcementsGrid">
            {% if announcements %}
                {% for id, announcement in announcements.items() %}
                    <div class="announcement-card" data-id="{{ id }}" data-type="{{ announcement.type }}">
                        <div class="card-status {{ announcement.type }}"></div>
                        {% if announcement.image_url %}
                        <div class="announcement-image">
                            <img src="{{ announcement.image_url }}" alt="Announcement image" onerror="this.onerror=null; this.src='/static/images/placeholder.png';">
                            <div class="image-overlay">
                                <span class="zoom-icon"><i class="fas fa-search-plus"></i></span>
                            </div>
                        </div>
                        {% endif %}
                        <div class="announcement-header">
                            <div class="header-main">
                                <h3>{{ announcement.title }}</h3>
                                <span class="announcement-date">
                                    <i class="fas fa-calendar"></i> {{ announcement.scheduled_date|datetime if announcement.scheduled_date else announcement.created_at|datetime }}
                                    {% if announcement.scheduled_time %}
                                    <i class="fas fa-clock ms-2"></i> {{ announcement.scheduled_time }}
                                    <span class="timezone-badge">{{ announcement.timezone }}</span>
                                    {% endif %}
                                </span>
                            </div>
                            <div class="announcement-actions">
                                <button class="btn-icon" onclick="editAnnouncement('{{ id }}')" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-icon delete" onclick="deleteAnnouncement('{{ id }}')" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="announcement-content">{{ announcement.content|safe }}</div>
                        <div class="announcement-footer">
                            <span class="announcement-type {{ announcement.type }}">
                                <i class="fas fa-{{ 'exclamation-circle' if announcement.type == 'important' 
                                    else 'info-circle' if announcement.type == 'info' 
                                    else 'calendar-alt' if announcement.type == 'event' 
                                    else 'bell' }}"></i>
                                {{ announcement.type|title }}
                            </span>
                            {% if announcement.is_pinned %}
                            <span class="pinned-badge">
                                <i class="fas fa-thumbtack"></i> Pinned
                            </span>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="no-data" id="noDataMessage">
                    <i class="fas fa-bullhorn"></i>
                    <p>No announcements yet</p>
                    <button class="btn btn-primary" onclick="openNewAnnouncementModal()">Create First Announcement</button>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Image Preview Modal -->
<div id="imagePreviewModal" class="modal">
    <div class="modal-content image-preview-content">
        <button class="close-modal">&times;</button>
        <img id="previewImage" src="" alt="Preview">
    </div>
</div>

<!-- Announcement Modal -->
<div id="announcementModal" class="modal modern-modal">
    <div class="modal-content announcement-modal-content">
        <div class="modal-header modern-header">
            <div class="header-content">
                <div class="header-icon">
                    <i class="fas fa-bullhorn"></i>
                </div>
                <div class="header-text">
                    <h2 id="modalTitle">New Announcement</h2>
                    <p class="header-subtitle">Create and share important information with your community</p>
                </div>
            </div>
            <button class="close-modal modern-close" onclick="closeModal('announcementModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body modern-body">
            <form id="announcementForm" enctype="multipart/form-data" method="POST" class="modern-form">
                
                <!-- Basic Information Section -->
                <div class="form-section">
                    <div class="section-header">
                        <h3><i class="fas fa-info-circle"></i> Basic Information</h3>
                        <p>Core details about your announcement</p>
                    </div>
                    
                    <div class="form-group enhanced">
                        <label for="title">Announcement Title <span class="required">*</span></label>
                        <div class="input-wrapper">
                            <input type="text" id="title" name="title" class="form-control enhanced-input" 
                                   required maxlength="100" placeholder="Enter a clear, descriptive title...">
                            <div class="input-feedback">
                                <span class="char-counter">0/100</span>
                            </div>
                        </div>
                        <small class="form-help">A clear title helps users quickly understand the announcement</small>
                    </div>

                    <div class="form-group enhanced">
                        <label for="content">Announcement Content <span class="required">*</span></label>
                        <div class="content-editor-wrapper">
                            <textarea id="content" name="content" class="form-control rich-editor enhanced-input" 
                                      rows="8" required placeholder="Write your announcement content here..."></textarea>
                            <div class="editor-toolbar">
                                <small class="form-help">
                                    <i class="fas fa-magic"></i> Rich text editor with formatting options
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Scheduling Section -->
                <div class="form-section">
                    <div class="section-header">
                        <h3><i class="fas fa-calendar-alt"></i> Scheduling</h3>
                        <p>When should this announcement be visible?</p>
                    </div>
                    
                    <div class="form-row enhanced-row">
                        <div class="form-group col-md-4">
                            <label for="announcement_date">Publication Date <span class="required">*</span></label>
                            <div class="input-group enhanced-input-group">
                                <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                                <input type="date" id="announcement_date" name="announcement_date" 
                                       class="form-control enhanced-input" required>
                            </div>
                        </div>
                        <div class="form-group col-md-4">
                            <label for="announcement_time">Publication Time <span class="required">*</span></label>
                            <div class="input-group enhanced-input-group">
                                <span class="input-group-text"><i class="fas fa-clock"></i></span>
                                <input type="time" id="announcement_time" name="announcement_time" 
                                       class="form-control enhanced-input" required>
                            </div>
                        </div>
                        <div class="form-group col-md-4">
                            <label for="timezone">Timezone <span class="required">*</span></label>
                            <div class="input-group enhanced-input-group">
                                <span class="input-group-text"><i class="fas fa-globe"></i></span>
                                <select id="timezone" name="timezone" class="form-control enhanced-input" required>
                                    <option value="Africa/Johannesburg">South Africa (SAST)</option>
                                    <option value="UTC">UTC</option>
                                    <option value="America/New_York">New York (EST)</option>
                                    <option value="Europe/London">London (GMT)</option>
                                    <option value="Asia/Dubai">Dubai (GST)</option>
                                    <option value="Asia/Singapore">Singapore (SGT)</option>
                                    <option value="Asia/Tokyo">Tokyo (JST)</option>
                                    <option value="Australia/Sydney">Sydney (AEST)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Media Section -->
                <div class="form-section">
                    <div class="section-header">
                        <h3><i class="fas fa-image"></i> Media</h3>
                        <p>Add visual content to make your announcement more engaging</p>
                    </div>
                    
                    <div class="form-group enhanced">
                        <label for="image">Featured Image</label>
                        <div class="image-upload-container enhanced-upload">
                            <div class="upload-area modern-upload" onclick="document.getElementById('image').click()">
                                <input type="file" id="image" name="image" class="form-control" accept="image/*" 
                                       onchange="validateAndPreviewImage(event)" hidden>
                                <div class="upload-placeholder modern-placeholder" id="uploadPlaceholder">
                                    <div class="upload-icon">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                    </div>
                                    <div class="upload-content">
                                        <h4>Upload Image</h4>
                                        <p>Click to browse or drag and drop</p>
                                        <div class="upload-specs">
                                            <span class="spec-item">
                                                <i class="fas fa-file-image"></i>
                                                PNG, JPG, JPEG, GIF
                                            </span>
                                            <span class="spec-item">
                                                <i class="fas fa-weight-hanging"></i>
                                                Max 5MB
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div id="imagePreview" class="image-preview modern-preview"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings Section -->
                <div class="form-section">
                    <div class="section-header">
                        <h3><i class="fas fa-cogs"></i> Settings</h3>
                        <p>Configure how this announcement will be displayed and delivered</p>
                    </div>
                    
                    <div class="form-row enhanced-row">
                        <div class="form-group col-md-6">
                            <label for="type">Announcement Type <span class="required">*</span></label>
                            <div class="input-group enhanced-input-group">
                                <span class="input-group-text"><i class="fas fa-tag"></i></span>
                                <select id="type" name="type" class="form-control enhanced-input" required>
                                    <option value="info">üìã Information</option>
                                    <option value="important">‚ö†Ô∏è Important</option>
                                    <option value="event">üìÖ Event</option>
                                    <option value="update">üîÑ Update</option>
                                </select>
                            </div>
                            <small class="form-help">Choose the type that best describes your announcement</small>
                        </div>
                        <div class="form-group col-md-6">
                            <label>Display Options</label>
                            <div class="enhanced-checkboxes">
                                <label class="enhanced-checkbox">
                                    <input type="checkbox" id="is_pinned" name="is_pinned">
                                    <span class="checkmark">
                                        <i class="fas fa-check"></i>
                                    </span>
                                    <span class="checkbox-content">
                                        <span class="checkbox-title">
                                            <i class="fas fa-thumbtack"></i>
                                            Pin to Top
                                        </span>
                                        <span class="checkbox-desc">Keep this announcement at the top of the list</span>
                                    </span>
                                </label>
                                <label class="enhanced-checkbox">
                                    <input type="checkbox" id="send_email" name="send_email" checked>
                                    <span class="checkmark">
                                        <i class="fas fa-check"></i>
                                    </span>
                                    <span class="checkbox-content">
                                        <span class="checkbox-title">
                                            <i class="fas fa-envelope"></i>
                                            Email Notification
                                        </span>
                                        <span class="checkbox-desc">Send this announcement to all registered users</span>
                                    </span>
                                </label>
                            </div>
                            <div class="email-preview-section">
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="previewEmail()">
                                    <i class="fas fa-eye"></i> Preview Email
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-actions enhanced-actions">
                    <div class="actions-left">
                        <button type="button" class="btn btn-outline-secondary" onclick="closeModal('announcementModal')">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                    <div class="actions-right">
                        <button type="button" class="btn btn-outline-primary" onclick="previewAnnouncement()">
                            <i class="fas fa-eye"></i> Preview
                        </button>
                        <button type="submit" class="btn btn-primary enhanced-submit" id="submitButton">
                            <span class="btn-content">
                                <i class="fas fa-save"></i> 
                                <span class="btn-text">Create Announcement</span>
                            </span>
                            <span class="btn-loading">
                                <i class="fas fa-spinner fa-spin"></i>
                                <span class="loading-text">Creating...</span>
                            </span>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Email Preview Modal -->
<div id="emailPreviewModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Email Preview</h2>
            <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
            <div class="email-preview">
                <div class="email-header">
                    <div class="email-field">
                        <label>From:</label>
                        <span id="emailFrom"></span>
                    </div>
                    <div class="email-field">
                        <label>Subject:</label>
                        <span id="emailSubject"></span>
                    </div>
                </div>
                <div class="email-content" id="emailContent">
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Required field indicator */
.required {
    color: #dc2626;
    margin-left: 2px;
}

/* ===== Enhanced Modal Styles ===== */
.modern-modal {
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(8px);
    animation: modalFadeIn 0.3s ease-out;
}

.announcement-modal-content {
    max-width: 900px;
    width: 95%;
    margin: 2vh auto;
    max-height: 95vh;
    border-radius: 16px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    background: #ffffff;
    overflow: hidden;
    animation: modalSlideIn 0.3s ease-out;
}

@keyframes modalFadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes modalSlideIn {
    from { 
        opacity: 0;
        transform: translateY(-30px) scale(0.95);
    }
    to { 
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.modern-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 24px 32px;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    border: none;
    position: relative;
    overflow: hidden;
}

.modern-header::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 100px;
    height: 100px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    transform: translate(30px, -30px);
}

.header-content {
    display: flex;
    align-items: center;
    gap: 16px;
}

.header-icon {
    width: 48px;
    height: 48px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
}

.header-text h2 {
    margin: 0;
    font-size: 24px;
    font-weight: 600;
    line-height: 1.2;
}

.header-subtitle {
    margin: 4px 0 0 0;
    opacity: 0.9;
    font-size: 14px;
    line-height: 1.4;
}

.modern-close {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    border-radius: 8px;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.modern-close:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.05);
}

.modern-body {
    padding: 0;
    max-height: calc(95vh - 140px);
    overflow-y: auto;
}

/* ===== Enhanced Form Styles ===== */
.modern-form {
    display: flex;
    flex-direction: column;
}

.form-section {
    padding: 32px;
    border-bottom: 1px solid #f1f5f9;
}

.form-section:last-of-type {
    border-bottom: none;
}

.section-header {
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 2px solid #f1f5f9;
}

.section-header h3 {
    margin: 0 0 8px 0;
    font-size: 18px;
    font-weight: 600;
    color: #334155;
    display: flex;
    align-items: center;
    gap: 8px;
}

.section-header p {
    margin: 0;
    color: #64748b;
    font-size: 14px;
    line-height: 1.5;
}

.form-group.enhanced {
    margin-bottom: 24px;
}

.form-group.enhanced label {
    display: block;
    font-weight: 600;
    color: #374151;
    margin-bottom: 8px;
    font-size: 14px;
}

.input-wrapper {
    position: relative;
}

.enhanced-input {
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    padding: 12px 16px;
    font-size: 16px;
    transition: all 0.2s ease;
    background: #ffffff;
    width: 100%;
}

.enhanced-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    background: #fafbff;
}

.enhanced-input::placeholder {
    color: #9ca3af;
    font-style: italic;
}

.input-feedback {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 6px;
}

.char-counter {
    font-size: 12px;
    color: #6b7280;
    margin-left: auto;
}

.form-help {
    color: #64748b;
    font-size: 13px;
    margin-top: 6px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.enhanced-row {
    display: flex;
    gap: 20px;
    margin: -12px;
}

.enhanced-row .form-group {
    flex: 1;
    margin: 12px;
}

.enhanced-input-group {
    display: flex;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    overflow: hidden;
    transition: all 0.2s ease;
}

.enhanced-input-group:focus-within {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.enhanced-input-group .input-group-text {
    background: #f8fafc;
    border: none;
    padding: 12px 16px;
    color: #64748b;
    font-weight: 500;
}

.enhanced-input-group .enhanced-input {
    border: none;
    border-radius: 0;
    box-shadow: none;
}

.enhanced-input-group .enhanced-input:focus {
    border: none;
    box-shadow: none;
}

/* ===== Content Editor Styles ===== */
.content-editor-wrapper {
    position: relative;
}

.editor-toolbar {
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid #f1f5f9;
}

/* ===== Enhanced Upload Styles ===== */
.enhanced-upload {
    border: 2px dashed #cbd5e1;
    border-radius: 12px;
    transition: all 0.3s ease;
    background: #f8fafc;
    overflow: hidden;
}

.modern-upload {
    cursor: pointer;
    transition: all 0.3s ease;
}

.modern-upload:hover {
    border-color: #667eea;
    background: #fafbff;
}

.modern-placeholder {
    padding: 48px 24px;
    text-align: center;
    transition: all 0.3s ease;
}

.upload-icon {
    width: 64px;
    height: 64px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 16px;
    color: white;
    font-size: 24px;
}

.upload-content h4 {
    margin: 0 0 8px 0;
    font-size: 18px;
    font-weight: 600;
    color: #334155;
}

.upload-content p {
    margin: 0 0 16px 0;
    color: #64748b;
    font-size: 14px;
}

.upload-specs {
    display: flex;
    justify-content: center;
    gap: 24px;
    flex-wrap: wrap;
}

.spec-item {
    display: flex;
    align-items: center;
    gap: 6px;
    color: #64748b;
    font-size: 13px;
    font-weight: 500;
}

.modern-preview {
    padding: 16px;
}

.modern-preview img {
    max-width: 100%;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

/* ===== Enhanced Checkbox Styles ===== */
.enhanced-checkboxes {
    display: flex;
    flex-direction: column;
    gap: 16px;
    margin-bottom: 16px;
}

.enhanced-checkbox {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    cursor: pointer;
    padding: 16px;
    border: 2px solid #f1f5f9;
    border-radius: 8px;
    transition: all 0.2s ease;
    background: #ffffff;
}

.enhanced-checkbox:hover {
    border-color: #e2e8f0;
    background: #f8fafc;
}

.enhanced-checkbox input[type="checkbox"] {
    display: none;
}

.enhanced-checkbox .checkmark {
    width: 20px;
    height: 20px;
    border: 2px solid #cbd5e1;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    flex-shrink: 0;
    margin-top: 2px;
}

.enhanced-checkbox input[type="checkbox"]:checked + .checkmark {
    background: #667eea;
    border-color: #667eea;
    color: white;
}

.enhanced-checkbox input[type="checkbox"]:checked + .checkmark i {
    opacity: 1;
    transform: scale(1);
}

.enhanced-checkbox .checkmark i {
    font-size: 12px;
    opacity: 0;
    transform: scale(0.5);
    transition: all 0.2s ease;
}

.checkbox-content {
    flex: 1;
}

.checkbox-title {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    color: #334155;
    font-size: 14px;
    margin-bottom: 4px;
}

.checkbox-desc {
    color: #64748b;
    font-size: 13px;
    line-height: 1.4;
}

.email-preview-section {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid #f1f5f9;
}

/* ===== Enhanced Actions Styles ===== */
.enhanced-actions {
    padding: 24px 32px;
    background: #f8fafc;
    border-top: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 16px;
}

.actions-left, .actions-right {
    display: flex;
    gap: 12px;
    align-items: center;
}

.enhanced-submit {
    position: relative;
    min-width: 180px;
    overflow: hidden;
}

.enhanced-submit .btn-content,
.enhanced-submit .btn-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.3s ease;
}

.enhanced-submit .btn-loading {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: inherit;
    opacity: 0;
    transform: translateY(100%);
}

.enhanced-submit.loading .btn-content {
    opacity: 0;
    transform: translateY(-100%);
}

.enhanced-submit.loading .btn-loading {
    opacity: 1;
    transform: translateY(0);
}

/* ===== Responsive Design ===== */
@media (max-width: 768px) {
    .announcement-modal-content {
        width: 98%;
        margin: 1vh auto;
        max-height: 98vh;
        border-radius: 12px;
    }
    
    .modern-header {
        padding: 20px 24px;
    }
    
    .header-content {
        gap: 12px;
    }
    
    .header-icon {
        width: 40px;
        height: 40px;
        font-size: 18px;
    }
    
    .header-text h2 {
        font-size: 20px;
    }
    
    .form-section {
        padding: 24px 20px;
    }
    
    .enhanced-row {
        flex-direction: column;
        gap: 0;
    }
    
    .enhanced-actions {
        padding: 20px 24px;
        flex-direction: column;
        gap: 12px;
    }
    
    .actions-left, .actions-right {
        width: 100%;
        justify-content: center;
    }
    
    .enhanced-submit {
        min-width: 200px;
    }
    
    .upload-specs {
        flex-direction: column;
        gap: 8px;
    }
    
    .enhanced-checkboxes {
        gap: 12px;
    }
}

/* ===== Field Validation Feedback Styles ===== */
.field-feedback {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-top: 6px;
    font-size: 13px;
    font-weight: 500;
    padding: 8px 12px;
    border-radius: 6px;
    animation: feedbackSlideIn 0.3s ease-out;
}

.field-feedback-error {
    color: #dc2626;
    background: #fef2f2;
    border: 1px solid #fecaca;
}

.field-feedback-success {
    color: #059669;
    background: #f0fdf4;
    border: 1px solid #bbf7d0;
}

@keyframes feedbackSlideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* ===== Enhanced Alert Styles ===== */
.announcement-preview {
    max-width: 600px;
    margin: 0 auto;
}

.preview-header {
    text-align: center;
    margin-bottom: 24px;
}

.preview-header h3 {
    margin: 0 0 8px 0;
    font-size: 20px;
    font-weight: 600;
    color: #334155;
}

.preview-header p {
    margin: 0;
    color: #64748b;
    font-size: 14px;
}

.preview-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    padding: 24px;
    border-left: 4px solid #667eea;
}

.preview-card .announcement-header h3 {
    margin: 0 0 12px 0;
    color: #334155;
    font-size: 18px;
    font-weight: 600;
}

.preview-card .announcement-date {
    color: #64748b;
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 16px;
}

.preview-card .announcement-content {
    margin-bottom: 16px;
    color: #374151;
    line-height: 1.6;
}

.preview-card .announcement-footer {
    display: flex;
    align-items: center;
    gap: 12px;
}

.preview-card .announcement-type {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
}

.preview-card .announcement-type.info {
    background: #dbeafe;
    color: #1d4ed8;
}

.preview-card .announcement-type.important {
    background: #fef2f2;
    color: #dc2626;
}

.preview-card .announcement-type.event {
    background: #f0fdf4;
    color: #16a34a;
}

.preview-card .announcement-type.update {
    background: #fefce8;
    color: #ca8a04;
}

.preview-card .pinned-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    color: #7c3aed;
    font-size: 12px;
    font-weight: 600;
}

/* ===== Enhanced Image Upload Styles ===== */
.upload-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 48px 24px;
    color: #667eea;
}

.upload-loading i {
    font-size: 32px;
    margin-bottom: 16px;
}

.upload-loading p {
    margin: 0;
    font-weight: 500;
}

.enhanced-image-preview {
    display: flex;
    gap: 16px;
    padding: 16px;
    background: #f8fafc;
    border-radius: 8px;
    border: 2px solid #e2e8f0;
}

.image-container {
    position: relative;
    flex-shrink: 0;
}

.preview-img {
    width: 120px;
    height: 120px;
    object-fit: cover;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.image-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    opacity: 0;
    transition: opacity 0.2s ease;
}

.image-container:hover .image-overlay {
    opacity: 1;
}

.remove-image, .zoom-image {
    width: 32px;
    height: 32px;
    border: none;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s ease;
}

.remove-image {
    background: #dc2626;
    color: white;
}

.remove-image:hover {
    background: #b91c1c;
}

.zoom-image {
    background: #667eea;
    color: white;
}

.zoom-image:hover {
    background: #5b6ee8;
}

.image-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

.image-details h4 {
    margin: 0 0 4px 0;
    font-size: 14px;
    font-weight: 600;
    color: #334155;
}

.image-details p {
    margin: 0;
    font-size: 13px;
    color: #64748b;
}

.image-status {
    display: flex;
    align-items: center;
    gap: 6px;
    color: #059669;
    font-size: 13px;
    font-weight: 500;
}

/* ===== Image Zoom Modal ===== */
.image-zoom-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 10000;
    animation: modalFadeIn 0.3s ease-out;
}

.zoom-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    cursor: pointer;
}

.zoom-content {
    position: relative;
    max-width: 90vw;
    max-height: 90vh;
    cursor: default;
}

.zoom-content img {
    max-width: 100%;
    max-height: 100%;
    border-radius: 8px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
}

.zoom-close {
    position: absolute;
    top: -40px;
    right: 0;
    width: 32px;
    height: 32px;
    background: rgba(255, 255, 255, 0.2);
    border: none;
    border-radius: 6px;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s ease;
}

.zoom-close:hover {
    background: rgba(255, 255, 255, 0.3);
}

/* Alert Container */
#alertContainer {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
    max-width: 400px;
}

.alert {
    padding: 1rem;
    margin-bottom: 1rem;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.alert-success {
    background-color: #f0fdf4;
    border: 1px solid #16a34a;
    color: #16a34a;
}

.alert-error {
    background-color: #fef2f2;
    border: 1px solid #dc2626;
    color: #dc2626;
}

.close-alert {
    background: none;
    border: none;
    font-size: 1.2rem;
    cursor: pointer;
    padding: 0 0.5rem;
}

/* Loading State */
.loading {
    opacity: 0.7;
    pointer-events: none;
}

.loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 20px;
    height: 20px;
    margin: -10px 0 0 -10px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #2563eb;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Dashboard Header */
.dashboard-header {
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 1.5rem;
}

.header-content h1 {
    font-size: 1.8rem;
    color: #333;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.header-content p {
    color: #666;
    margin: 0.5rem 0 0;
}

.quick-actions {
    display: flex;
    gap: 1rem;
    margin-top: 1rem;
    align-items: center;
}

/* Search and Filter */
.search-box {
    position: relative;
    flex: 1;
}

.search-box input {
    padding-left: 2.5rem;
    border-radius: 6px;
}

.search-box i {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: #666;
}

.filter-box {
    width: 200px;
}

/* Announcement Cards */
.announcements-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1.5rem;
    padding: 1rem;
}

.announcement-card {
    background: white;
    border-radius: 12px;
    padding: 0;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    overflow: hidden;
    position: relative;
}

.card-status {
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
}

.card-status.important { background: #dc2626; }
.card-status.info { background: #2563eb; }
.card-status.event { background: #16a34a; }
.card-status.update { background: #7c3aed; }

.announcement-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

/* Image Section */
.announcement-image {
    position: relative;
    width: 100%;
    height: 200px;
    overflow: hidden;
}

.announcement-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
}

.image-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.zoom-icon {
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
}

.announcement-image:hover .image-overlay {
    opacity: 1;
}

.announcement-image:hover img {
    transform: scale(1.05);
}

/* Header Section */
.announcement-header {
    padding: 1.5rem 1.5rem 0;
}

.header-main {
    flex: 1;
}

.header-main h3 {
    margin: 0 0 0.5rem;
    color: #333;
    font-size: 1.2rem;
}

/* Content Section */
.announcement-content {
    padding: 1rem 1.5rem;
    color: #555;
    line-height: 1.6;
}

/* Footer Section */
.announcement-footer {
    padding: 1rem 1.5rem;
    background: #f8f9fa;
    border-top: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

/* Type Badges */
.announcement-type {
    padding: 0.4rem 0.8rem;
    border-radius: 50px;
    font-size: 0.875rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 500;
}

.announcement-type.important {
    background: #fef2f2;
    color: #dc2626;
}

.announcement-type.info {
    background: #eff6ff;
    color: #2563eb;
}

.announcement-type.event {
    background: #f0fdf4;
    color: #16a34a;
}

.announcement-type.update {
    background: #faf5ff;
    color: #7c3aed;
}

/* Form Styling */
.input-group {
    position: relative;
    display: flex;
}

.input-group-text {
    padding: 0.5rem 1rem;
    background: #f8f9fa;
    border: 1px solid #ddd;
    border-right: none;
    border-radius: 4px 0 0 4px;
    color: #666;
}

.input-group .form-control {
    border-radius: 0 4px 4px 0;
}

/* Upload Area */
.upload-area {
    border: 2px dashed #ddd;
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.upload-area:hover {
    border-color: #2563eb;
    background: #f8fafc;
}

.upload-placeholder {
    color: #666;
}

.upload-placeholder i {
    font-size: 2rem;
    color: #2563eb;
    margin-bottom: 1rem;
}

.upload-placeholder p {
    margin: 0.5rem 0;
    font-size: 1rem;
}

.upload-placeholder span {
    font-size: 0.875rem;
    color: #888;
}

/* Checkbox Styling */
.checkbox-group {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin-top: 2rem;
}

.checkbox-container {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    cursor: pointer;
    user-select: none;
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #333;
}

.checkbox-label i {
    color: #666;
}

/* Animation */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.fade-in {
    animation: fadeIn 0.3s ease forwards;
}

/* Image Preview Modal */
.image-preview-content {
    padding: 0;
    background: none;
    box-shadow: none;
    max-width: 90vw;
    width: auto;
}

.image-preview-content img {
    max-width: 100%;
    max-height: 90vh;
    border-radius: 8px;
}

/* Responsive Design */
@media (max-width: 768px) {
    .quick-actions {
        flex-direction: column;
        align-items: stretch;
    }
    
    .search-box, .filter-box {
        width: 100%;
    }
    
    .announcements-grid {
        grid-template-columns: 1fr;
    }
    
    .form-row {
        flex-direction: column;
    }
    
    .modal-content {
        width: 95%;
        margin: 1rem;
    }
}

/* Email Preview Modal Styles */
.email-preview {
    background: white;
    border-radius: 8px;
    border: 1px solid #ddd;
    overflow: hidden;
}

.email-header {
    background: #f8f9fa;
    padding: 1rem;
    border-bottom: 1px solid #ddd;
}

.email-field {
    margin-bottom: 0.5rem;
}

.email-field label {
    font-weight: 600;
    margin-right: 0.5rem;
    color: #666;
}

.email-content {
    padding: 1.5rem;
    min-height: 200px;
    max-height: 500px;
    overflow-y: auto;
}

/* Preview Button */
.btn-link {
    padding: 0;
    margin-top: 0.5rem;
    color: #2563eb;
    text-decoration: none;
}

.btn-link:hover {
    text-decoration: underline;
}
</style>

<script>
console.log('Announcements page script loaded');

// Global variables
let isSubmitting = false;

// Enhanced modal opener with modern UX
function openNewAnnouncementModal() {
    console.log('[CREATE] Opening new announcement modal');
    
    try {
        window.currentAnnouncementId = null;
        
        // Reset form and modal
        const form = document.getElementById('announcementForm');
        const modal = document.getElementById('announcementModal');
        
        if (!form || !modal) {
            console.error('[CREATE] Form or modal not found');
            return;
        }
        
        // Reset form
        form.reset();
        document.getElementById('modalTitle').textContent = 'New Announcement';
        
        // Clear TinyMCE content if available
        setTinyMCEContent('');
        
        // Clear image preview
        const imagePreview = document.getElementById('imagePreview');
        if (imagePreview) {
            imagePreview.innerHTML = '';
        }
        
        // Update character counter if available
        updateCharacterCounterSafe();
        
        // Set current date and time
        setDefaultDateTime();
        
        // Set default timezone
        const timezoneSelect = document.getElementById('timezone');
        if (timezoneSelect && !timezoneSelect.value) {
            timezoneSelect.value = 'Africa/Johannesburg';
        }
        
        // Show modal
        modal.style.display = 'block';
        
        // Focus on title field
        setTimeout(() => {
            const titleInput = document.getElementById('title');
            if (titleInput) {
                titleInput.focus();
            }
        }, 300);
        
        console.log('[CREATE] Modal opened successfully');
        
    } catch (error) {
        console.error('[CREATE] Error opening modal:', error);
        alert('Error opening announcement form. Please refresh the page.');
    }
}

// Safe character counter that doesn't break if elements are missing
function updateCharacterCounterSafe() {
    try {
        const titleInput = document.getElementById('title');
        const counter = document.querySelector('.char-counter');
        
        if (titleInput && counter) {
            const length = titleInput.value.length;
            const maxLength = titleInput.getAttribute('maxlength') || 100;
            counter.textContent = `${length}/${maxLength}`;
            
            // Update color based on usage
            if (length > maxLength * 0.8) {
                counter.style.color = '#dc2626';
            } else if (length > maxLength * 0.6) {
                counter.style.color = '#f59e0b';
            } else {
                counter.style.color = '#6b7280';
            }
        }
    } catch (error) {
        console.log('[DEBUG] Character counter not available');
    }
}

// Enhanced delete function
function deleteAnnouncement(id) {
    console.log(`[DELETE] Delete requested for announcement: ${id}`);
    
    if (confirm('Are you sure you want to delete this announcement? This action cannot be undone.')) {
        // Use form submission for proper CSRF protection
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/admin/announcements/${id}/delete`;
        
        // Add CSRF token if available
        const csrfToken = document.querySelector('meta[name="csrf-token"]');
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = csrfToken.getAttribute('content');
            form.appendChild(csrfInput);
        }
        
        document.body.appendChild(form);
        form.submit();
    }
}

// Enhanced edit function  
function editAnnouncement(id) {
    console.log(`[EDIT] Edit requested for announcement: ${id}`);
    
    // Fetch announcement data from server
    fetch(`/admin/announcements/${id}`)
        .then(response => {
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return response.json();
        })
        .then(data => {
            if (!data.success) {
                throw new Error(data.error || 'Failed to fetch announcement');
            }
            
            const announcement = data.announcement;
            console.log('[EDIT] Announcement data loaded');
            
            // Set global variable for form submission
            window.currentAnnouncementId = id;
            
            // Populate form
            document.getElementById('modalTitle').textContent = 'Edit Announcement';
            document.getElementById('title').value = announcement.title || '';
            
            // Set TinyMCE content
            setTinyMCEContent(announcement.content || '');
            
            // Update character counter
            updateCharacterCounterSafe();
            
            // Set other fields
            document.getElementById('type').value = announcement.type || 'info';
            document.getElementById('is_pinned').checked = announcement.is_pinned || false;
            
            // Set date and time
            if (announcement.scheduled_date) {
                document.getElementById('announcement_date').value = announcement.scheduled_date;
            } else {
                setDefaultDateTime();
            }
            
            if (announcement.scheduled_time) {
                document.getElementById('announcement_time').value = announcement.scheduled_time;
            }
            
            if (announcement.timezone) {
                document.getElementById('timezone').value = announcement.timezone;
            }
            
            // Handle existing image
            const imagePreview = document.getElementById('imagePreview');
            if (imagePreview) {
                if (announcement.image_url) {
                    imagePreview.innerHTML = `
                        <div class="existing-image-preview">
                            <img src="${announcement.image_url}" alt="Current image" style="max-width: 200px; border-radius: 8px;">
                            <p style="margin: 8px 0 0 0; font-size: 13px; color: #64748b;">Current image (upload new to replace)</p>
                        </div>
                    `;
                } else {
                    imagePreview.innerHTML = '';
                }
            }
            
            // Show modal
            document.getElementById('announcementModal').style.display = 'block';
            
            // Focus on title
            setTimeout(() => {
                document.getElementById('title').focus();
            }, 300);
            
        })
        .catch(error => {
            console.error('[EDIT] Error loading announcement:', error);
            alert(`Error loading announcement: ${error.message}`);
        });
}

// Close modal function
function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'none';
        
        // Clear any validation states when closing
        if (modalId === 'announcementModal') {
            clearValidationStates();
        }
    }
}

// Clear validation states
function clearValidationStates() {
    try {
        const feedbacks = document.querySelectorAll('.field-feedback');
        feedbacks.forEach(feedback => feedback.remove());
        
        const inputs = document.querySelectorAll('.enhanced-input');
        inputs.forEach(input => {
            input.style.borderColor = '#e2e8f0';
            input.style.boxShadow = 'none';
        });
    } catch (error) {
        console.log('[DEBUG] Validation states cleanup skipped');
    }
}

// Set default date and time
function setDefaultDateTime() {
    const dateInput = document.getElementById('announcement_date');
    const timeInput = document.getElementById('announcement_time');
    
    if (dateInput && timeInput) {
        const now = new Date();
        
        // Format date as YYYY-MM-DD
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        dateInput.value = `${year}-${month}-${day}`;
        
        // Format time as HH:MM
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        timeInput.value = `${hours}:${minutes}`;
    }
}

// Load TinyMCE from CDN first
const tinymceScript = document.createElement('script');
tinymceScript.src = 'https://cdn.tiny.cloud/1/{{ tinymce_api_key or "no-api-key" }}/tinymce/6/tinymce.min.js';
tinymceScript.onload = function() {
    // Initialize TinyMCE after loading with simpler plugin list
    tinymce.init({
        selector: '.rich-editor',
        height: 300,
        menubar: false,
        api_key: '{{ tinymce_api_key or "no-api-key" }}',
        plugins: 'lists link code',
        toolbar: 'undo redo | formatselect | bold italic | alignleft aligncenter alignright | bullist numlist | link | code'
    });
};
document.head.appendChild(tinymceScript);

// Helper function to safely get TinyMCE content
function getTinyMCEContent() {
    if (typeof tinymce === 'undefined') {
        const textarea = document.getElementById('content');
        return textarea ? textarea.value : '';
    }
    const editor = tinymce.get('content');
    return editor ? editor.getContent() : '';
}

// Helper function to safely set TinyMCE content
function setTinyMCEContent(content) {
    if (typeof tinymce === 'undefined') {
        const textarea = document.getElementById('content');
        if (textarea) textarea.value = content;
    } else {
        const editor = tinymce.get('content');
        if (editor) editor.setContent(content);
    }
}

// Enhanced helper functions for better UX
function setupEnhancedImageUpload() {
    const uploadArea = document.querySelector('.modern-upload');
    const fileInput = document.getElementById('image');
    
    if (!uploadArea || !fileInput) return;
    
    // Drag and drop handlers
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = '#667eea';
        uploadArea.style.background = '#fafbff';
    });
    
    uploadArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = '#cbd5e1';
        uploadArea.style.background = '#f8fafc';
    });
    
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = '#cbd5e1';
        uploadArea.style.background = '#f8fafc';
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            const file = files[0];
            if (file.type.startsWith('image/')) {
                fileInput.files = files;
                validateAndPreviewImage({ target: fileInput });
            } else {
                showAlert('error', 'Please upload only image files (PNG, JPG, JPEG, GIF)');
            }
        }
    });
}

function initializeEnhancedTinyMCE() {
    // Load TinyMCE if not already loaded
    if (typeof tinymce === 'undefined') {
        const script = document.createElement('script');
        script.src = 'https://cdn.tiny.cloud/1/{{ tinymce_api_key or "no-api-key" }}/tinymce/6/tinymce.min.js';
        script.onload = () => {
            setTimeout(initTinyMCE, 100);
        };
        document.head.appendChild(script);
    } else {
        initTinyMCE();
    }
}

function initTinyMCE() {
    tinymce.init({
        selector: '#content',
        height: 300,
        api_key: '{{ tinymce_api_key or "no-api-key" }}',
        plugins: 'lists link image code wordcount',
        toolbar: 'undo redo | formatselect | bold italic | alignleft aligncenter alignright | bullist numlist | link image | code | wordcount',
        menubar: false,
        branding: false,
        content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; font-size: 14px; line-height: 1.6; }',
        setup: function(editor) {
            editor.on('input change', function() {
                // Trigger content validation when TinyMCE content changes
                setTimeout(() => {
                    const textarea = document.getElementById('content');
                    validateFormField(textarea);
                }, 100);
            });
        }
    });
}

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    initializeForm();
    initializeSearch();
    initializeImageHandling();
    initializeModals();
});

function initializeForm() {
    const form = document.getElementById('announcementForm');
    if (form) {
        form.addEventListener('submit', handleSubmit);
    }
    
    // Set up character counter for title field if available
    const titleInput = document.getElementById('title');
    if (titleInput) {
        titleInput.addEventListener('input', updateCharacterCounterSafe);
        updateCharacterCounterSafe(); // Initialize counter
    }
    
    // Set up modal close handlers
    setupModalHandlers();
    
    setDefaultDateTime();
}

// Modal handlers setup
function setupModalHandlers() {
    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
        const modal = document.getElementById('announcementModal');
        if (event.target === modal) {
            closeModal('announcementModal');
        }
    });
    
    // Close modal with Escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            const modal = document.getElementById('announcementModal');
            if (modal && modal.style.display === 'block') {
                closeModal('announcementModal');
            }
        }
    });
}

function initializeSearch() {
    const searchInput = document.getElementById('searchAnnouncements');
    const filterSelect = document.getElementById('filterType');
    
    searchInput.addEventListener('input', debounce(filterAnnouncements, 300));
    filterSelect.addEventListener('change', filterAnnouncements);
}

function initializeImageHandling() {
    const uploadArea = document.querySelector('.upload-area');
    const imageInput = document.getElementById('image');

    if (uploadArea && imageInput) {
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('dragleave', handleDragLeave);
        uploadArea.addEventListener('drop', handleDrop);
        imageInput.addEventListener('change', validateAndPreviewImage);
    }
}

// Drag and drop handlers
function handleDragOver(e) {
    e.preventDefault();
    e.stopPropagation();
    e.currentTarget.classList.add('dragover');
}

function handleDragLeave(e) {
    e.preventDefault();
    e.stopPropagation();
    e.currentTarget.classList.remove('dragover');
}

function handleDrop(e) {
    e.preventDefault();
    e.stopPropagation();
    const uploadArea = e.currentTarget;
    uploadArea.classList.remove('dragover');
    
    const files = e.dataTransfer.files;
    if (files && files.length > 0) {
        const imageInput = document.getElementById('image');
        imageInput.files = files;
        validateAndPreviewImage({ target: imageInput });
    }
}

function validateAndPreviewImage(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Validate file type
    if (!file.type.startsWith('image/')) {
        showAlert('error', 'Please select an image file');
        event.target.value = '';
        return;
    }
    
    // Validate file size (max 5MB)
    if (file.size > 5 * 1024 * 1024) {
        showAlert('error', 'Image size must be less than 5MB');
        event.target.value = '';
        return;
    }
    
    // Preview image
    previewImage(event);
}

function initializeModals() {
    const modals = document.querySelectorAll('.modal');
    const closeButtons = document.querySelectorAll('.close-modal');

    window.onclick = function(event) {
        modals.forEach(modal => {
            if (event.target == modal) {
                closeModal(modal.id);
            }
        });
    };

    closeButtons.forEach(button => {
        button.addEventListener('click', () => {
            closeModal(button.closest('.modal').id);
        });
    });
}

// Form submission handler
async function handleSubmit(event) {
    event.preventDefault();
    if (isSubmitting) return;

    const form = event.target;
    const submitButton = form.querySelector('#submitButton');
    
    try {
        isSubmitting = true;
        submitButton.classList.add('loading');
        
        // Clear any existing validation feedback
        clearAllFieldValidation();
        
        if (!validateForm(form)) {
            isSubmitting = false;
            submitButton.classList.remove('loading');
            return;
        }

        const formData = new FormData(form);
        
        // Get TinyMCE content and add it to formData
        const content = getTinyMCEContent();
        formData.set('content', content);
        
        const url = window.currentAnnouncementId 
            ? `/admin/announcements/${window.currentAnnouncementId}`
            : '/admin/announcements';
        
        console.log('Submitting announcement:', {
            title: formData.get('title'),
            content: formData.get('content'),
            type: formData.get('type'),
            date: formData.get('announcement_date'),
            time: formData.get('announcement_time')
        });
        
        const response = await fetch(url, {
            method: window.currentAnnouncementId ? 'PUT' : 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json'
            }
        });

        const data = await response.json();
        console.log('Server response:', data);
        
        if (data.success) {
            let message = 'Announcement saved successfully!';
            if (data.emailStatus) {
                message += ` ${data.emailStatus}`;
            }
            showAlert('success', message);
            
            // Close the modal
            closeModal('announcementModal');
            
            // Redirect to announcements page after a short delay
            setTimeout(() => {
                window.location.href = data.redirect;
            }, 1500);
        } else {
            throw new Error(data.error || 'Error saving announcement');
        }
    } catch (error) {
        console.error('Error:', error);
        showAlert('error', `Error: ${error.message}`);
    } finally {
        isSubmitting = false;
        submitButton.classList.remove('loading');
    }
}

// Utility functions
function validateForm(form) {
    const title = form.title.value.trim();
    const content = getTinyMCEContent().trim();
    const date = form.announcement_date.value;
    const time = form.announcement_time.value;
    
    let isValid = true;
    
    // Enhanced validation with visual feedback
    if (!validateFormField(form.title)) isValid = false;
    if (!validateFormField(form.announcement_date)) isValid = false;
    if (!validateFormField(form.announcement_time)) isValid = false;
    if (!validateFormField(document.getElementById('content'))) isValid = false;
    
    if (!isValid) {
        showAlert('error', 'Please fix the errors above before submitting.');
        return false;
    }
    
    // Additional validation
    if (!title) {
        showAlert('error', 'Please enter a title');
        return false;
    }
    
    if (!content) {
        showAlert('error', 'Please enter content');
        return false;
    }
    
    if (!date || !time) {
        showAlert('error', 'Please set both date and time');
        return false;
    }
    
    const selectedDateTime = new Date(`${date}T${time}`);
    if (isNaN(selectedDateTime.getTime())) {
        showAlert('error', 'Invalid date or time');
        return false;
    }
    
    return true;
}

function clearAllFieldValidation() {
    const feedbacks = document.querySelectorAll('.field-feedback');
    feedbacks.forEach(feedback => feedback.remove());
    
    // Reset all field styling
    const fields = document.querySelectorAll('.enhanced-input');
    fields.forEach(field => {
        field.style.borderColor = '#e2e8f0';
        field.style.boxShadow = 'none';
    });
}

function validateAndPreviewImage(event) {
    const file = event.target.files[0];
    const uploadArea = document.querySelector('.modern-upload');
    const placeholder = document.getElementById('uploadPlaceholder');
    const preview = document.getElementById('imagePreview');
    
    if (!file) return;

    // Show loading state
    placeholder.style.display = 'none';
    preview.innerHTML = `
        <div class="upload-loading">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Processing image...</p>
        </div>
    `;

    // Validate file type
    const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
    if (!validTypes.includes(file.type)) {
        showAlert('error', 'Please upload a valid image file (PNG, JPG, GIF, or WebP)');
        resetImageUpload();
        return;
    }

    // Validate file size (5MB)
    if (file.size > 5 * 1024 * 1024) {
        showAlert('error', 'Image size should not exceed 5MB');
        resetImageUpload();
        return;
    }

    // Create image preview with enhanced UI
    setTimeout(() => {
        previewImageEnhanced(file);
    }, 500); // Small delay to show loading state
}

function previewImageEnhanced(file) {
    const reader = new FileReader();
    const preview = document.getElementById('imagePreview');
    
    reader.onload = function(e) {
        const fileSize = (file.size / 1024 / 1024).toFixed(2);
        const fileName = file.name.length > 30 ? file.name.substring(0, 27) + '...' : file.name;
        
        preview.innerHTML = `
            <div class="enhanced-image-preview">
                <div class="image-container">
                    <img src="${e.target.result}" alt="Preview" class="preview-img">
                    <div class="image-overlay">
                        <button type="button" class="remove-image" onclick="removeImagePreview()">
                            <i class="fas fa-times"></i>
                        </button>
                        <button type="button" class="zoom-image" onclick="zoomImage('${e.target.result}')">
                            <i class="fas fa-search-plus"></i>
                        </button>
                    </div>
                </div>
                <div class="image-info">
                    <div class="image-details">
                        <h4>${fileName}</h4>
                        <p>${fileSize} MB ‚Ä¢ ${file.type.split('/')[1].toUpperCase()}</p>
                    </div>
                    <div class="image-status">
                        <i class="fas fa-check-circle"></i>
                        <span>Ready to upload</span>
                    </div>
                </div>
            </div>
        `;
    };
    
    reader.readAsDataURL(file);
}

function resetImageUpload() {
    const fileInput = document.getElementById('image');
    const placeholder = document.getElementById('uploadPlaceholder');
    const preview = document.getElementById('imagePreview');
    
    fileInput.value = '';
    placeholder.style.display = 'block';
    preview.innerHTML = '';
}

function removeImagePreview() {
    resetImageUpload();
    showAlert('info', 'Image removed');
}

function zoomImage(src) {
    // Create zoom modal
    const zoomModal = document.createElement('div');
    zoomModal.className = 'image-zoom-modal';
    zoomModal.innerHTML = `
        <div class="zoom-backdrop" onclick="this.parentElement.remove()">
            <div class="zoom-content">
                <img src="${src}" alt="Zoomed image">
                <button class="zoom-close" onclick="this.parentElement.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(zoomModal);
}

function showAlert(type, message) {
    const alertContainer = document.getElementById('alertContainer');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} fade-in`;
    alert.innerHTML = `
        ${message}
        <button type="button" class="close-alert" onclick="this.parentElement.remove();">√ó</button>
    `;
    alertContainer.appendChild(alert);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        alert.remove();
    }, 5000);
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function setDefaultDateTime() {
    const now = new Date();
    const dateInput = document.getElementById('announcement_date');
    const timeInput = document.getElementById('announcement_time');
    
    // Format date as YYYY-MM-DD
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    dateInput.value = `${year}-${month}-${day}`;
    
    // Format time as HH:MM
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    timeInput.value = `${hours}:${minutes}`;
}

function openNewAnnouncementModal() {
    console.log('[DEBUG] openNewAnnouncementModal called');
    
    try {
        window.currentAnnouncementId = null;
        
        // Check if modal exists
        const modal = document.getElementById('announcementModal');
        if (!modal) {
            console.error('[ERROR] Modal element not found');
            alert('Error: Modal element not found. Please refresh the page.');
            return;
        }
        
        // Check if form exists
        const form = document.getElementById('announcementForm');
        if (!form) {
            console.error('[ERROR] Form element not found');
            alert('Error: Form element not found. Please refresh the page.');
            return;
        }
        
        document.getElementById('modalTitle').textContent = 'New Announcement';
        form.reset();
        console.log('[DEBUG] Form reset completed');
        
        // Clear TinyMCE content
        console.log('[DEBUG] Clearing TinyMCE content');
        setTinyMCEContent('');
        
        // Clear image preview
        console.log('[DEBUG] Clearing image preview');
        const imagePreview = document.getElementById('imagePreview');
        if (imagePreview) {
            imagePreview.innerHTML = '';
        }
        
        // Reset character counter
        console.log('[DEBUG] Updating character counter');
        updateCharacterCounter();
        
        // Update submit button text for create mode
        console.log('[DEBUG] Updating submit button');
        updateSubmitButton('create');
        
        // Set default date and time
        console.log('[DEBUG] Setting default date/time');
        setDefaultDateTime();
        
        // Set default timezone if not already selected
        const timezoneSelect = document.getElementById('timezone');
        if (timezoneSelect && !timezoneSelect.value) {
            timezoneSelect.value = 'Africa/Johannesburg'; // Default to SAST
        }
        
        // Add helpful tooltips
        console.log('[DEBUG] Adding tooltips');
        addFormTooltips();
        
        // Show the modal
        console.log('[DEBUG] Showing modal');
        modal.style.display = 'block';
        
        // Focus on title field when modal opens
        setTimeout(() => {
            const titleInput = document.getElementById('title');
            if (titleInput) {
                titleInput.focus();
                console.log('[DEBUG] Title input focused');
            }
        }, 300);
        
        console.log('[CREATE] New announcement modal opened successfully');
        
    } catch (error) {
        console.error('[ERROR] Exception in openNewAnnouncementModal:', error);
        alert('Error opening modal: ' + error.message);
    }
}

// Add helpful tooltips and enhanced UX
function addFormTooltips() {
    const tooltips = {
        'type': 'Choose the appropriate type to help users quickly identify the announcement',
        'is_pinned': 'Pinned announcements stay at the top of the list for better visibility',
        'send_email': 'Email notifications will be sent to all registered users immediately',
        'timezone': 'Select the timezone for your announcement to ensure accurate display'
    };
    
    Object.entries(tooltips).forEach(([fieldId, tooltip]) => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.title = tooltip;
        }
    });
}

// Smart defaults based on announcement type
function setSmartDefaults() {
    const typeSelect = document.getElementById('type');
    const isPinnedCheckbox = document.getElementById('is_pinned');
    const sendEmailCheckbox = document.getElementById('send_email');
    
    typeSelect.addEventListener('change', function() {
        const selectedType = this.value;
        
        // Auto-pin important announcements
        if (selectedType === 'important') {
            isPinnedCheckbox.checked = true;
            showAlert('info', 'Important announcements are automatically pinned to the top.', 3000);
        }
        
        // Auto-enable email for important announcements
        if (selectedType === 'important' || selectedType === 'event') {
            sendEmailCheckbox.checked = true;
        }
    });
}

// Character counter functionality
function updateCharacterCounter() {
    const titleInput = document.getElementById('title');
    const counter = document.querySelector('.char-counter');
    
    if (!titleInput) {
        console.log('[DEBUG] Title input not found');
        return;
    }
    
    if (!counter) {
        console.log('[DEBUG] Character counter element not found');
        return;
    }
    
    const length = titleInput.value.length;
    const maxLength = titleInput.getAttribute('maxlength') || 100;
    counter.textContent = `${length}/${maxLength}`;
    
    // Update color based on usage
    if (length > maxLength * 0.8) {
        counter.style.color = '#dc2626'; // Red when approaching limit
    } else if (length > maxLength * 0.6) {
        counter.style.color = '#f59e0b'; // Orange when getting close
    } else {
        counter.style.color = '#6b7280'; // Gray default
    }
    
    console.log(`[DEBUG] Character counter updated: ${length}/${maxLength}`);
}

// Update submit button text and state
function updateSubmitButton(mode) {
    const submitButton = document.getElementById('submitButton');
    if (!submitButton) {
        console.log('[DEBUG] Submit button not found');
        return;
    }
    
    const btnText = submitButton.querySelector('.btn-text');
    const loadingText = submitButton.querySelector('.loading-text');
    
    if (!btnText || !loadingText) {
        console.log('[DEBUG] Button text elements not found', { btnText, loadingText });
        return;
    }
    
    if (mode === 'create') {
        btnText.textContent = 'Create Announcement';
        loadingText.textContent = 'Creating...';
    } else if (mode === 'edit') {
        btnText.textContent = 'Update Announcement';
        loadingText.textContent = 'Updating...';
    }
    
    console.log(`[DEBUG] Submit button updated for ${mode} mode`);
}

// Enhanced form validation with visual feedback
function validateFormField(field) {
    const value = field.value.trim();
    const fieldName = field.name;
    let isValid = true;
    let message = '';
    
    // Remove existing validation feedback
    removeFieldValidation(field);
    
    switch (fieldName) {
        case 'title':
            if (!value) {
                isValid = false;
                message = 'Title is required';
            } else if (value.length < 3) {
                isValid = false;
                message = 'Title must be at least 3 characters';
            } else if (value.length > 100) {
                isValid = false;
                message = 'Title must not exceed 100 characters';
            }
            break;
            
        case 'content':
            const content = getTinyMCEContent().trim();
            if (!content) {
                isValid = false;
                message = 'Content is required';
            } else if (content.length < 10) {
                isValid = false;
                message = 'Content must be at least 10 characters';
            }
            break;
            
        case 'announcement_date':
            if (!value) {
                isValid = false;
                message = 'Date is required';
            } else {
                const selectedDate = new Date(value);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                if (selectedDate < today) {
                    isValid = false;
                    message = 'Date cannot be in the past';
                }
            }
            break;
            
        case 'announcement_time':
            if (!value) {
                isValid = false;
                message = 'Time is required';
            }
            break;
    }
    
    // Apply validation feedback
    if (!isValid) {
        showFieldValidation(field, message, 'error');
    } else {
        showFieldValidation(field, 'Looks good!', 'success');
    }
    
    return isValid;
}

// Show field validation feedback
function showFieldValidation(field, message, type) {
    const wrapper = field.closest('.form-group') || field.closest('.input-group').parentElement;
    const feedback = document.createElement('div');
    feedback.className = `field-feedback field-feedback-${type}`;
    feedback.innerHTML = `
        <i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'check-circle'}"></i>
        <span>${message}</span>
    `;
    
    // Add appropriate styling to the input
    if (type === 'error') {
        field.style.borderColor = '#dc2626';
        field.style.boxShadow = '0 0 0 3px rgba(220, 38, 38, 0.1)';
    } else {
        field.style.borderColor = '#059669';
        field.style.boxShadow = '0 0 0 3px rgba(5, 150, 105, 0.1)';
    }
    
    wrapper.appendChild(feedback);
    
    // Auto-remove success feedback after 3 seconds
    if (type === 'success') {
        setTimeout(() => {
            if (feedback.parentElement) {
                removeFieldValidation(field);
            }
        }, 3000);
    }
}

// Remove field validation feedback
function removeFieldValidation(field) {
    const wrapper = field.closest('.form-group') || field.closest('.input-group').parentElement;
    const existingFeedback = wrapper.querySelector('.field-feedback');
    if (existingFeedback) {
        existingFeedback.remove();
    }
    
    // Reset field styling
    field.style.borderColor = '#e2e8f0';
    field.style.boxShadow = 'none';
}

// Preview announcement functionality
function previewAnnouncement() {
    const title = document.getElementById('title').value.trim();
    const content = getTinyMCEContent().trim();
    const type = document.getElementById('type').value;
    const date = document.getElementById('announcement_date').value;
    const time = document.getElementById('announcement_time').value;
    const timezone = document.getElementById('timezone').value;
    const isPinned = document.getElementById('is_pinned').checked;
    
    if (!title || !content) {
        showAlert('warning', 'Please fill in title and content to preview the announcement.');
        return;
    }
    
    // Create preview modal content
    const previewContent = `
        <div class="announcement-preview">
            <div class="preview-header">
                <h3>Announcement Preview</h3>
                <p>This is how your announcement will appear to users</p>
            </div>
            <div class="preview-card">
                <div class="card-status ${type}"></div>
                <div class="announcement-header">
                    <div class="header-main">
                        <h3>${title}</h3>
                        <span class="announcement-date">
                            <i class="fas fa-calendar"></i> ${date}
                            <i class="fas fa-clock ms-2"></i> ${time}
                            <span class="timezone-badge">${timezone}</span>
                        </span>
                    </div>
                </div>
                <div class="announcement-content">${content}</div>
                <div class="announcement-footer">
                    <span class="announcement-type ${type}">
                        <i class="fas fa-${type === 'important' ? 'exclamation-circle' : 
                            type === 'info' ? 'info-circle' : 
                            type === 'event' ? 'calendar-alt' : 'bell'}"></i>
                        ${type.charAt(0).toUpperCase() + type.slice(1)}
                    </span>
                    ${isPinned ? '<span class="pinned-badge"><i class="fas fa-thumbtack"></i> Pinned</span>' : ''}
                </div>
            </div>
        </div>
    `;
    
    // Show preview in a modal or alert
    showAlert('info', previewContent, 8000);
}

function editAnnouncement(id) {
    console.log(`[EDIT] Starting edit for announcement: ${id}`);
    
    // Fetch announcement data from server
    fetch(`/admin/announcements/${id}`)
        .then(response => {
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return response.json();
        })
        .then(data => {
            if (!data.success) {
                throw new Error(data.error || 'Failed to fetch announcement');
            }
            
            const announcement = data.announcement;
            console.log(`[EDIT] Announcement data loaded:`, announcement);
            
            // Set global variable for form submission
            window.currentAnnouncementId = id;
            
            // Update modal for edit mode
            document.getElementById('modalTitle').textContent = 'Edit Announcement';
            updateSubmitButton('edit');
            
            // Populate form fields
            document.getElementById('title').value = announcement.title || '';
            
            // Update character counter
            updateCharacterCounter();
            
            // Set TinyMCE content safely
            setTinyMCEContent(announcement.content || '');
            
            document.getElementById('type').value = announcement.type || 'general';
            document.getElementById('is_pinned').checked = announcement.is_pinned || false;
            
            // Set date and time if they exist
            if (announcement.scheduled_date) {
                document.getElementById('announcement_date').value = announcement.scheduled_date;
            } else {
                setDefaultDateTime(); // Set current date/time if none exists
            }
            
            if (announcement.scheduled_time) {
                document.getElementById('announcement_time').value = announcement.scheduled_time;
            }
            
            if (announcement.timezone) {
                document.getElementById('timezone').value = announcement.timezone;
            } else {
                document.getElementById('timezone').value = 'Africa/Johannesburg'; // Default to SAST
            }
            
            // Clear any previous image preview
            document.getElementById('imagePreview').innerHTML = '';
            
            // Show existing image if available
            if (announcement.image_url) {
                document.getElementById('imagePreview').innerHTML = 
                    `<img src="${announcement.image_url}" alt="Current image"><p>Current image (upload new to replace)</p>`;
            }
            
            // Show the modal
            document.getElementById('announcementModal').style.display = 'block';
            console.log(`[EDIT] Modal opened for editing`);
        })
        .catch(error => {
            console.error(`[EDIT] Error loading announcement:`, error);
            alert(`Error loading announcement for editing: ${error.message}`);
        });
}

function deleteAnnouncement(id) {
    // Get the announcement title for the confirmation
    const card = document.querySelector(`[data-id="${id}"]`);
    const title = card ? card.querySelector('h3').textContent : 'this announcement';
    
    // Simple, reliable confirmation dialog
    if (confirm(`Are you sure you want to delete "${title}"?\n\nThis action cannot be undone.`)) {
        
        console.log(`[DELETE] Starting deletion for announcement: ${id}`);
        
        fetch(`/admin/announcements/${id}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            console.log(`[DELETE] Response status: ${response.status}`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return response.json();
        })
        .then(data => {
            console.log(`[DELETE] Response data:`, data);
            if (data.success) {
                console.log(`[DELETE] Success! Reloading page...`);
                location.reload();
            } else {
                const errorMsg = data.error || 'Unknown error occurred';
                console.error(`[DELETE] Error: ${errorMsg}`);
                alert(`Error deleting announcement: ${errorMsg}`);
            }
        })
        .catch(error => {
            console.error(`[DELETE] Catch error:`, error);
            alert(`Error deleting announcement: ${error.message}`);
        });
    }
}

function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}

function previewImage(event) {
    const preview = document.getElementById('imagePreview');
    const file = event.target.files[0];
    
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
        }
        reader.readAsDataURL(file);
    } else {
        preview.innerHTML = '';
    }
}

function formatDateTime(date, time, timezone) {
    try {
        const dateTimeStr = `${date}T${time}`;
        const dateObj = new Date(dateTimeStr);
        
        if (isNaN(dateObj.getTime())) {
            throw new Error('Invalid date/time');
        }
        
        const options = {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            timeZone: timezone
        };
        
        return new Intl.DateTimeFormat('en-US', options).format(dateObj);
    } catch (error) {
        console.error('Error formatting date/time:', error);
        return `${date} ${time} ${timezone}`;
    }
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
    window.currentAnnouncementId = null;
}

// Add these new functions for search and filter
function filterAnnouncements() {
    const searchTerm = document.getElementById('searchAnnouncements').value.toLowerCase();
    const filterType = document.getElementById('filterType').value;
    const cards = document.querySelectorAll('.announcement-card');
    
    cards.forEach(card => {
        const title = card.querySelector('h3').textContent.toLowerCase();
        const content = card.querySelector('.announcement-content').textContent.toLowerCase();
        const type = card.dataset.type;
        
        const matchesSearch = title.includes(searchTerm) || content.includes(searchTerm);
        const matchesType = filterType === 'all' || type === filterType;
        
        if (matchesSearch && matchesType) {
            card.style.display = 'block';
            card.style.animation = 'fadeIn 0.3s ease forwards';
        } else {
            card.style.display = 'none';
        }
    });
}

// Image preview modal functionality
document.querySelectorAll('.announcement-image').forEach(image => {
    image.addEventListener('click', function() {
        const imgSrc = this.querySelector('img').src;
        document.getElementById('previewImage').src = imgSrc;
        document.getElementById('imagePreviewModal').style.display = 'block';
    });
});

// Drag and drop functionality for image upload
const uploadArea = document.querySelector('.upload-area');

uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    const file = e.dataTransfer.files[0];
    if (file && file.type.startsWith('image/')) {
        document.getElementById('image').files = e.dataTransfer.files;
        previewImage({ target: { files: [file] } });
    }
});

async function previewEmail() {
    const title = document.getElementById('title').value.trim();
    const content = getTinyMCEContent().trim();
    
    if (!title || !content) {
        showAlert('error', 'Please fill in the title and content first');
        return;
    }

    try {
        // Fetch email settings
        const response = await fetch('/admin/get-email-settings');
        const settings = await response.json();
        
        if (!settings.success) {
            showAlert('error', 'Email settings not configured. Please configure email settings first.');
            return;
        }

        // Update preview modal
        document.getElementById('emailFrom').textContent = settings.sender;
        document.getElementById('emailSubject').textContent = `[GIIR Conference] ${title}`;
        
        // Create email content with template
        const emailContent = `
            <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
                <h2 style="color: #333;">${title}</h2>
                <div style="color: #555; line-height: 1.6;">
                    ${content}
                </div>
                <hr style="border: none; border-top: 1px solid #ddd; margin: 20px 0;">
                <p style="color: #666; font-size: 0.9em;">
                    This announcement was sent from GIIR Conference.
                    Please do not reply to this email.
                </p>
            </div>
        `;
        
        document.getElementById('emailContent').innerHTML = emailContent;
        document.getElementById('emailPreviewModal').style.display = 'block';
    } catch (error) {
        showAlert('error', 'Error loading email preview: ' + error.message);
    }
}
</script>
{% endblock %} 