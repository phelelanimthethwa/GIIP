{% extends "admin/base_admin.html" %}

{% block title %}Manage Announcements - Admin{% endblock %}

{% block content %}
<div class="admin-dashboard">
    <div class="dashboard-header">
        <div class="header-content">
            <h1><i class="fas fa-bullhorn"></i> Manage Announcements</h1>
            <p>Create and manage conference announcements</p>
        </div>
        <div class="quick-actions">
            <div class="search-box">
                <input type="text" id="searchAnnouncements" placeholder="Search announcements..." class="form-control">
                <i class="fas fa-search"></i>
            </div>
            <div class="filter-box">
                <select id="filterType" class="form-control">
                    <option value="all">All Types</option>
                    <option value="important">Important</option>
                    <option value="info">Information</option>
                    <option value="event">Event</option>
                    <option value="update">Update</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="openNewAnnouncementModal()">
                <i class="fas fa-plus"></i> New Announcement
            </button>
        </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} fade-in">
                    {{ message }}
                    <button type="button" class="close-alert" onclick="this.parentElement.remove();">Ã—</button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="content-section">
        <div class="announcements-grid">
            {% if announcements %}
                {% for id, announcement in announcements.items() %}
                    <div class="announcement-card" data-id="{{ id }}" data-type="{{ announcement.type }}">
                        <div class="card-status {{ announcement.type }}"></div>
                        {% if announcement.image_url %}
                        <div class="announcement-image">
                            <img src="{{ announcement.image_url }}" alt="Announcement image">
                            <div class="image-overlay">
                                <span class="zoom-icon"><i class="fas fa-search-plus"></i></span>
                            </div>
                        </div>
                        {% endif %}
                        <div class="announcement-header">
                            <div class="header-main">
                                <h3>{{ announcement.title }}</h3>
                                <span class="announcement-date">
                                    <i class="fas fa-calendar"></i> {{ announcement.scheduled_date|datetime if announcement.scheduled_date else announcement.created_at|datetime }}
                                    {% if announcement.scheduled_time %}
                                    <i class="fas fa-clock ms-2"></i> {{ announcement.scheduled_time }}
                                    <span class="timezone-badge">{{ announcement.timezone }}</span>
                                    {% endif %}
                                </span>
                            </div>
                            <div class="announcement-actions">
                                <button class="btn-icon" onclick="editAnnouncement('{{ id }}')" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-icon delete" onclick="deleteAnnouncement('{{ id }}')" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="announcement-content">{{ announcement.content }}</div>
                        <div class="announcement-footer">
                            <span class="announcement-type {{ announcement.type }}">
                                <i class="fas fa-{{ 'exclamation-circle' if announcement.type == 'important' 
                                    else 'info-circle' if announcement.type == 'info' 
                                    else 'calendar-alt' if announcement.type == 'event' 
                                    else 'bell' }}"></i>
                                {{ announcement.type|title }}
                            </span>
                            {% if announcement.is_pinned %}
                            <span class="pinned-badge">
                                <i class="fas fa-thumbtack"></i> Pinned
                            </span>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="no-data">
                    <i class="fas fa-bullhorn"></i>
                    <p>No announcements yet</p>
                    <button class="btn btn-primary" onclick="openNewAnnouncementModal()">Create First Announcement</button>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Image Preview Modal -->
<div id="imagePreviewModal" class="modal">
    <div class="modal-content image-preview-content">
        <button class="close-modal">&times;</button>
        <img id="previewImage" src="" alt="Preview">
    </div>
</div>

<!-- Announcement Modal -->
<div id="announcementModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">New Announcement</h2>
            <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
            <form id="announcementForm" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="title">Title</label>
                    <input type="text" id="title" name="title" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="content">Content</label>
                    <textarea id="content" name="content" class="form-control rich-editor" rows="6" required></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-4">
                        <label for="announcement_date">Date</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                            <input type="date" id="announcement_date" name="announcement_date" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-group col-md-4">
                        <label for="announcement_time">Time</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-clock"></i></span>
                            <input type="time" id="announcement_time" name="announcement_time" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-group col-md-4">
                        <label for="timezone">Timezone</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-globe"></i></span>
                            <select id="timezone" name="timezone" class="form-control" required>
                                <option value="Africa/Johannesburg">South Africa (SAST)</option>
                                <option value="UTC">UTC</option>
                                <option value="America/New_York">New York (EST)</option>
                                <option value="Europe/London">London (GMT)</option>
                                <option value="Asia/Dubai">Dubai (GST)</option>
                                <option value="Asia/Singapore">Singapore (SGT)</option>
                                <option value="Asia/Tokyo">Tokyo (JST)</option>
                                <option value="Australia/Sydney">Sydney (AEST)</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="image">Image (Optional)</label>
                    <div class="image-upload-container">
                        <div class="upload-area" onclick="document.getElementById('image').click()">
                            <input type="file" id="image" name="image" class="form-control" accept="image/*" onchange="previewImage(event)" hidden>
                            <div class="upload-placeholder">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <p>Click to upload or drag and drop</p>
                                <span>Supported formats: PNG, JPG, JPEG, GIF</span>
                            </div>
                            <div id="imagePreview" class="image-preview"></div>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label for="type">Type</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-tag"></i></span>
                            <select id="type" name="type" class="form-control" required>
                                <option value="info">Information</option>
                                <option value="important">Important</option>
                                <option value="event">Event</option>
                                <option value="update">Update</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group col-md-6">
                        <div class="checkbox-group">
                            <label class="checkbox-container">
                                <input type="checkbox" id="is_pinned" name="is_pinned">
                                <span class="checkmark"></span>
                                <span class="checkbox-label">
                                    <i class="fas fa-thumbtack"></i>
                                    Pin to Top
                                </span>
                            </label>
                            <label class="checkbox-container">
                                <input type="checkbox" id="send_email" name="send_email" checked>
                                <span class="checkmark"></span>
                                <span class="checkbox-label">
                                    <i class="fas fa-envelope"></i>
                                    Send Email to All Users
                                </span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Announcement
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
/* Dashboard Header */
.dashboard-header {
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 1.5rem;
}

.header-content h1 {
    font-size: 1.8rem;
    color: #333;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.header-content p {
    color: #666;
    margin: 0.5rem 0 0;
}

.quick-actions {
    display: flex;
    gap: 1rem;
    margin-top: 1rem;
    align-items: center;
}

/* Search and Filter */
.search-box {
    position: relative;
    flex: 1;
}

.search-box input {
    padding-left: 2.5rem;
    border-radius: 6px;
}

.search-box i {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: #666;
}

.filter-box {
    width: 200px;
}

/* Announcement Cards */
.announcements-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1.5rem;
    padding: 1rem;
}

.announcement-card {
    background: white;
    border-radius: 12px;
    padding: 0;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    overflow: hidden;
    position: relative;
}

.card-status {
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
}

.card-status.important { background: #dc2626; }
.card-status.info { background: #2563eb; }
.card-status.event { background: #16a34a; }
.card-status.update { background: #7c3aed; }

.announcement-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

/* Image Section */
.announcement-image {
    position: relative;
    width: 100%;
    height: 200px;
    overflow: hidden;
}

.announcement-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
}

.image-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.zoom-icon {
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
}

.announcement-image:hover .image-overlay {
    opacity: 1;
}

.announcement-image:hover img {
    transform: scale(1.05);
}

/* Header Section */
.announcement-header {
    padding: 1.5rem 1.5rem 0;
}

.header-main {
    flex: 1;
}

.header-main h3 {
    margin: 0 0 0.5rem;
    color: #333;
    font-size: 1.2rem;
}

/* Content Section */
.announcement-content {
    padding: 1rem 1.5rem;
    color: #555;
    line-height: 1.6;
}

/* Footer Section */
.announcement-footer {
    padding: 1rem 1.5rem;
    background: #f8f9fa;
    border-top: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

/* Type Badges */
.announcement-type {
    padding: 0.4rem 0.8rem;
    border-radius: 50px;
    font-size: 0.875rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 500;
}

.announcement-type.important {
    background: #fef2f2;
    color: #dc2626;
}

.announcement-type.info {
    background: #eff6ff;
    color: #2563eb;
}

.announcement-type.event {
    background: #f0fdf4;
    color: #16a34a;
}

.announcement-type.update {
    background: #faf5ff;
    color: #7c3aed;
}

/* Form Styling */
.input-group {
    position: relative;
    display: flex;
}

.input-group-text {
    padding: 0.5rem 1rem;
    background: #f8f9fa;
    border: 1px solid #ddd;
    border-right: none;
    border-radius: 4px 0 0 4px;
    color: #666;
}

.input-group .form-control {
    border-radius: 0 4px 4px 0;
}

/* Upload Area */
.upload-area {
    border: 2px dashed #ddd;
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.upload-area:hover {
    border-color: #2563eb;
    background: #f8fafc;
}

.upload-placeholder {
    color: #666;
}

.upload-placeholder i {
    font-size: 2rem;
    color: #2563eb;
    margin-bottom: 1rem;
}

.upload-placeholder p {
    margin: 0.5rem 0;
    font-size: 1rem;
}

.upload-placeholder span {
    font-size: 0.875rem;
    color: #888;
}

/* Checkbox Styling */
.checkbox-group {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin-top: 2rem;
}

.checkbox-container {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    cursor: pointer;
    user-select: none;
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #333;
}

.checkbox-label i {
    color: #666;
}

/* Animation */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.fade-in {
    animation: fadeIn 0.3s ease forwards;
}

/* Image Preview Modal */
.image-preview-content {
    padding: 0;
    background: none;
    box-shadow: none;
    max-width: 90vw;
    width: auto;
}

.image-preview-content img {
    max-width: 100%;
    max-height: 90vh;
    border-radius: 8px;
}

/* Responsive Design */
@media (max-width: 768px) {
    .quick-actions {
        flex-direction: column;
        align-items: stretch;
    }
    
    .search-box, .filter-box {
        width: 100%;
    }
    
    .announcements-grid {
        grid-template-columns: 1fr;
    }
    
    .form-row {
        flex-direction: column;
    }
    
    .modal-content {
        width: 95%;
        margin: 1rem;
    }
}
</style>

<script>
(function() {
    window.announcementsData = JSON.parse('{{ announcements|tojson|safe }}');
    window.currentAnnouncementId = null;

    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('announcementForm');
        form.addEventListener('submit', handleSubmit);

        // Set default date and time to now
        setDefaultDateTime();

        // Initialize animations
        const elements = document.querySelectorAll('.announcement-card');
        elements.forEach((element, index) => {
            element.style.animation = `fadeIn 0.3s ease forwards ${index * 0.1}s`;
            element.style.opacity = '0';
        });
    });
})();

function setDefaultDateTime() {
    const now = new Date();
    const dateInput = document.getElementById('announcement_date');
    const timeInput = document.getElementById('announcement_time');
    
    // Format date as YYYY-MM-DD
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    dateInput.value = `${year}-${month}-${day}`;
    
    // Format time as HH:MM
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    timeInput.value = `${hours}:${minutes}`;
}

function openNewAnnouncementModal() {
    window.currentAnnouncementId = null;
    document.getElementById('modalTitle').textContent = 'New Announcement';
    document.getElementById('announcementForm').reset();
    
    // Set default date and time
    setDefaultDateTime();
    
    // Set default timezone if not already selected
    const timezoneSelect = document.getElementById('timezone');
    if (!timezoneSelect.value) {
        timezoneSelect.value = 'Africa/Johannesburg'; // Default to SAST
    }
    
    document.getElementById('announcementModal').style.display = 'block';
}

function editAnnouncement(id) {
    window.currentAnnouncementId = id;
    const announcement = window.announcementsData[id];
    
    document.getElementById('modalTitle').textContent = 'Edit Announcement';
    document.getElementById('title').value = announcement.title;
    document.getElementById('content').value = announcement.content;
    document.getElementById('type').value = announcement.type;
    document.getElementById('is_pinned').checked = announcement.is_pinned;
    
    // Set date and time if they exist
    if (announcement.scheduled_date) {
        document.getElementById('announcement_date').value = announcement.scheduled_date;
    } else {
        setDefaultDateTime(); // Set current date/time if none exists
    }
    
    if (announcement.scheduled_time) {
        document.getElementById('announcement_time').value = announcement.scheduled_time;
    }
    
    if (announcement.timezone) {
        document.getElementById('timezone').value = announcement.timezone;
    } else {
        document.getElementById('timezone').value = 'Africa/Johannesburg'; // Default to SAST
    }
    
    document.getElementById('announcementModal').style.display = 'block';
}

function deleteAnnouncement(id) {
    if (confirm('Are you sure you want to delete this announcement?')) {
        fetch(`/admin/announcements/${id}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
        })
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.error || 'Error deleting announcement');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting announcement: ' + error.message);
        });
    }
}

function previewImage(event) {
    const preview = document.getElementById('imagePreview');
    const file = event.target.files[0];
    
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
        }
        reader.readAsDataURL(file);
    } else {
        preview.innerHTML = '';
    }
}

function formatDateTime(date, time, timezone) {
    try {
        const dateTimeStr = `${date}T${time}`;
        const dateObj = new Date(dateTimeStr);
        
        if (isNaN(dateObj.getTime())) {
            throw new Error('Invalid date/time');
        }
        
        const options = {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            timeZone: timezone
        };
        
        return new Intl.DateTimeFormat('en-US', options).format(dateObj);
    } catch (error) {
        console.error('Error formatting date/time:', error);
        return `${date} ${time} ${timezone}`;
    }
}

function handleSubmit(event) {
    event.preventDefault();
    
    // Validate date and time
    const dateInput = document.getElementById('announcement_date');
    const timeInput = document.getElementById('announcement_time');
    const timezoneSelect = document.getElementById('timezone');
    
    if (!dateInput.value || !timeInput.value || !timezoneSelect.value) {
        alert('Please set the date, time, and timezone for the announcement.');
        return;
    }
    
    const formData = new FormData(event.target);
    const url = window.currentAnnouncementId 
        ? `/admin/announcements/${window.currentAnnouncementId}`
        : '/admin/announcements';
    
    const method = window.currentAnnouncementId ? 'PUT' : 'POST';

    fetch(url, {
        method: method,
        body: formData
    })
    .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        return response.json();
    })
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.error || 'Error saving announcement');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving announcement: ' + error.message);
    });
}

function closeModal() {
    document.getElementById('announcementModal').style.display = 'none';
    window.currentAnnouncementId = null;
}

// Modal close functionality
document.querySelector('.close-modal').addEventListener('click', closeModal);

window.onclick = function(event) {
    const modal = document.getElementById('announcementModal');
    if (event.target == modal) {
        closeModal();
    }
}

// Add these new functions for search and filter
document.getElementById('searchAnnouncements').addEventListener('input', filterAnnouncements);
document.getElementById('filterType').addEventListener('change', filterAnnouncements);

function filterAnnouncements() {
    const searchTerm = document.getElementById('searchAnnouncements').value.toLowerCase();
    const filterType = document.getElementById('filterType').value;
    const cards = document.querySelectorAll('.announcement-card');
    
    cards.forEach(card => {
        const title = card.querySelector('h3').textContent.toLowerCase();
        const content = card.querySelector('.announcement-content').textContent.toLowerCase();
        const type = card.dataset.type;
        
        const matchesSearch = title.includes(searchTerm) || content.includes(searchTerm);
        const matchesType = filterType === 'all' || type === filterType;
        
        if (matchesSearch && matchesType) {
            card.style.display = 'block';
            card.style.animation = 'fadeIn 0.3s ease forwards';
        } else {
            card.style.display = 'none';
        }
    });
}

// Image preview modal functionality
document.querySelectorAll('.announcement-image').forEach(image => {
    image.addEventListener('click', function() {
        const imgSrc = this.querySelector('img').src;
        document.getElementById('previewImage').src = imgSrc;
        document.getElementById('imagePreviewModal').style.display = 'block';
    });
});

// Drag and drop functionality for image upload
const uploadArea = document.querySelector('.upload-area');

uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    const file = e.dataTransfer.files[0];
    if (file && file.type.startsWith('image/')) {
        document.getElementById('image').files = e.dataTransfer.files;
        previewImage({ target: { files: [file] } });
    }
});
</script>
{% endblock %} 